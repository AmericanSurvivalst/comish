<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-L99MVF0SXV"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-L99MVF0SXV');
</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comish | Know Your Paycheck Before It Hits</title>
    <meta name="description" content="Commission tracking for sales reps. See your exact commission on every deal, at every tier, in real time. Stop guessing what you're getting paid.">
    <meta name="keywords" content="commission tracker, sales commission calculator, commission tracking software, sales rep tools, tiered commission calculator">
    <meta name="author" content="Comish">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://comish.online/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://comish.online/">
    <meta property="og:title" content="Comish | Know Your Paycheck Before It Hits">
    <meta property="og:description" content="Commission tracking for sales reps. See your exact commission on every deal, at every tier, in real time.">
    <meta property="og:image" content="https://comish.online/og-image.png">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://comish.online/">
    <meta name="twitter:title" content="Comish | Know Your Paycheck Before It Hits">
    <meta name="twitter:description" content="Commission tracking for sales reps. See your exact commission on every deal, at every tier, in real time.">
    <meta name="twitter:image" content="https://comish.online/og-image.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    
    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00ff88">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Comish">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Comish",
      "applicationCategory": "BusinessApplication",
      "operatingSystem": "Web",
      "description": "Commission tracking for sales reps. See your exact commission on every deal, at every tier, in real time.",
      "offers": {
        "@type": "Offer",
        "price": "5.00",
        "priceCurrency": "USD",
        "priceValidUntil": "2026-12-31"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.9",
        "ratingCount": "127"
      }
    }
    </script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "How does the free trial work?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "You get full access for 14 days, no credit card required. Set up your comp plan, log some deals, and see your commission calculate in real time. If you love it, subscribe for $5/month. If not, no hard feelings."
          }
        },
        {
          "@type": "Question",
          "name": "Can it handle my comp plan?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Comish supports tiered commission structures with up to 4 tiers, different rates for 1-year vs 2-year contracts, and quarterly goals with attainment tracking. Works for AEs, Account Managers, and closers. We also have a separate mode for SDRs/BDRs with activity-based comp."
          }
        },
        {
          "@type": "Question",
          "name": "Is my data secure?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Yes. We use Supabase for authentication and database with enterprise-grade encryption. Your commission data is private and never shared. You can export or delete your data anytime."
          }
        },
        {
          "@type": "Question",
          "name": "Can I export my data?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Yes. Export your deals to CSV or generate a PDF report for any quarter. Great for tax records, performance reviews, or checking your employer's math."
          }
        },
        {
          "@type": "Question",
          "name": "What if I need help?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Email info@comish.online and I'll personally respond within 48 hours. Built by a sales rep, supported by a sales rep. No chatbots."
          }
        },
        {
          "@type": "Question",
          "name": "Why only $5/month?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Because sales reps shouldn't need to spend a fortune to know what they're getting paid. This is a tool I built for myself and want other reps to have access to. Keep it simple, keep it cheap."
          }
        }
      ]
    }
    </script>
    <style>
:root{--bg:#000;--bg2:#0a0a0a;--card:#0d0d0d;--card2:#161616;--border:#262626;--text:#fff;--text2:#a3a3a3;--muted:#666;--accent:#00ff88;--accent2:#00cc6a;--glow:rgba(0,255,136,0.12);--blue:#3b82f6;--purple:#a855f7;--pink:#ec4899;--orange:#f97316;--yellow:#facc15}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;overflow-x:hidden;background-image:radial-gradient(rgba(255,255,255,0.03) 1px,transparent 1px);background-size:40px 40px}
a{color:inherit;text-decoration:none}
.gradient-bg{position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 50% -20%,rgba(0,255,136,0.15),transparent),radial-gradient(ellipse 60% 40% at 100% 0%,rgba(59,130,246,0.1),transparent);pointer-events:none;z-index:0}
.glow-1{position:absolute;width:600px;height:600px;background:radial-gradient(circle,rgba(0,255,136,0.12),transparent 70%);border-radius:50%;pointer-events:none;z-index:0}
.glow-2{position:absolute;width:500px;height:500px;background:radial-gradient(circle,rgba(59,130,246,0.1),transparent 70%);border-radius:50%;pointer-events:none;z-index:0}
.glow-3{position:absolute;width:400px;height:400px;background:radial-gradient(circle,rgba(168,85,247,0.1),transparent 70%);border-radius:50%;pointer-events:none;z-index:0}
nav{position:fixed;top:0;left:0;right:0;z-index:100;padding:1rem 2rem;background:rgba(0,0,0,0.8);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.05)}
nav .container{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
.logo{font-size:1.5rem;font-weight:900;letter-spacing:-0.03em}
.logo span{color:var(--accent)}
nav .links{display:flex;gap:2.5rem;align-items:center}
nav .links a{color:var(--text);font-size:0.9rem;font-weight:500;transition:color 0.2s}
nav .links a:hover{color:var(--accent)}
.mobile-toggle{display:none;background:none;border:none;color:var(--text);font-size:1.5rem;cursor:pointer}
.mobile-close{display:none;position:absolute;top:1rem;right:1rem;background:none;border:none;color:var(--text);font-size:1.5rem;cursor:pointer}
@media(max-width:768px){
nav .links{position:fixed;top:0;right:-100%;width:280px;height:100vh;background:var(--card);flex-direction:column;justify-content:flex-start;padding:5rem 2rem 2rem;gap:1.5rem;transition:right 0.3s;border-left:1px solid var(--border)}
nav .links.open{right:0}
nav .links a{font-size:1.1rem}
nav .links .btn{width:100%}
.mobile-toggle{display:block}
.mobile-close{display:block}
}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:0.875rem 1.75rem;border-radius:100px;font-weight:600;font-size:0.95rem;cursor:pointer;border:none;transition:all 0.3s;font-family:inherit}
.btn-primary{background:var(--accent);color:#000;box-shadow:0 0 30px rgba(0,255,136,0.3)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 0 50px rgba(0,255,136,0.5)}
.btn-secondary{background:rgba(255,255,255,0.05);color:var(--text);border:1px solid rgba(255,255,255,0.1)}
.btn-secondary:hover{background:rgba(255,255,255,0.1)}
.dropdown-item:hover{background:rgba(0,255,136,0.1)}
.sortable{cursor:pointer;user-select:none;transition:background 0.2s}.sortable:hover{background:rgba(255,255,255,0.05)}
.sort-arrow{font-size:0.7rem;margin-left:4px;opacity:0.5}.sort-arrow.asc::after{content:'‚ñ≤'}.sort-arrow.desc::after{content:'‚ñº'}
.btn-ghost{background:transparent;color:var(--text2);padding:0.5rem 1rem}
.btn-ghost:hover{color:var(--text)}
.btn-lg{padding:1.125rem 2.5rem;font-size:1rem}
.hero{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:8rem 2rem 4rem;position:relative;z-index:1}
.hero-content{max-width:900px;text-align:center}
.hero-badge{display:inline-flex;align-items:center;gap:0.5rem;background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.2);color:var(--accent);padding:0.625rem 1.25rem;border-radius:100px;font-size:0.875rem;font-weight:600;margin-bottom:2rem;animation:pulse 3s ease-in-out infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 20px rgba(0,255,136,0.2)}50%{box-shadow:0 0 40px rgba(0,255,136,0.4)}}
.hero h1{font-size:clamp(3rem,8vw,5.5rem);font-weight:900;line-height:1.05;letter-spacing:-0.03em;margin-bottom:1.5rem}
.hero h1 .gradient{background:linear-gradient(135deg,var(--accent) 0%,#00ffcc 50%,var(--blue) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero-sub{font-size:1.35rem;color:var(--text2);margin-bottom:2.5rem;max-width:650px;margin-left:auto;margin-right:auto;line-height:1.7}
.hero-buttons{display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;margin-bottom:3rem}
.social-proof{display:flex;align-items:center;justify-content:center;gap:1rem}
.proof-avatars{display:flex}
.avatar{width:40px;height:40px;border:2px solid var(--bg);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.85rem;font-weight:700;margin-left:-12px;color:#fff}
.avatar:first-child{margin-left:0}
.avatar:nth-child(1){background:linear-gradient(135deg,#3b82f6,#1d4ed8)}
.avatar:nth-child(2){background:linear-gradient(135deg,#a855f7,#7c3aed)}
.avatar:nth-child(3){background:linear-gradient(135deg,#ec4899,#db2777)}
.avatar:nth-child(4){background:linear-gradient(135deg,#f97316,#ea580c)}
.social-proof p{color:var(--text2);font-size:0.95rem}
.social-proof strong{color:var(--text)}
.section{padding:8rem 2rem;position:relative;z-index:1;overflow:hidden}
.section::before{content:'';position:absolute;inset:0;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.3),transparent);pointer-events:none}
.section:nth-child(odd){background:linear-gradient(180deg,var(--bg),var(--bg2),var(--bg))}
.section:nth-child(even){background:var(--bg)}
.section .container{max-width:1100px;margin:0 auto}
.section-label{text-align:center;color:var(--accent);font-size:0.85rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:1rem}
.section-title{text-align:center;font-size:clamp(2rem,5vw,3rem);font-weight:800;letter-spacing:-0.02em;margin-bottom:1rem}
.section-sub{text-align:center;color:var(--text2);font-size:1.2rem;margin-bottom:4rem}
.demo-window{background:var(--card);border:1px solid var(--border);border-radius:20px;overflow:hidden;box-shadow:0 20px 50px -10px rgba(0,0,0,0.5),0 0 100px rgba(0,255,136,0.1)}
.demo-header{background:linear-gradient(180deg,var(--card2),var(--card));padding:1rem 1.5rem;display:flex;align-items:center;gap:1rem;border-bottom:1px solid var(--border)}
.demo-dots{display:flex;gap:8px}
.demo-dots span{width:14px;height:14px;border-radius:50%}
.demo-dots span:nth-child(1){background:#ff5f57}
.demo-dots span:nth-child(2){background:#febc2e}
.demo-dots span:nth-child(3){background:#28c840}
.demo-content{padding:2rem}
.demo-grid{display:grid;grid-template-columns:1fr 1fr;gap:2rem}
@media(max-width:768px){.demo-grid{grid-template-columns:1fr}}
.demo-hero-stat{background:linear-gradient(135deg,rgba(0,255,136,0.1),rgba(0,255,136,0.02));border:1px solid rgba(0,255,136,0.2);border-radius:16px;padding:1.5rem;text-align:center;margin-bottom:1.5rem}
.demo-hero-stat .label{color:var(--accent);font-size:0.75rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em}
.demo-hero-stat .value{font-size:clamp(2rem,5vw,3rem);font-weight:900;color:var(--accent);text-shadow:0 0 40px rgba(0,255,136,0.5)}
.demo-hero-stat .sub{color:var(--text2);font-size:0.9rem}
.demo-stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
@media(max-width:500px){.demo-stats-row{grid-template-columns:1fr}}
.demo-stat{background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:1rem;text-align:center}
.demo-stat .label{color:var(--muted);font-size:0.7rem;text-transform:uppercase}
.demo-stat .value{font-size:1.25rem;font-weight:700;margin-top:0.25rem}
.demo-stat .value.green{color:var(--accent)}.demo-stat .value.yellow{color:var(--yellow)}.demo-stat .value.blue{color:var(--blue)}
.demo-tiers{display:flex;flex-direction:column;gap:0.5rem}
.demo-tier{display:flex;align-items:center;padding:0.875rem 1rem;background:var(--card2);border:1px solid var(--border);border-radius:10px}
.demo-tier.active{background:rgba(0,255,136,0.08);border-color:rgba(0,255,136,0.3)}
.demo-tier.active .tier-comm{color:var(--accent)}
.tier-dot{width:10px;height:10px;border-radius:4px;margin-right:0.875rem;flex-shrink:0}
.tier-dot.t1{background:var(--blue)}.tier-dot.t2{background:var(--purple)}.tier-dot.t3{background:var(--pink)}.tier-dot.t4{background:var(--orange)}
.tier-info{flex:1;min-width:0}
.tier-name{font-weight:600;font-size:0.85rem}
.tier-range{font-size:0.75rem;color:var(--muted)}
.tier-comm{font-size:0.95rem;font-weight:700;color:var(--text2);flex-shrink:0}
.pain-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem}
@media(max-width:768px){.pain-grid{grid-template-columns:1fr}}
.pain-card{background:var(--card);border:1px solid rgba(0,255,136,0.1);border-radius:20px;padding:2rem;text-align:center;transition:all 0.3s;box-shadow:0 0 25px rgba(0,255,136,0.05),inset 0 0 20px rgba(0,255,136,0.02)}
.pain-card:hover{border-color:var(--accent);transform:translateY(-6px);box-shadow:0 0 40px rgba(0,255,136,0.2),inset 0 0 30px rgba(0,255,136,0.05)}
.pain-icon{font-size:3rem;margin-bottom:1rem}
.pain-card p{color:var(--text2);font-size:1.05rem;line-height:1.6}
.features-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem}
@media(max-width:900px){.features-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){.features-grid{grid-template-columns:1fr}}
.integrations-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1.5rem}
@media(max-width:900px){.integrations-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:500px){.integrations-grid{grid-template-columns:1fr}}
.integration-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.5rem;text-align:center;transition:all 0.3s}
.integration-card:hover{border-color:rgba(0,255,136,0.3);transform:translateY(-2px)}
.integration-icon{font-size:2rem;margin-bottom:1rem}
.integration-card h3{font-size:1rem;font-weight:600;margin-bottom:0.5rem}
.integration-card p{color:var(--text2);font-size:0.85rem;line-height:1.5}
.feature-card{background:linear-gradient(180deg,var(--card2),var(--card));border:1px solid rgba(0,255,136,0.1);border-radius:20px;padding:2rem;transition:all 0.3s;box-shadow:0 0 25px rgba(0,255,136,0.05),inset 0 0 20px rgba(0,255,136,0.02)}
.feature-card:hover{border-color:var(--accent);transform:translateY(-6px);box-shadow:0 0 40px rgba(0,255,136,0.2),inset 0 0 30px rgba(0,255,136,0.05)}
.feature-icon{width:56px;height:56px;background:var(--glow);border:1px solid rgba(0,255,136,0.2);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;margin-bottom:1.25rem}
.feature-card h3{font-size:1.2rem;font-weight:700;margin-bottom:0.5rem}
.feature-card p{color:var(--text2);font-size:0.95rem;line-height:1.6}
.steps{display:flex;flex-direction:column;gap:2rem}
.step{display:flex;gap:2rem;align-items:flex-start;background:var(--card);border:1px solid rgba(0,255,136,0.1);border-radius:20px;padding:2rem;transition:all 0.3s;box-shadow:0 0 25px rgba(0,255,136,0.05),inset 0 0 20px rgba(0,255,136,0.02)}
.step:hover{border-color:var(--accent);transform:translateY(-6px);box-shadow:0 0 40px rgba(0,255,136,0.2),inset 0 0 30px rgba(0,255,136,0.05)}
.step:hover{border-color:var(--accent)}
.step-num{width:56px;height:56px;background:var(--accent);color:#000;border-radius:16px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1.5rem;flex-shrink:0}
.step-content h3{font-size:1.25rem;font-weight:700;margin-bottom:0.5rem}
.step-content p{color:var(--text2);font-size:1rem;line-height:1.6}
@media(max-width:600px){.step{flex-direction:column;align-items:center;text-align:center}}
.story-section{background:linear-gradient(180deg,var(--bg2),var(--bg));position:relative;overflow:hidden}
.story-section::before{content:'';position:absolute;inset:0;background-image:linear-gradient(rgba(0,255,136,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,255,136,0.03) 1px,transparent 1px);background-size:60px 60px;pointer-events:none}
.story-content{max-width:700px;margin:0 auto;text-align:center}
.story-content p{color:var(--text2);font-size:1.1rem;line-height:1.8;margin-bottom:1.5rem}
.story-content .signature{color:var(--text);font-weight:600;margin-top:2rem}
.faq-grid{display:grid;gap:1rem;max-width:800px;margin:0 auto}
.faq-item{background:var(--card);border:1px solid rgba(0,255,136,0.1);border-radius:16px;overflow:hidden;transition:all 0.3s;box-shadow:0 0 25px rgba(0,255,136,0.05),inset 0 0 20px rgba(0,255,136,0.02)}
.faq-item:hover{border-color:rgba(0,255,136,0.3);box-shadow:0 0 30px rgba(0,255,136,0.1),inset 0 0 25px rgba(0,255,136,0.03)}
.faq-item.open{border-color:var(--accent);box-shadow:0 0 40px rgba(0,255,136,0.2),inset 0 0 30px rgba(0,255,136,0.05)}
.faq-q{padding:1.5rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:1.05rem}
.faq-q:hover{background:var(--card2)}
.faq-q span{transition:transform 0.3s;color:var(--accent)}
.faq-item.open .faq-q span{transform:rotate(45deg)}
.faq-a{max-height:0;overflow:hidden;transition:max-height 0.3s,padding 0.3s}
.faq-item.open .faq-a{max-height:500px;padding:0 1.5rem 1.5rem}
.faq-a p{color:var(--text2);line-height:1.7}
.pricing-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:2rem;max-width:900px;margin:0 auto}
@media(max-width:700px){.pricing-grid{grid-template-columns:1fr}}
.price-card{background:var(--card);border:1px solid rgba(0,255,136,0.1);border-radius:24px;padding:2.5rem;position:relative;transition:all 0.3s;box-shadow:0 0 25px rgba(0,255,136,0.05),inset 0 0 20px rgba(0,255,136,0.02)}
.price-card:hover{border-color:rgba(0,255,136,0.3);transform:translateY(-4px);box-shadow:0 0 35px rgba(0,255,136,0.15),inset 0 0 25px rgba(0,255,136,0.03)}
.price-card.featured{border-color:var(--accent);box-shadow:0 0 60px rgba(0,255,136,0.2),inset 0 0 30px rgba(0,255,136,0.05)}
.price-badge{position:absolute;top:-14px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--accent),var(--blue));color:#000;padding:0.5rem 1.25rem;border-radius:100px;font-size:0.8rem;font-weight:700}
.price-name{font-size:1.25rem;font-weight:600;margin-bottom:1rem;color:var(--text2)}
.price-amount{font-size:4rem;font-weight:900;letter-spacing:-0.03em;line-height:1}
.price-amount span{font-size:1.25rem;color:var(--muted);font-weight:500}
.price-period{color:var(--muted);font-size:0.9rem;margin-bottom:2rem}
.price-features{margin:0 0 2rem 0;padding:0;list-style:none}
.price-features li{display:flex;align-items:center;gap:0.875rem;padding:0.625rem 0;color:var(--text2);font-size:0.95rem}
.price-features li::before{content:'‚úì';color:var(--accent);font-weight:700}
.price-card .btn{width:100%}
.cta-section{padding:10rem 2rem;position:relative;z-index:1;text-align:center}
.cta-section::before{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:600px;height:600px;background:radial-gradient(circle,rgba(0,255,136,0.15),transparent 70%);pointer-events:none}
.cta-content{max-width:700px;margin:0 auto;position:relative}
.cta-content h2{font-size:clamp(2.5rem,5vw,3.5rem);font-weight:900;letter-spacing:-0.03em;margin-bottom:1.5rem;line-height:1.1}
.cta-content p{color:var(--text2);font-size:1.25rem;margin-bottom:2.5rem}
.cta-note{margin-top:1.5rem;color:var(--muted);font-size:0.9rem}
footer{padding:4rem 2rem 2rem;border-top:1px solid var(--border);position:relative;z-index:1}
.footer-content{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:2fr 1fr 1fr;gap:3rem}
@media(max-width:768px){.footer-content{grid-template-columns:1fr;text-align:center}}
.footer-brand .logo{margin-bottom:1rem}
.footer-brand p{color:#fff;font-size:0.9rem;max-width:300px}
@media(max-width:768px){.footer-brand p{max-width:100%}}
.footer-links h4{font-size:0.85rem;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:1rem;color:var(--accent)}
.footer-links a{display:block;color:var(--text);font-size:0.9rem;padding:0.375rem 0;transition:color 0.2s;text-decoration:none}
.footer-links a:hover{color:var(--accent)}
.footer-bottom{max-width:1100px;margin:3rem auto 0;padding-top:2rem;border-top:1px solid var(--border);text-align:center;color:#fff;font-size:0.85rem}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);backdrop-filter:blur(10px);z-index:200;align-items:center;justify-content:center;padding:1rem;overflow-y:auto}
.modal-overlay.active{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:24px;width:100%;max-width:420px;max-height:90vh;overflow:hidden;box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);display:flex;flex-direction:column}
.modal-header{padding:1.5rem 2rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.modal-header h2{font-size:1.25rem;font-weight:700}
.modal-close{background:none;border:none;color:var(--muted);font-size:1.5rem;cursor:pointer}
.modal-close:hover{color:var(--text)}
.modal-body{padding:2rem;overflow-y:auto;flex:1}
.form-group{margin-bottom:1.25rem}
.form-label{display:block;font-size:0.9rem;color:var(--text2);margin-bottom:0.5rem;font-weight:500}
.form-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:0.875rem 1rem;color:var(--text);font-size:1rem;font-family:inherit}
.form-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,255,136,0.1)}
.form-error{color:#ef4444;font-size:0.85rem;margin-top:0.5rem;display:none}
.form-error.show{display:block}
.auth-switch{text-align:center;margin-top:1.5rem;color:var(--text2);font-size:0.9rem}
.auth-switch a{color:var(--accent);cursor:pointer;font-weight:500}
#app{display:none}
#landing{display:block}
.hidden{display:none!important}
.onboarding{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem;position:relative;z-index:1}
.onboard-card{background:var(--card);border:1px solid var(--border);border-radius:24px;width:100%;max-width:500px;overflow:hidden}
.onboard-header{padding:2rem;border-bottom:1px solid var(--border)}
.onboard-header h2{font-size:1.5rem;font-weight:700;margin-bottom:0.25rem}
.onboard-header p{color:var(--text2)}
.onboard-progress{display:flex;gap:0.5rem;margin-top:1.5rem}
.onboard-progress .step{flex:1;height:4px;background:var(--border);border-radius:2px}
.onboard-progress .step.active,.onboard-progress .step.done{background:var(--accent)}
.onboard-body{padding:2rem}
.onboard-footer{padding:1.5rem 2rem;border-top:1px solid var(--border);display:flex;justify-content:space-between}
.rate-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem}
.rate-grid .form-input{text-align:center;padding:0.75rem 0.5rem}
.rate-label{font-size:0.7rem;color:var(--muted);text-align:center;margin-bottom:0.375rem;text-transform:uppercase}
.dashboard{min-height:100vh;background:var(--bg);position:relative;z-index:1}
.dash-nav{padding:1rem 2rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,0.8);backdrop-filter:blur(20px);position:sticky;top:0;z-index:50}
.dash-nav .btn-ghost{color:var(--text)}
.dash-nav .btn-ghost:hover{color:var(--accent)}
.user-menu{display:flex;align-items:center;gap:1rem}
.user-email{color:var(--text);font-size:0.85rem}
@media(max-width:600px){.user-email{display:none}}
.dash-container{max-width:1800px;margin:0 auto;padding:2rem}
@media(max-width:600px){.dash-container{padding:1rem}}
.quick-entry{background:linear-gradient(135deg,var(--card),rgba(0,255,136,0.05));border:1px solid rgba(0,255,136,0.2);border-radius:16px;padding:1.5rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:2rem;flex-wrap:wrap}
.quick-entry label{font-size:0.9rem;color:var(--text2)}
.quick-entry input{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:0.75rem;color:var(--text);font-size:1.25rem;width:180px}
.quick-entry input:focus{outline:none;border-color:var(--accent)}
.quick-entry .hint{font-size:0.75rem;color:var(--muted);margin-top:0.25rem}
.stats{display:grid;grid-template-columns:repeat(5,1fr);gap:1rem;margin-bottom:1.5rem}
@media(max-width:1200px){.stats{grid-template-columns:repeat(3,1fr)}}
@media(max-width:768px){.stats{grid-template-columns:repeat(2,1fr)}}
@media(max-width:480px){.stats{grid-template-columns:1fr}}
.stat{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.25rem}
.stat.hl{border-color:var(--accent);background:linear-gradient(135deg,var(--card),rgba(0,255,136,0.08))}
.stat-label{font-size:0.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.375rem}
.stat-value{font-size:1.375rem;font-weight:700}
.stat-sub{font-size:0.75rem;color:var(--text2);margin-top:0.25rem}
.green{color:var(--accent)}.yellow{color:var(--yellow)}.blue{color:var(--blue)}.purple{color:var(--purple)}
.progress-section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.5rem;margin-bottom:1.5rem}
.progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem}
.progress-title{font-weight:600}
.progress-stats{display:flex;gap:2rem;font-size:0.9rem;color:var(--text2)}
.progress-stats strong{color:var(--text)}
.progress-bar-wrap{height:24px;background:var(--bg);border-radius:12px;overflow:hidden;margin-bottom:0.75rem}
.progress-bar{height:100%;background:linear-gradient(90deg,var(--blue),var(--purple),var(--pink),var(--orange));border-radius:12px;transition:width 0.5s}
.progress-labels{display:flex;justify-content:space-between;font-size:0.7rem;color:var(--muted)}
.main-grid{display:grid;grid-template-columns:1fr 400px;gap:1.5rem}
@media(max-width:1100px){.main-grid{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
.card-header{display:flex;justify-content:space-between;align-items:center;padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:0.5rem}
@media(max-width:600px){.card-header{flex-direction:column;align-items:stretch}.card-header>div{width:100%}.card-header select{flex:1;min-width:0}}
.card-title{font-weight:600}
.table-wrap{border:1px solid var(--border);border-radius:8px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.table-wrap table{font-size:0.85rem;min-width:700px}.table-wrap th,.table-wrap td{padding:0.5rem 0.75rem;white-space:nowrap}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:0.75rem 1rem;font-size:0.7rem;color:var(--muted);text-transform:uppercase;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--card)}
td{padding:0.875rem 1rem;border-bottom:1px solid var(--border);font-size:0.9rem}
tr:hover{background:var(--bg2)}
.badge{display:inline-flex;padding:0.25rem 0.625rem;border-radius:100px;font-size:0.75rem;font-weight:600}
.badge.y1{background:rgba(59,130,246,0.15);color:var(--blue)}
.badge.y2{background:rgba(168,85,247,0.15);color:var(--purple)}
.badge.paid{background:rgba(0,255,136,0.15);color:var(--accent)}
.badge.unpaid{background:rgba(250,204,21,0.15);color:var(--yellow)}
.deal-actions button{background:none;border:none;color:var(--muted);cursor:pointer;padding:0.375rem;font-size:1rem;border-radius:6px}
.deal-actions button:hover{color:var(--text);background:var(--bg2)}
.deal-actions{display:flex;gap:0.25rem;position:sticky;right:0;background:var(--card)}
.sidebar-cards{display:flex;flex-direction:column;gap:1.25rem}
.side-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.25rem}
.side-title{font-weight:600;margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:1px solid var(--border)}
.tier-row{display:flex;align-items:center;padding:0.75rem;border-radius:10px;margin-bottom:0.375rem;background:var(--bg)}
.tier-row.active{background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.2)}
.tier-color{width:10px;height:10px;border-radius:4px;margin-right:0.75rem}
.tier-info{flex:1}
.tier-name{font-weight:600;font-size:0.85rem}
.tier-range{font-size:0.75rem;color:var(--muted)}
.tier-amounts{text-align:right}
.tier-rev{font-size:0.75rem;color:var(--text2)}
.tier-comm{font-size:1rem;font-weight:700;color:var(--accent)}
.comm-summary{background:var(--bg);border-radius:12px;padding:1rem;margin-top:1rem}
.comm-row{display:flex;justify-content:space-between;padding:0.375rem 0;font-size:0.9rem}
.comm-row.month-row:hover{background:rgba(0,255,136,0.1)!important}
.comm-row.total{border-top:1px solid var(--border);margin-top:0.75rem;padding-top:0.75rem;font-weight:600}
.comm-row.total .comm-value{color:var(--accent);font-size:1.1rem}
.comm-label{color:var(--text2)}
.comm-value{font-weight:600}
.empty{text-align:center;padding:4rem 2rem;color:var(--muted)}
.view-toggle{display:flex;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:4px;margin-right:auto}
.view-toggle button{padding:0.5rem 1rem;border:none;background:none;color:var(--muted);font-size:0.85rem;font-weight:500;cursor:pointer;border-radius:6px;transition:all 0.2s}
.view-toggle button.active{background:var(--accent);color:#000}
.monthly-section{margin-top:1.5rem}
.monthly-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
.monthly-title{font-weight:600;font-size:1.1rem}
.monthly-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem}
@media(max-width:1200px){.monthly-grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:900px){.monthly-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){.monthly-grid{grid-template-columns:1fr}}
.month-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.25rem;transition:all 0.2s}
.month-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,255,136,0.1)}
.month-card.current{border-color:var(--accent);background:linear-gradient(135deg,var(--card),rgba(0,255,136,0.05))}
.month-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem}
.month-name{font-weight:600;font-size:0.95rem}
.month-badge{font-size:0.7rem;padding:0.2rem 0.5rem;border-radius:20px;background:rgba(0,255,136,0.15);color:var(--accent)}
.month-stat{display:flex;justify-content:space-between;padding:0.35rem 0;font-size:0.85rem}
.month-stat-label{color:var(--muted)}
.month-stat-value{font-weight:600}
.chart-section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.5rem;margin-top:1.5rem}
.chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
.chart-title{font-weight:600}
.chart-legend{display:flex;gap:1.5rem;font-size:0.8rem}
.chart-legend-item{display:flex;align-items:center;gap:0.4rem;color:var(--text2)}
.chart-legend-dot{width:10px;height:10px;border-radius:3px}
.bar-chart{display:flex;align-items:flex-end;justify-content:space-between;height:200px;gap:0.5rem;padding:0 0.5rem}
.bar-group{flex:1;display:flex;flex-direction:column;align-items:center;gap:0.5rem;max-width:80px;transition:transform 0.2s}
.bar-group:hover{transform:scale(1.05)}
.bar-group:hover .bar-label{color:var(--accent)}
.bar-container{width:100%;height:180px;display:flex;align-items:flex-end;justify-content:center;gap:4px}
.bar{width:45%;border-radius:4px 4px 0 0;transition:height 0.3s;min-height:2px;cursor:pointer;position:relative}
.bar:hover{opacity:0.8}
.bar.revenue{background:linear-gradient(180deg,var(--blue),var(--purple))}
.bar.commission{background:linear-gradient(180deg,var(--accent),var(--accent2))}
.bar-label{font-size:0.7rem;color:var(--muted);text-align:center}
.bar-tooltip{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:0.5rem 0.75rem;font-size:0.75rem;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity 0.2s;z-index:10}
.bar:hover .bar-tooltip{opacity:1}
.yearly-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-top:1.5rem}
@media(max-width:900px){.yearly-summary{grid-template-columns:repeat(2,1fr)}}
@media(max-width:500px){.yearly-summary{grid-template-columns:1fr}}
.yearly-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.25rem;text-align:center}
.yearly-card.highlight{border-color:var(--accent);background:linear-gradient(135deg,var(--card),rgba(0,255,136,0.08))}
.yearly-card-label{font-size:0.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem}
.yearly-card-value{font-size:1.5rem;font-weight:700}
.yearly-card-sub{font-size:0.8rem;color:var(--text2);margin-top:0.25rem}
.quarter-compare{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-top:1.5rem}
@media(max-width:900px){.quarter-compare{grid-template-columns:repeat(2,1fr)}}
.quarter-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.25rem;text-align:center;transition:all 0.2s}
.quarter-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,255,136,0.1)}
.quarter-card.active{border-color:var(--accent)}
.quarter-name{font-size:0.85rem;color:var(--muted);margin-bottom:0.5rem}
.quarter-revenue{font-size:1.25rem;font-weight:700;margin-bottom:0.25rem}
.quarter-commission{font-size:0.9rem;color:var(--accent)}
.quarter-deals{font-size:0.75rem;color:var(--muted);margin-top:0.5rem}
.profile-page{min-height:100vh;background:var(--bg);position:relative;z-index:1}
.profile-container{max-width:700px;margin:0 auto;padding:2rem}
.profile-header{margin-bottom:2rem}
.profile-header h1{font-size:1.75rem;font-weight:700;margin-bottom:0.25rem}
.profile-header p{color:var(--text2)}
.profile-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.5rem;margin-bottom:1.5rem}
.profile-card-title{font-weight:600;margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.profile-row{display:flex;justify-content:space-between;align-items:center;padding:0.75rem 0;border-bottom:1px solid var(--border)}
.profile-row:last-child{border-bottom:none}
.profile-row-label{color:var(--text2);font-size:0.9rem}
.profile-row-value{font-weight:500}
.subscription-badge{display:inline-flex;align-items:center;gap:0.5rem;padding:0.375rem 0.75rem;border-radius:20px;font-size:0.85rem;font-weight:600}
.subscription-badge.trial{background:rgba(250,204,21,0.15);color:var(--yellow)}
.subscription-badge.active{background:rgba(0,255,136,0.15);color:var(--accent)}
.subscription-badge.expired{background:rgba(239,68,68,0.15);color:#ef4444}
.trial-banner{background:linear-gradient(135deg,rgba(250,204,21,0.1),rgba(250,204,21,0.05));border:1px solid rgba(250,204,21,0.3);border-radius:12px;padding:1.25rem;margin-bottom:1.5rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
.trial-banner-text{display:flex;align-items:center;gap:0.75rem}
.trial-banner-text span{font-size:1.5rem}
.trial-banner-info strong{display:block;color:var(--yellow)}
.trial-banner-info p{font-size:0.85rem;color:var(--text2)}
.danger-zone{border-color:rgba(239,68,68,0.3)}
.danger-zone .profile-card-title{color:#ef4444}
.btn-danger{background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid rgba(239,68,68,0.3)}
.btn-danger:hover{background:rgba(239,68,68,0.25)}
.trial-expired-modal{position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:9999;display:flex;align-items:center;justify-content:center;padding:2rem}
.trial-expired-content{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:3rem;max-width:450px;text-align:center}
.trial-expired-content h2{font-size:1.75rem;margin-bottom:0.5rem}
.trial-expired-content .subtitle{color:var(--text2);margin-bottom:2rem}
.trial-expired-content .price{font-size:3rem;font-weight:900;color:var(--accent);margin-bottom:0.5rem}
.trial-expired-content .price span{font-size:1rem;font-weight:500;color:var(--text2)}
.trial-expired-content .perks{text-align:left;margin:1.5rem 0;padding:1.5rem;background:var(--card2);border-radius:12px}
.trial-expired-content .perk{display:flex;align-items:center;gap:0.75rem;padding:0.5rem 0;color:var(--text2);font-size:0.95rem}
.trial-expired-content .perk span{color:var(--accent)}
.trial-expired-content .btn{width:100%;margin-top:0.5rem}
.feedback-btn{position:fixed;bottom:2rem;right:2rem;background:var(--card);border:1px solid var(--border);border-radius:50px;padding:0.75rem 1.25rem;font-size:0.85rem;font-weight:600;cursor:pointer;color:var(--text);display:flex;align-items:center;gap:0.5rem;transition:all 0.2s;z-index:50;font-family:inherit}
.feedback-btn:hover{border-color:var(--accent);background:var(--card2)}
.feedback-modal .modal{max-width:500px}
.feedback-type{display:flex;gap:0.5rem;margin-bottom:1rem}
.feedback-type button{flex:1;padding:0.75rem;border:1px solid var(--border);background:var(--card);color:var(--text2);border-radius:8px;cursor:pointer;font-size:0.85rem;transition:all 0.2s;font-family:inherit}
.feedback-type button.active{border-color:var(--accent);background:rgba(0,255,136,0.1);color:var(--accent)}
.feedback-type button:hover{border-color:var(--accent)}
.deal-modal .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
@media(max-width:500px){.deal-modal .form-row{grid-template-columns:1fr}}
.toggle-group{display:flex;background:var(--bg);border-radius:10px;padding:4px}
.toggle-opt{flex:1;padding:0.625rem;text-align:center;font-size:0.9rem;font-weight:500;cursor:pointer;border-radius:8px;color:var(--muted);transition:all 0.2s}
.toggle-opt.active{background:var(--card2);color:var(--text)}
.toggle-opt.y1.active{color:var(--blue)}
.toggle-opt.y2.active{color:var(--purple)}
.toast-wrap{position:fixed;bottom:2rem;right:2rem;z-index:300}
@media(max-width:600px){.toast-wrap{bottom:1rem;right:1rem;left:1rem}}
.toast{background:var(--card);border:1px solid var(--accent);border-radius:12px;padding:1rem 1.5rem;font-size:0.9rem;box-shadow:0 10px 40px rgba(0,0,0,0.3);animation:slideIn 0.3s}
@keyframes slideIn{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}
</style>
</head>
<body>
<div class="gradient-bg"></div>
<div id="landing">
<nav>
<div class="container">
<a href="/" style="text-decoration:none"><div class="logo">Com<span>ish</span></div></a>
<button class="mobile-toggle" onclick="toggleMobileNav()">‚ò∞</button>
<div class="links" id="navLinks">
<button class="mobile-close" onclick="toggleMobileNav()">‚úï</button>
<a href="#features">Features</a>
<a href="#faq">FAQ</a>
<a href="#pricing">Pricing</a>
<a href="/blog/">Blog</a>
<button class="btn btn-ghost" style="color:#fff" onclick="showAuth('login');closeMobileNav()">Log in</button>
<button class="btn btn-primary" onclick="showAuth('signup');closeMobileNav()">Start Free</button>
</div>
</div>
</nav>
<section class="hero"><div class="hero-content">
<div class="hero-badge">‚ö° 2 minute setup. 14 days free. No card required.</div>
<h1>Know your paycheck<br><span class="gradient">before it hits.</span></h1>
<p class="hero-sub">Stop waiting until month end to find out what you made. See your exact commission on every deal, at every tier, in real time.</p>
<div class="hero-buttons"><button class="btn btn-primary btn-lg" onclick="showAuth('signup')">Start Tracking Free</button><button class="btn btn-secondary btn-lg" onclick="document.getElementById('demo').scrollIntoView({behavior:'smooth'})">See It In Action</button></div>
<div class="social-proof"><p>üöÄ Built by a sales rep, for sales reps</p></div>
</div></section>
<section class="section" id="demo"><div class="glow-1" style="top:-200px;right:-200px"></div><div class="glow-2" style="bottom:-150px;left:-150px"></div><div class="container">
<div class="section-label">See It In Action</div>
<h2 class="section-title">Your commission, crystal clear</h2>
<div class="demo-window"><div class="demo-header"><div class="demo-dots"><span></span><span></span><span></span></div><span style="flex:1;text-align:center;color:var(--muted);font-size:0.85rem">comish.online/dashboard</span><div style="width:60px"></div></div>
<div class="demo-content"><div class="demo-grid">
<div><div class="demo-hero-stat"><div class="label">Total Commission This Quarter</div><div class="value">$34,125</div><div class="sub">122% attainment at Tier 3 rates</div></div>
<div class="demo-stats-row"><div class="demo-stat"><div class="label">Revenue</div><div class="value">$456K</div></div><div class="demo-stat"><div class="label">To Tier 4</div><div class="value yellow">$106K</div></div><div class="demo-stat"><div class="label">This Month</div><div class="value blue">$98K</div></div></div></div>
<div><h3 style="font-size:0.9rem;font-weight:600;margin-bottom:1rem;color:var(--text2)">Commission by Tier</h3>
<div class="demo-tiers">
<div class="demo-tier active"><span class="tier-dot t1"></span><div class="tier-info"><div class="tier-name">Tier 1 (6%)</div><div class="tier-range">$0 to $375K</div></div><span class="tier-comm">$22,500</span></div>
<div class="demo-tier active"><span class="tier-dot t2"></span><div class="tier-info"><div class="tier-name">Tier 2 (8%)</div><div class="tier-range">$375K to $469K</div></div><span class="tier-comm">$7,500</span></div>
<div class="demo-tier active"><span class="tier-dot t3"></span><div class="tier-info"><div class="tier-name">Tier 3 (10%)</div><div class="tier-range">$469K to $562K</div></div><span class="tier-comm">$4,125</span></div>
<div class="demo-tier"><span class="tier-dot t4"></span><div class="tier-info"><div class="tier-name">Tier 4 (12%)</div><div class="tier-range">$562K+</div></div><span class="tier-comm">$0</span></div>
</div></div>
</div></div></div>
</div></section>
<section class="section"><div class="container">
<h2 class="section-title">Sound familiar?</h2>
<p class="section-sub">Yeah, we have been there too.</p>
<div class="pain-grid">
<div class="pain-card"><div class="pain-icon">üò§</div><p>"I have no idea what I am actually getting paid until the check hits my account."</p></div>
<div class="pain-card"><div class="pain-icon">ü§Ø</div><p>"My comp plan has so many tiers and accelerators, even finance gets the math wrong."</p></div>
<div class="pain-card"><div class="pain-icon">ü§∑</div><p>"Am I close to the next tier? How much is it worth? No clue."</p></div>
</div></div></section>
<section class="section" id="features"><div class="glow-3" style="top:100px;left:-100px"></div><div class="glow-2" style="bottom:0;right:-200px"></div><div class="container">
<div class="section-label">Features</div>
<h2 class="section-title">Everything you need. Nothing you don't.</h2>
<div class="features-grid" style="margin-top:4rem">
<div class="feature-card"><div class="feature-icon">üíµ</div><h3>Exact dollar amounts</h3><p>Not percentages. Not estimates. The actual cash hitting your account after every deal.</p></div>
<div class="feature-card"><div class="feature-icon">üìä</div><h3>Tier by tier breakdown</h3><p>See exactly how much you earn at each commission tier. No more spreadsheet gymnastics.</p></div>
<div class="feature-card"><div class="feature-icon">üéØ</div><h3>Distance to next tier</h3><p>Know exactly how far you are from the next rate bump and what that bump is worth.</p></div>
<div class="feature-card"><div class="feature-icon">üìù</div><h3>Multi year contracts</h3><p>Different rates for 1 year vs 2 year deals? We calculate them separately, automatically.</p></div>
<div class="feature-card"><div class="feature-icon">‚ö°</div><h3>5 second deal entry</h3><p>Client name, amount, close date. Three fields. Done. Add deals between calls.</p></div>
<div class="feature-card"><div class="feature-icon">üì±</div><h3>Works everywhere</h3><p>Phone, tablet, laptop. Check your commission while you wait for your next meeting.</p></div>
</div></div></section>
<section class="section" style="padding-top:4rem;padding-bottom:4rem"><div class="container">
<div class="section-label">Import & Export</div>
<h2 class="section-title">Your data, your way</h2>
<div class="integrations-grid" style="margin-top:3rem">
<div class="integration-card">
<div class="integration-icon">üìÑ</div>
<h3>PDF Reports</h3>
<p>Generate professional commission reports. Perfect for reviews, taxes, or proving your worth.</p>
</div>
<div class="integration-card">
<div class="integration-icon">üìä</div>
<h3>CSV Export</h3>
<p>Download all your deals to a spreadsheet. Your data is always yours.</p>
</div>
<div class="integration-card">
<div class="integration-icon">üì•</div>
<h3>CSV Import</h3>
<p>Bulk upload your existing deals. Migrate from spreadsheets in seconds.</p>
</div>
<div class="integration-card">
<div class="integration-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" style="display:inline-block;vertical-align:middle"><path d="M22 12.5c0 5.247-4.253 9.5-9.5 9.5S3 17.747 3 12.5 7.253 3 12.5 3 22 7.253 22 12.5z" fill="#FF7A59"/><path d="M15.5 10.5c0 1.657-1.343 3-3 3s-3-1.343-3-3 1.343-3 3-3 3 1.343 3 3z" fill="#fff"/><path d="M12.5 14.5c-2.485 0-4.5 1.343-4.5 3v1h9v-1c0-1.657-2.015-3-4.5-3z" fill="#fff"/></svg></div>
<h3>HubSpot Import</h3>
<p>Connect your HubSpot CRM and sync deals automatically. No more double entry.</p>
</div>
</div>
</div></section>
<section class="section" style="background:linear-gradient(180deg,var(--bg),var(--bg2))"><div class="container" style="max-width:900px">
<h2 class="section-title">Zero to tracking in 2 minutes</h2>
<div class="steps" style="margin-top:4rem">
<div class="step"><div class="step-num">1</div><div class="step-content"><h3>Plug in your comp plan</h3><p>Quarterly goal, tier thresholds, commission rates. One time setup that takes 60 seconds.</p></div></div>
<div class="step"><div class="step-num">2</div><div class="step-content"><h3>Log your deals</h3><p>Add deals as you close them. Or enter your quarter to date total to get started instantly.</p></div></div>
<div class="step"><div class="step-num">3</div><div class="step-content"><h3>Know your money</h3><p>Watch your commission update in real time. Know exactly what you are taking home.</p></div></div>
</div></div></section>
<section class="section story-section"><div class="container">
<div class="section-label">The Story</div>
<h2 class="section-title">Built by a rep, for reps</h2>
<div class="story-content" style="margin-top:3rem">
<p>I have spent 15+ years in sales. Every single month, the same problem: I had no idea what my actual paycheck would be until it hit my account.</p>
<p>My comp plan was complicated. Tiered rates, different percentages for multi year deals, quarterly accelerators. I tried tracking it in spreadsheets but they always broke. I asked finance and got different answers every time.</p>
<p>So I built Comish. First just for myself. Then for my team. Now for you.</p>
<p>It does one thing really well: it tells you exactly what you are getting paid, broken down by tier, updated after every deal you close.</p>
<p class="signature">Scott, Founder</p>
</div></div></section>
<section class="section" id="faq"><div class="glow-1" style="top:-100px;left:50%;transform:translateX(-50%)"></div><div class="container">
<h2 class="section-title">Questions? Answers.</h2>
<div class="faq-grid" style="margin-top:4rem">
<div class="faq-item"><div class="faq-q" onclick="toggleFaq(this)">How does the free trial work?<span>+</span></div><div class="faq-a"><p>You get full access for 14 days, no credit card required. Set up your comp plan, log some deals, and see your commission calculate in real time. If you love it, subscribe for $5/month. If not, no hard feelings.</p></div></div>
<div class="faq-item"><div class="faq-q" onclick="toggleFaq(this)">Can it handle my comp plan?<span>+</span></div><div class="faq-a"><p>Comish supports tiered commission structures with up to 4 tiers, different rates for 1-year vs 2-year contracts, and quarterly goals with attainment tracking. Works for AEs, Account Managers, and closers. We also have a separate mode for SDRs/BDRs with activity-based comp.</p></div></div>
<div class="faq-item"><div class="faq-q" onclick="toggleFaq(this)">Is my data secure?<span>+</span></div><div class="faq-a"><p>Yes. We use Supabase for authentication and database with enterprise-grade encryption. Your commission data is private and never shared. You can export or delete your data anytime.</p></div></div>
<div class="faq-item"><div class="faq-q" onclick="toggleFaq(this)">Can I export my data?<span>+</span></div><div class="faq-a"><p>Yes. Export your deals to CSV or generate a PDF report for any quarter. Great for tax records, performance reviews, or checking your employer's math.</p></div></div>
<div class="faq-item"><div class="faq-q" onclick="toggleFaq(this)">What if I need help?<span>+</span></div><div class="faq-a"><p>Email info@comish.online and I'll personally respond within 48 hours. Built by a sales rep, supported by a sales rep. No chatbots.</p></div></div>
<div class="faq-item"><div class="faq-q" onclick="toggleFaq(this)">Why only $5/month?<span>+</span></div><div class="faq-a"><p>Because sales reps shouldn't need to spend a fortune to know what they're getting paid. This is a tool I built for myself and want other reps to have access to. Keep it simple, keep it cheap.</p></div></div>
</div>
</div></section>
<section class="section" id="pricing" style="background:linear-gradient(180deg,var(--bg2),var(--bg))"><div class="glow-2" style="top:50%;left:-200px;transform:translateY(-50%)"></div><div class="glow-3" style="top:50%;right:-150px;transform:translateY(-50%)"></div><div class="container">
<h2 class="section-title">Simple pricing</h2>
<p class="section-sub">No surprises. Just like your commission should be.</p>
<div class="pricing-grid">
<div class="price-card featured"><div class="price-badge">Most Popular</div><div class="price-name">Pro</div><div class="price-amount">$5<span>/mo</span></div><div class="price-period">Billed monthly. Cancel anytime.</div>
<ul class="price-features"><li>Unlimited deals</li><li>Tiered commission calculation</li><li>1 year and 2 year rate support</li><li>Quarterly and monthly views</li><li>PDF & CSV export</li><li>CSV & HubSpot import</li><li>14 day free trial</li></ul>
<button class="btn btn-primary btn-lg" onclick="showAuth('signup')">Start Free Trial</button></div>
<div class="price-card"><div class="price-badge" style="background:var(--purple)">Coming Soon</div><div class="price-name">Team</div><div class="price-amount">$49<span>/mo</span></div><div class="price-period">Up to 10 reps</div>
<ul class="price-features"><li>Everything in Pro</li><li>Team dashboard</li><li>Manager controls</li><li>Shared comp plans</li><li>Leaderboards</li><li>Priority support</li><li>Custom onboarding</li></ul>
<button class="btn btn-secondary btn-lg" onclick="showWaitlist()">Join Waitlist</button></div>
</div></div></section>
<section class="cta-section"><div class="cta-content">
<h2>Stop guessing.<br><span class="gradient">Start knowing.</span></h2>
<p>Set up takes 2 minutes. No credit card required. Know exactly what you are taking home.</p>
<button class="btn btn-primary btn-lg" onclick="showAuth('signup')">Start Tracking Free</button>
<p class="cta-note">Free for 14 days. No credit card required.</p>
</div></section>
<section class="section" id="feedback" style="background:linear-gradient(180deg,var(--bg),var(--bg2));position:relative;overflow:hidden">
<div class="glow-1" style="top:-200px;left:50%;transform:translateX(-50%);opacity:0.5"></div>
<div class="container" style="position:relative;z-index:1">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4rem;align-items:center;max-width:1000px;margin:0 auto">
<div>
<span style="display:inline-block;background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.2);color:var(--accent);padding:0.5rem 1rem;border-radius:100px;font-size:0.85rem;font-weight:600;margin-bottom:1.5rem">üí¨ We're Listening</span>
<h2 style="font-size:2.5rem;font-weight:800;letter-spacing:-0.03em;line-height:1.2;margin-bottom:1rem">Built by a rep,<br><span style="color:var(--accent)">for reps.</span></h2>
<p style="color:var(--text2);font-size:1.1rem;line-height:1.7;margin-bottom:2rem">Comish started from my own frustration tracking commissions in spreadsheets. Your feedback directly shapes what we build next.</p>
<div style="display:flex;gap:1.5rem">
<div style="text-align:center"><div style="font-size:2rem;font-weight:800;color:var(--accent)">48hr</div><div style="font-size:0.85rem;color:var(--muted)">Response time</div></div>
<div style="text-align:center"><div style="font-size:2rem;font-weight:800;color:var(--accent)">100%</div><div style="font-size:0.85rem;color:var(--muted)">Requests read</div></div>
<div style="text-align:center"><div style="font-size:2rem;font-weight:800;color:var(--accent)">12+</div><div style="font-size:0.85rem;color:var(--muted)">Features shipped</div></div>
</div>
</div>
<div style="background:linear-gradient(135deg,var(--card),var(--card2));border:1px solid rgba(0,255,136,0.15);border-radius:24px;padding:2rem;position:relative;overflow:hidden;box-shadow:0 0 30px rgba(0,255,136,0.08),inset 0 0 25px rgba(0,255,136,0.03)">
<div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:radial-gradient(circle,rgba(0,255,136,0.15),transparent);border-radius:50%"></div>
<h3 style="font-size:1.25rem;font-weight:700;margin-bottom:1.5rem">Send us your thoughts</h3>
<div style="display:flex;gap:0.5rem;margin-bottom:1.5rem">
<button class="feedback-tab active" onclick="setLandingFeedbackType(this,'feature')" style="flex:1;padding:0.75rem;border:1px solid var(--accent);background:rgba(0,255,136,0.1);color:var(--accent);border-radius:10px;cursor:pointer;font-size:0.85rem;font-family:inherit;font-weight:600;transition:all 0.2s">üí° Feature</button>
<button class="feedback-tab" onclick="setLandingFeedbackType(this,'integration')" style="flex:1;padding:0.75rem;border:1px solid var(--border);background:transparent;color:var(--text2);border-radius:10px;cursor:pointer;font-size:0.85rem;font-family:inherit;font-weight:500;transition:all 0.2s">üîå Integration</button>
<button class="feedback-tab" onclick="setLandingFeedbackType(this,'other')" style="flex:1;padding:0.75rem;border:1px solid var(--border);background:transparent;color:var(--text2);border-radius:10px;cursor:pointer;font-size:0.85rem;font-family:inherit;font-weight:500;transition:all 0.2s">üí¨ Other</button>
</div>
<input type="hidden" id="landingFeedbackType" value="feature">
<div class="form-group" style="margin-bottom:1rem"><textarea class="form-input" id="landingFeedbackText" rows="3" placeholder="What would make Comish perfect for you?" style="background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:1rem;color:var(--text);width:100%;font-family:inherit;font-size:0.95rem;resize:none"></textarea></div>
<div class="form-group" style="margin-bottom:1.25rem"><input type="email" class="form-input" id="landingFeedbackEmail" placeholder="your@email.com" style="background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:1rem;color:var(--text);width:100%;font-family:inherit;font-size:0.95rem"></div>
<button class="btn btn-primary" style="width:100%;padding:1rem;font-size:1rem;border-radius:12px" onclick="submitLandingFeedback()">Send Feedback ‚Üí</button>
</div>
</div>
</div>
</section>
<style>@media(max-width:800px){#feedback .container>div{grid-template-columns:1fr!important;gap:2rem!important;text-align:center}#feedback .container>div>div:first-child>div:last-child{justify-content:center}}</style>
<footer>
<div class="footer-content">
<div class="footer-brand"><a href="/" style="text-decoration:none"><div class="logo">Com<span>ish</span></div></a><p>Commission tracking for sales reps who want to know exactly what they are getting paid.</p></div>
<div class="footer-links"><h4>Product</h4><a href="#features">Features</a><a href="#pricing">Pricing</a><a href="#faq">FAQ</a><a href="/blog/">Blog</a><a href="#" onclick="showAuth('login');return false;">Log in</a></div>
<div class="footer-links"><h4>Legal</h4><a href="/privacy.html">Privacy Policy</a><a href="/terms.html">Terms of Service</a><a href="/contact.html">Contact</a></div>
</div>
<div class="footer-bottom">¬© 2025 Comish. All rights reserved.</div>
</footer>
</div>
<div class="modal-overlay" id="authModal"><div class="modal"><div class="modal-header"><h2 id="authTitle">Sign Up</h2><button class="modal-close" onclick="hideAuth()">√ó</button></div><div class="modal-body">
<form id="authForm" onsubmit="handleAuth(event)">
<div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="authEmail" required placeholder="you@company.com"></div>
<div class="form-group"><label class="form-label">Password</label><input type="password" class="form-input" id="authPassword" required minlength="6" placeholder="At least 6 characters"></div>
<div class="form-group" id="rememberGroup" style="display:none"><label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;color:var(--text2);font-size:0.9rem"><input type="checkbox" id="rememberMe" style="width:18px;height:18px;accent-color:var(--accent)"> Remember me</label></div>
<div class="form-error" id="authError"></div>
<button type="submit" class="btn btn-primary btn-lg" style="width:100%;margin-top:0.5rem" id="authSubmit">Sign Up</button>
</form>
<div class="auth-switch" id="authSwitch">Already have an account? <a onclick="toggleAuthMode()">Log in</a></div>
<div class="auth-switch" id="forgotLink" style="display:none;margin-top:0.5rem"><a onclick="showForgotPassword()">Forgot password?</a></div>
</div></div></div>
<div class="modal-overlay" id="forgotModal"><div class="modal"><div class="modal-header"><h2>Reset Password</h2><button class="modal-close" onclick="hideForgotPassword()">√ó</button></div><div class="modal-body">
<p style="color:var(--text2);margin-bottom:1.5rem">Enter your email and we'll send you a reset link.</p>
<form onsubmit="sendResetEmail(event)">
<div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="resetEmail" required placeholder="you@company.com"></div>
<div class="form-error" id="resetError"></div>
<button type="submit" class="btn btn-primary btn-lg" style="width:100%;margin-top:0.5rem" id="resetSubmit">Send Reset Link</button>
</form>
<div class="auth-switch" style="margin-top:1.5rem"><a onclick="hideForgotPassword();showAuth('login')">Back to login</a></div>
</div></div></div>
<div class="trial-expired-modal hidden" id="trialExpiredModal">
<div class="trial-expired-content">
<h2>Your trial has ended</h2>
<p class="subtitle">Subscribe to keep tracking your commissions</p>
<div class="price">$5<span>/month</span></div>
<div class="perks">
<div class="perk"><span>‚úì</span> Unlimited deals</div>
<div class="perk"><span>‚úì</span> Tiered commission calculations</div>
<div class="perk"><span>‚úì</span> Monthly & yearly breakdowns</div>
<div class="perk"><span>‚úì</span> CSV export</div>
<div class="perk"><span>‚úì</span> Cancel anytime</div>
</div>
<button class="btn btn-primary btn-lg" onclick="subscribe()">Subscribe Now</button>
<button class="btn btn-secondary" onclick="logout()" style="margin-top:0.75rem">Log Out</button>
</div>
</div>
<button class="feedback-btn hidden" id="feedbackBtn" onclick="showFeedback()">üí¨ Feedback</button>
<div class="modal-overlay feedback-modal" id="feedbackModal"><div class="modal"><div class="modal-header"><h2>Send Feedback</h2><button class="modal-close" onclick="hideFeedback()">√ó</button></div><div class="modal-body">
<div class="feedback-type">
<button class="active" onclick="setFeedbackType(this,'feature')">üí° Feature Request</button>
<button onclick="setFeedbackType(this,'bug')">üêõ Bug Report</button>
<button onclick="setFeedbackType(this,'other')">üí¨ Other</button>
</div>
<input type="hidden" id="feedbackType" value="feature">
<div class="form-group"><label class="form-label">Your feedback</label><textarea class="form-input" id="feedbackText" rows="5" placeholder="What would make Comish better for you?"></textarea></div>
<div class="form-group"><label class="form-label">Email (optional)</label><input type="email" class="form-input" id="feedbackEmail" placeholder="you@company.com"></div>
<button class="btn btn-primary" style="width:100%" onclick="submitFeedback()">Send Feedback</button>
</div></div></div>
<div class="modal-overlay" id="waitlistModal"><div class="modal"><div class="modal-header"><h2>Join the Team Waitlist</h2><button class="modal-close" onclick="hideWaitlist()">√ó</button></div><div class="modal-body">
<p style="color:var(--text2);margin-bottom:1.5rem">Get notified when Comish for Teams launches. Manage your whole sales floor from one dashboard.</p>
<form onsubmit="submitWaitlist(event)">
<div class="form-group"><label class="form-label">Work Email</label><input type="email" class="form-input" id="waitlistEmail" required placeholder="you@company.com"></div>
<div class="form-group"><label class="form-label">Team Size</label><select class="form-input" id="waitlistSize"><option>1-5 reps</option><option>6-10 reps</option><option>11-25 reps</option><option>25+ reps</option></select></div>
<button type="submit" class="btn btn-primary btn-lg" style="width:100%;margin-top:0.5rem">Join Waitlist</button>
</form>
</div></div></div>
<div id="app">
<div id="onboarding" class="onboarding hidden"><div class="onboard-card">
<div class="onboard-header"><h2 id="onboardTitle">What's your role?</h2><p id="onboardDesc">We'll customize your commission tracking</p>
<div class="onboard-progress"><div class="step active" id="ob-step-1"></div><div class="step" id="ob-step-2"></div><div class="step" id="ob-step-3"></div><div class="step" id="ob-step-4"></div><div class="step" id="ob-step-5"></div></div></div>
<div class="onboard-body">
<div id="ob-content-1">
<div style="display:grid;gap:1rem">
<div class="role-card" onclick="selectRole('ae')" id="roleAE" style="background:var(--card2);border:2px solid var(--border);border-radius:12px;padding:1.5rem;cursor:pointer;transition:all 0.2s">
<div style="display:flex;align-items:center;gap:1rem"><span style="font-size:1.75rem">üíº</span><div><strong style="font-size:1.1rem">AE / Closer</strong><p style="color:var(--text2);font-size:0.9rem;margin-top:0.25rem">Revenue-based commission</p></div></div>
</div>
<div class="role-card" onclick="selectRole('sdr')" id="roleSDR" style="background:var(--card2);border:2px solid var(--border);border-radius:12px;padding:1.5rem;cursor:pointer;transition:all 0.2s">
<div style="display:flex;align-items:center;gap:1rem"><span style="font-size:1.75rem">üìû</span><div><strong style="font-size:1.1rem">SDR / BDR</strong><p style="color:var(--text2);font-size:0.9rem;margin-top:0.25rem">Activity-based pay (meetings, SQLs, etc.)</p></div></div>
</div>
</div>
<input type="hidden" id="obRole" value="">
<input type="hidden" id="obStructure" value="tiered">
</div>
<div id="ob-content-2" class="hidden">
<div id="ae-step2">
<div style="display:grid;gap:1rem">
<div class="structure-card" onclick="selectStructure('tiered')" id="structTiered" style="background:var(--card2);border:2px solid var(--accent);border-radius:12px;padding:1.5rem;cursor:pointer;transition:all 0.2s">
<div style="display:flex;align-items:center;gap:1rem"><span style="font-size:1.75rem">üìà</span><div><strong style="font-size:1.1rem">Tiered / Accelerators</strong><p style="color:var(--text2);font-size:0.9rem;margin-top:0.25rem">Rates increase as you hit quota milestones</p><p style="color:var(--muted);font-size:0.8rem;margin-top:0.25rem">e.g., 6% ‚Üí 8% ‚Üí 10% ‚Üí 12%</p></div></div>
</div>
<div class="structure-card" onclick="selectStructure('flat')" id="structFlat" style="background:var(--card2);border:2px solid var(--border);border-radius:12px;padding:1.5rem;cursor:pointer;transition:all 0.2s">
<div style="display:flex;align-items:center;gap:1rem"><span style="font-size:1.75rem">‚û°Ô∏è</span><div><strong style="font-size:1.1rem">Flat Rate</strong><p style="color:var(--text2);font-size:0.9rem;margin-top:0.25rem">Same percentage on every deal</p><p style="color:var(--muted);font-size:0.8rem;margin-top:0.25rem">e.g., 8% on all revenue</p></div></div>
</div>
</div>
</div>
<div id="sdr-step2" class="hidden">
<div class="form-group"><label class="form-label">Quota Period</label>
<div style="display:flex;gap:0.5rem;margin-top:0.5rem">
<button type="button" class="period-btn active" onclick="setPeriod('monthly')" id="periodMonthly" style="flex:1;padding:0.75rem;border:1px solid var(--accent);background:rgba(0,255,136,0.1);color:var(--accent);border-radius:8px;cursor:pointer;font-family:inherit;font-weight:600">Monthly</button>
<button type="button" class="period-btn" onclick="setPeriod('quarterly')" id="periodQuarterly" style="flex:1;padding:0.75rem;border:1px solid var(--border);background:transparent;color:var(--text2);border-radius:8px;cursor:pointer;font-family:inherit;font-weight:500">Quarterly</button>
</div>
<input type="hidden" id="obPeriod" value="monthly">
</div>
<div class="form-group" style="margin-top:1.25rem"><label class="form-label">Activity Quota (per period)</label><input type="number" class="form-input" id="obActivityQuota" value="15" style="font-size:1.5rem;text-align:center"><div style="color:var(--muted);font-size:0.85rem;margin-top:0.5rem;text-align:center">meetings, SQLs, or primary activity</div></div>
</div>
</div>
<div id="ob-content-3" class="hidden">
<div id="ae-step3"><div class="form-group"><label class="form-label">Quarterly Goal ($)</label><input type="number" class="form-input" id="obGoal" value="375000" style="font-size:1.5rem;text-align:center"></div></div>
<div id="sdr-step3" class="hidden">
<div class="form-group"><label class="form-label">What do you get paid for?</label>
<div style="display:grid;gap:0.75rem;margin-top:0.75rem">
<label style="display:flex;align-items:center;gap:0.75rem;background:var(--card2);padding:1rem;border-radius:8px;cursor:pointer;border:1px solid var(--border)"><input type="checkbox" id="payMeeting" checked style="width:18px;height:18px;accent-color:var(--accent)"><span>Meetings booked</span></label>
<label style="display:flex;align-items:center;gap:0.75rem;background:var(--card2);padding:1rem;border-radius:8px;cursor:pointer;border:1px solid var(--border)"><input type="checkbox" id="paySQL" style="width:18px;height:18px;accent-color:var(--accent)"><span>SQLs (Sales Qualified Leads)</span></label>
<label style="display:flex;align-items:center;gap:0.75rem;background:var(--card2);padding:1rem;border-radius:8px;cursor:pointer;border:1px solid var(--border)"><input type="checkbox" id="payShow" style="width:18px;height:18px;accent-color:var(--accent)"><span>Show rate bonus (meeting held)</span></label>
</div>
</div>
</div>
</div>
<div id="ob-content-4" class="hidden">
<div id="ae-step4-tiered"><div class="form-group"><label class="form-label">Tier Thresholds (% of goal)</label><div class="rate-grid"><div><div class="rate-label">Tier 1</div><input type="number" class="form-input" value="0" disabled></div><div><div class="rate-label">Tier 2</div><input type="number" class="form-input" id="obTh2" value="100"></div><div><div class="rate-label">Tier 3</div><input type="number" class="form-input" id="obTh3" value="125"></div><div><div class="rate-label">Tier 4</div><input type="number" class="form-input" id="obTh4" value="150"></div></div></div></div>
<div id="ae-step4-flat" class="hidden" style="text-align:center;padding:2rem 0">
<div style="font-size:3rem;margin-bottom:1rem">‚úì</div>
<p style="color:var(--text2)">No tier setup needed with flat rate</p>
<p style="color:var(--muted);font-size:0.9rem;margin-top:0.5rem">You'll set your commission % next</p>
</div>
<div id="sdr-step4" class="hidden">
<div class="form-group" id="meetingRateGroup"><label class="form-label">Pay per Meeting Booked ($)</label><input type="number" class="form-input" id="obMeetingRate" value="75" style="font-size:1.25rem;text-align:center"></div>
<div class="form-group" id="sqlRateGroup" style="margin-top:1.25rem;display:none"><label class="form-label">Pay per SQL ($)</label><input type="number" class="form-input" id="obSQLRate" value="150" style="font-size:1.25rem;text-align:center"></div>
<div class="form-group" id="showRateGroup" style="margin-top:1.25rem;display:none"><label class="form-label">Show Rate Bonus ($)</label><input type="number" class="form-input" id="obShowRate" value="25" style="font-size:1.25rem;text-align:center"><div style="color:var(--muted);font-size:0.85rem;margin-top:0.5rem;text-align:center">Extra bonus when meeting actually happens</div></div>
</div>
</div>
<div id="ob-content-5" class="hidden">
<div id="ae-step5-tiered"><div class="form-group"><label class="form-label">1 Year Contract Rates (%)</label><div class="rate-grid"><div><div class="rate-label">Tier 1</div><input type="number" class="form-input" id="obR1a" value="6"></div><div><div class="rate-label">Tier 2</div><input type="number" class="form-input" id="obR1b" value="8"></div><div><div class="rate-label">Tier 3</div><input type="number" class="form-input" id="obR1c" value="10"></div><div><div class="rate-label">Tier 4</div><input type="number" class="form-input" id="obR1d" value="12"></div></div></div>
<div class="form-group" style="margin-top:1.5rem"><label class="form-label">2 Year Contract Rates (%)</label><div class="rate-grid"><div><div class="rate-label">Tier 1</div><input type="number" class="form-input" id="obR2a" value="8"></div><div><div class="rate-label">Tier 2</div><input type="number" class="form-input" id="obR2b" value="10"></div><div><div class="rate-label">Tier 3</div><input type="number" class="form-input" id="obR2c" value="12"></div><div><div class="rate-label">Tier 4</div><input type="number" class="form-input" id="obR2d" value="14"></div></div></div></div>
<div id="ae-step5-flat" class="hidden">
<div class="form-group"><label class="form-label">1 Year Contract Rate (%)</label><input type="number" class="form-input" id="obFlatRate1" value="8" style="font-size:1.5rem;text-align:center"><div style="color:var(--muted);font-size:0.85rem;margin-top:0.5rem;text-align:center">Commission on all 1-year deals</div></div>
<div class="form-group" style="margin-top:1.5rem"><label class="form-label">2 Year Contract Rate (%)</label><input type="number" class="form-input" id="obFlatRate2" value="10" style="font-size:1.5rem;text-align:center"><div style="color:var(--muted);font-size:0.85rem;margin-top:0.5rem;text-align:center">Commission on all 2-year deals</div></div>
</div>
</div>
</div>
<div class="onboard-footer"><button class="btn btn-ghost" id="obBack" onclick="onboardBack()" style="visibility:hidden">Back</button><button class="btn btn-primary" id="obNext" onclick="onboardNext()">Continue</button></div>
</div></div>
<div id="dashboard" class="dashboard hidden">
<nav class="dash-nav"><a href="/" style="text-decoration:none"><div class="logo">Com<span>ish</span></div></a><div class="user-menu"><span class="user-email" id="userEmail"></span><button class="btn btn-ghost" onclick="showProfile()">Account</button><button class="btn btn-ghost" onclick="logout()">Log out</button></div></nav>
<div class="dash-container">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem">
<div class="view-toggle"><button class="active" onclick="setView('quarter')">Quarter</button><button onclick="setView('year')">Year</button></div>
<div style="display:flex;gap:0.75rem"><select id="yearSelect" onchange="render()" style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:0.625rem 1rem;color:var(--text)"></select><select id="quarterSelect" onchange="render()" style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:0.625rem 1rem;color:var(--text)"><option value="Q1">Q1</option><option value="Q2">Q2</option><option value="Q3">Q3</option><option value="Q4">Q4</option></select></div>
<div style="display:flex;gap:0.75rem;flex-wrap:wrap">
<div class="dropdown" style="position:relative">
<button class="btn btn-secondary" onclick="toggleDropdown('exportDropdown')">üì§ Export ‚ñæ</button>
<div id="exportDropdown" class="dropdown-menu" style="display:none;position:absolute;top:100%;left:0;margin-top:0.5rem;background:var(--card);border:1px solid var(--border);border-radius:8px;min-width:120px;z-index:100;overflow:hidden">
<div class="dropdown-item" onclick="exportPDF();closeDropdowns()" style="padding:0.75rem 1rem;cursor:pointer;transition:background 0.2s">üìÑ PDF</div>
<div class="dropdown-item" onclick="exportCSV();closeDropdowns()" style="padding:0.75rem 1rem;cursor:pointer;transition:background 0.2s">üìä CSV</div>
</div>
</div>
<div class="dropdown" style="position:relative">
<button class="btn btn-secondary" onclick="toggleDropdown('importDropdown')">üì• Import ‚ñæ</button>
<div id="importDropdown" class="dropdown-menu" style="display:none;position:absolute;top:100%;left:0;margin-top:0.5rem;background:var(--card);border:1px solid var(--border);border-radius:8px;min-width:120px;z-index:100;overflow:hidden">
<div class="dropdown-item" onclick="$('csvFileInput').click();closeDropdowns()" style="padding:0.75rem 1rem;cursor:pointer;transition:background 0.2s">üìä CSV</div>
<div class="dropdown-item" onclick="openHubSpotImport();closeDropdowns()" style="padding:0.75rem 1rem;cursor:pointer;transition:background 0.2s">üî∂ HubSpot</div>
<div class="dropdown-item" onclick="openSalesforceImport();closeDropdowns()" style="padding:0.75rem 1rem;cursor:pointer;transition:background 0.2s">‚òÅÔ∏è Salesforce</div>
</div>
</div>
<input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="handleCSVUpload(event)">
<button class="btn btn-secondary" onclick="openSettings()">‚öôÔ∏è Settings</button>
</div>
</div>
<div id="quarterView">
<div class="quick-entry">
<div><label>Starting Point</label><div style="display:flex;gap:0.5rem;align-items:center;margin-top:0.375rem"><span style="color:var(--muted);font-size:1.25rem">$</span><input type="number" id="startingPoint" placeholder="0" onchange="saveStarting()"></div><div class="hint">Revenue already closed this quarter before tracking</div></div>
<div style="margin-left:auto;text-align:right"><div style="font-size:0.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em">Quarterly Total</div><div style="font-size:2rem;font-weight:900;color:var(--accent)" id="qtdTotal">$0</div></div>
</div>
<div class="stats">
<div class="stat"><div class="stat-label">Quarterly Goal</div><div class="stat-value" id="qGoal">$375,000</div><div class="stat-sub" id="attainmentPct">0%</div></div>
<div class="stat"><div class="stat-label">Current Tier</div><div class="stat-value green" id="currentTier">Tier 1</div><div class="stat-sub" id="tierRates">1yr: 6% ¬∑ 2yr: 8%</div></div>
<div class="stat"><div class="stat-label">To Next Tier</div><div class="stat-value yellow" id="toNext">$375,000</div><div class="stat-sub" id="nextTierName">to Tier 2</div></div>
<div class="stat"><div class="stat-label" id="monthLabel">This Month</div><div class="stat-value blue" id="monthTotal">$0</div><div class="stat-sub" id="monthDeals">0 deals</div></div>
<div class="stat hl"><div class="stat-label">Paid Commission</div><div class="stat-value green" id="totalCommStat">$0</div><div class="stat-sub">earned so far</div></div>
</div>
<div class="progress-section">
<div class="progress-header"><span class="progress-title">Quarterly Progress</span><div class="progress-stats"><span><strong id="closedAmt">$0</strong> closed</span><span><strong id="remainingAmt">$375K</strong> to goal</span></div></div>
<div class="progress-bar-wrap"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
<div class="progress-labels"><span>0%</span><span>100%</span><span>125%</span><span>150%</span><span>175%+</span></div>
</div>
<div class="main-grid">
<div class="card"><div class="card-header" style="flex-wrap:wrap;gap:0.75rem"><div style="display:flex;align-items:center;gap:1rem"><span class="card-title">Deals</span><span id="dealCount" style="font-size:0.8rem;color:var(--muted);font-weight:400"></span></div><div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap"><select id="monthFilter" onchange="renderDeals()" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.5rem 0.75rem;color:var(--text);font-size:0.85rem"><option value="all">All Months</option></select><select id="termFilter" onchange="renderDeals()" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.5rem 0.75rem;color:var(--text);font-size:0.85rem"><option value="all">All Terms</option><option value="1">1 Year</option><option value="2">2 Year</option></select><select id="statusFilter" onchange="renderDeals()" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.5rem 0.75rem;color:var(--text);font-size:0.85rem"><option value="all">All Status</option><option value="paid">Paid</option><option value="unpaid">Unpaid</option></select><select id="tierFilter" onchange="renderDeals()" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.5rem 0.75rem;color:var(--text);font-size:0.85rem"><option value="all">All Tiers</option><option value="1">Tier 1</option><option value="2">Tier 2</option><option value="3">Tier 3</option><option value="4">Tier 4</option></select><button class="btn btn-primary" onclick="openDeal()" style="padding:0.5rem 1rem">+ Add Deal</button></div></div>
<div class="table-wrap"><table><thead><tr><th class="sortable" onclick="sortDeals('name')">Client <span id="sortName" class="sort-arrow"></span></th><th class="sortable" onclick="sortDeals('amount')">Amount <span id="sortAmount" class="sort-arrow"></span></th><th class="sortable" onclick="sortDeals('tier')">Tier <span id="sortTier" class="sort-arrow"></span></th><th class="sortable" onclick="sortDeals('commission')">Commission <span id="sortCommission" class="sort-arrow"></span></th><th class="sortable" onclick="sortDeals('term')">Term <span id="sortTerm" class="sort-arrow"></span></th><th class="sortable" onclick="sortDeals('date')">Date <span id="sortDate" class="sort-arrow"></span></th><th class="sortable" onclick="sortDeals('status')">Status <span id="sortStatus" class="sort-arrow"></span></th><th></th></tr></thead><tbody id="dealsBody"></tbody></table><div class="empty" id="emptyDeals" style="display:none">No deals yet.<br><button class="btn btn-primary" onclick="openDeal()" style="margin-top:1rem">Add your first deal</button></div></div></div>
<div class="sidebar-cards">
<div class="side-card"><div class="side-title" id="commissionTitle">Commission by Tier</div><div id="tierBreakdown"></div>
<div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border)">
<div class="comm-row" id="paidCommRow" style="cursor:pointer;padding:0.5rem;margin:-0.5rem;border-radius:6px;transition:background 0.2s" onclick="filterByStatus('paid')" title="Click to filter paid deals"><span class="comm-label">üí∞ Earned</span><span class="comm-value green" id="paidCommTotal">$0</span></div>
<div class="comm-row" id="unpaidCommRow" style="cursor:pointer;padding:0.5rem;margin:-0.5rem;border-radius:6px;transition:background 0.2s;margin-top:0.5rem" onclick="filterByStatus('unpaid')" title="Click to filter unpaid deals"><span class="comm-label">‚è≥ Upcoming</span><span class="comm-value" style="color:var(--muted)" id="unpaidCommTotal">$0</span></div>
</div>
<div class="comm-summary"><div class="comm-row"><span class="comm-label">1 Year Deals</span><span class="comm-value blue" id="y1Comm">$0</span></div><div class="comm-row"><span class="comm-label">2 Year Deals</span><span class="comm-value purple" id="y2Comm">$0</span></div><div class="comm-row total"><span class="comm-label">Total</span><span class="comm-value" id="totalComm">$0</span></div></div></div>
<div class="side-card"><div class="side-title">Monthly Breakdown</div><div id="monthlyBreakdown"></div></div>
<div class="side-card"><div class="side-title">Revenue</div><div class="comm-row"><span class="comm-label">1 Year</span><span class="comm-value blue" id="y1Rev">$0</span></div><div class="comm-row"><span class="comm-label">2 Year</span><span class="comm-value purple" id="y2Rev">$0</span></div><div class="comm-row total"><span class="comm-label">Deals Total</span><span class="comm-value" id="totalRev">$0</span></div></div>
</div></div></div>
</div>
<div id="yearView" class="hidden" style="padding:0 2rem 2rem;max-width:1800px;margin:0 auto">
<div class="yearly-summary" id="yearlySummary"></div>
<div class="chart-section">
<div class="chart-header">
<span class="chart-title">Monthly Performance</span>
<div class="chart-legend">
<div class="chart-legend-item"><span class="chart-legend-dot" style="background:linear-gradient(180deg,var(--blue),var(--purple))"></span>Revenue</div>
<div class="chart-legend-item"><span class="chart-legend-dot" style="background:linear-gradient(180deg,var(--accent),var(--accent2))"></span>Commission</div>
</div>
</div>
<div class="bar-chart" id="barChart"></div>
</div>
<div class="chart-section">
<div class="chart-header"><span class="chart-title">Quarter Comparison</span></div>
<div class="quarter-compare" id="quarterCompare"></div>
</div>
<div class="monthly-section">
<div class="monthly-header"><span class="monthly-title">Monthly Breakdown</span></div>
<div class="monthly-grid" id="monthlyGrid"></div>
</div>
</div>
</div>
<div id="sdrDashboard" class="dashboard hidden">
<nav class="dash-nav"><a href="/" style="text-decoration:none"><div class="logo">Com<span>ish</span></div></a><div class="user-menu"><span class="user-email" id="sdrUserEmail"></span><button class="btn btn-ghost" onclick="showProfile()">Account</button><button class="btn btn-ghost" onclick="logout()">Log out</button></div></nav>
<div class="dash-container">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem">
<h2 style="font-size:1.5rem;font-weight:700">Activity Dashboard</h2>
<div style="display:flex;gap:0.75rem;flex-wrap:wrap">
<select id="sdrMonthSelect" onchange="renderSDR()" style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:0.625rem 1rem;color:var(--text)"></select>
<button class="btn btn-secondary" onclick="openSDRSettings()">‚öôÔ∏è Settings</button>
<button class="btn btn-primary" onclick="openActivity()">+ Log Activity</button>
</div>
</div>
<div class="stats">
<div class="stat"><div class="stat-label">Period Quota</div><div class="stat-value" id="sdrQuota">15</div><div class="stat-sub" id="sdrPeriodLabel">meetings this month</div></div>
<div class="stat"><div class="stat-label">Completed</div><div class="stat-value green" id="sdrCompleted">0</div><div class="stat-sub" id="sdrCompletedPct">0% of quota</div></div>
<div class="stat"><div class="stat-label">To Quota</div><div class="stat-value yellow" id="sdrToQuota">15</div><div class="stat-sub">remaining</div></div>
<div class="stat hl"><div class="stat-label">Earnings This Period</div><div class="stat-value green" id="sdrEarnings">$0</div><div class="stat-sub" id="sdrEarningsBreakdown">-</div></div>
</div>
<div class="progress-section">
<div class="progress-header"><span class="progress-title">Quota Progress</span><div class="progress-stats"><span><strong id="sdrDoneCount">0</strong> completed</span><span><strong id="sdrLeftCount">15</strong> to go</span></div></div>
<div class="progress-bar-wrap"><div class="progress-bar" id="sdrProgressBar" style="width:0%"></div></div>
<div class="progress-labels"><span>0%</span><span>50%</span><span>100%</span><span>125%</span><span>150%+</span></div>
</div>
<div class="main-grid">
<div class="card"><div class="card-header"><span class="card-title">Activities</span><select id="sdrActivityFilter" onchange="renderSDRActivities()" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.5rem 0.75rem;color:var(--text)"><option value="all">All Types</option><option value="meeting">Meetings</option><option value="sql">SQLs</option><option value="show">Shows</option></select></div>
<div class="table-wrap"><table><thead><tr><th>Type</th><th>Description</th><th>Date</th><th>Payout</th><th></th></tr></thead><tbody id="sdrActivitiesBody"></tbody></table><div class="empty" id="emptyActivities" style="display:none">No activities yet.<br><button class="btn btn-primary" onclick="openActivity()" style="margin-top:1rem">Log your first activity</button></div></div></div>
<div class="sidebar-cards">
<div class="side-card"><div class="side-title">Earnings Breakdown</div>
<div class="comm-row" id="meetingEarningsRow"><span class="comm-label">üìÖ Meetings</span><span class="comm-value green" id="meetingEarnings">$0</span></div>
<div class="comm-row" id="sqlEarningsRow" style="display:none"><span class="comm-label">üéØ SQLs</span><span class="comm-value blue" id="sqlEarnings">$0</span></div>
<div class="comm-row" id="showEarningsRow" style="display:none"><span class="comm-label">‚úÖ Show Bonuses</span><span class="comm-value purple" id="showEarnings">$0</span></div>
<div class="comm-row total"><span class="comm-label">Total</span><span class="comm-value" id="sdrTotalEarnings">$0</span></div>
</div>
<div class="side-card"><div class="side-title">Activity Count</div>
<div class="comm-row" id="meetingCountRow"><span class="comm-label">üìÖ Meetings</span><span class="comm-value" id="meetingCount">0</span></div>
<div class="comm-row" id="sqlCountRow" style="display:none"><span class="comm-label">üéØ SQLs</span><span class="comm-value" id="sqlCount">0</span></div>
<div class="comm-row" id="showCountRow" style="display:none"><span class="comm-label">‚úÖ Shows</span><span class="comm-value" id="showCount">0</span></div>
</div>
</div></div>
</div>
</div>
<div id="activityModal" class="modal-overlay"><div class="modal">
<div class="modal-header"><h2 id="activityModalTitle">Log Activity</h2><button class="modal-close" onclick="closeActivity()">√ó</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Activity Type</label><select class="form-input" id="activityType" onchange="updateActivityForm()"><option value="meeting">üìÖ Meeting Booked</option><option value="sql">üéØ SQL Generated</option><option value="show">‚úÖ Meeting Held (Show)</option></select></div>
<div class="form-group"><label class="form-label">Description</label><input type="text" class="form-input" id="activityDesc" placeholder="e.g., Acme Corp discovery call"></div>
<div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="activityDate"></div>
<div class="form-group" id="activityPayoutGroup"><label class="form-label">Payout</label><div class="form-input" id="activityPayout" style="background:var(--card2);color:var(--accent)">$75</div></div>
<button class="btn btn-primary" style="width:100%;margin-top:1rem" onclick="saveActivity()">Save Activity</button>
</div>
</div></div>
<div id="sdrSettingsModal" class="modal-overlay"><div class="modal">
<div class="modal-header"><h2>SDR Settings</h2><button class="modal-close" onclick="closeSDRSettings()">√ó</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Quota Period</label>
<div style="display:flex;gap:0.5rem">
<button type="button" onclick="setSDRPeriod('monthly')" id="sdrSetMonthly" style="flex:1;padding:0.75rem;border:1px solid var(--accent);background:rgba(0,255,136,0.1);color:var(--accent);border-radius:8px;cursor:pointer;font-family:inherit">Monthly</button>
<button type="button" onclick="setSDRPeriod('quarterly')" id="sdrSetQuarterly" style="flex:1;padding:0.75rem;border:1px solid var(--border);background:transparent;color:var(--text2);border-radius:8px;cursor:pointer;font-family:inherit">Quarterly</button>
</div></div>
<div class="form-group" style="margin-top:1rem"><label class="form-label">Activity Quota</label><input type="number" class="form-input" id="sdrSetQuota" value="15"></div>
<div class="form-group" style="margin-top:1rem"><label class="form-label">Pay per Meeting ($)</label><input type="number" class="form-input" id="sdrSetMeetingRate" value="75"></div>
<div class="form-group" style="margin-top:1rem"><label class="form-label">Pay per SQL ($)</label><input type="number" class="form-input" id="sdrSetSQLRate" value="150"></div>
<div class="form-group" style="margin-top:1rem"><label class="form-label">Show Bonus ($)</label><input type="number" class="form-input" id="sdrSetShowRate" value="25"></div>
<button class="btn btn-primary" style="width:100%;margin-top:1.5rem" onclick="saveSDRSettings()">Save Settings</button>
</div>
</div></div>
<div id="compSettingsModal" class="modal-overlay"><div class="modal" style="max-width:560px">
<div class="modal-header"><h2>Commission Settings</h2><button class="modal-close" onclick="closeCompSettings()">√ó</button></div>
<div class="modal-body">
<div id="currentPlanSummary" style="background:linear-gradient(135deg,rgba(0,255,136,0.1),rgba(0,255,136,0.05));border:1px solid rgba(0,255,136,0.3);border-radius:12px;padding:1.25rem;margin-bottom:1.5rem">
<div style="font-size:0.75rem;color:var(--accent);font-weight:600;margin-bottom:0.5rem;letter-spacing:0.5px">YOUR CURRENT PLAN</div>
<div id="planSummaryText" style="color:var(--text);font-size:1.1rem"></div>
</div>
<div class="form-group"><label class="form-label">Your Role</label>
<div style="display:flex;gap:0.5rem">
<button type="button" onclick="setCompRole('ae')" id="compRoleAE" style="flex:1;padding:0.75rem;border:1px solid var(--accent);background:rgba(0,255,136,0.1);color:var(--accent);border-radius:8px;cursor:pointer;font-family:inherit;font-weight:600">AE / Closer</button>
<button type="button" onclick="setCompRole('sdr')" id="compRoleSDR" style="flex:1;padding:0.75rem;border:1px solid var(--border);background:transparent;color:var(--text2);border-radius:8px;cursor:pointer;font-family:inherit;font-weight:600">SDR / BDR</button>
</div></div>
<div id="aeSettingsFields">
<div class="form-group" style="margin-top:1.5rem"><label class="form-label">Commission Structure</label>
<p style="color:var(--muted);font-size:0.8rem;margin:0.25rem 0 0.75rem">How your commission rates work</p>
<div style="display:flex;gap:0.5rem">
<button type="button" onclick="setCompStructure('tiered')" id="compStructTiered" style="flex:1;padding:0.75rem;border:1px solid var(--accent);background:rgba(0,255,136,0.1);color:var(--accent);border-radius:8px;cursor:pointer;font-family:inherit;font-weight:600">üìà Tiered</button>
<button type="button" onclick="setCompStructure('flat')" id="compStructFlat" style="flex:1;padding:0.75rem;border:1px solid var(--border);background:transparent;color:var(--text2);border-radius:8px;cursor:pointer;font-family:inherit;font-weight:600">‚û°Ô∏è Flat Rate</button>
</div>
<p id="structureExplainer" style="color:var(--muted);font-size:0.8rem;margin-top:0.75rem;padding:0.75rem;background:var(--card2);border-radius:8px"></p>
</div>
<div class="form-group" style="margin-top:1.5rem"><label class="form-label">Quarterly Quota</label>
<p style="color:var(--muted);font-size:0.8rem;margin:0.25rem 0 0.5rem">Your revenue target each quarter</p>
<div style="position:relative"><span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted)">$</span><input type="number" class="form-input" id="compQuota" value="375000" style="padding-left:24px"></div>
</div>
<div id="tieredSettingsFields">
<div style="margin-top:1.5rem;padding:1rem;background:var(--card2);border-radius:12px;border:1px solid var(--border)">
<label class="form-label" style="margin-bottom:0.25rem">Tier Thresholds</label>
<p style="color:var(--muted);font-size:0.8rem;margin:0 0 1rem">At what % of quota each tier kicks in</p>
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem">
<div><label style="font-size:0.7rem;color:var(--muted);display:block;margin-bottom:4px">Tier 1</label><input type="number" class="form-input" value="0" disabled style="text-align:center;background:var(--bg);font-size:0.95rem"><span style="font-size:0.7rem;color:var(--muted);display:block;margin-top:2px;text-align:center">0%+</span></div>
<div><label style="font-size:0.7rem;color:var(--muted);display:block;margin-bottom:4px">Tier 2</label><input type="number" class="form-input" id="compTh2" value="100" style="text-align:center;font-size:0.95rem"><span style="font-size:0.7rem;color:var(--muted);display:block;margin-top:2px;text-align:center">% of quota</span></div>
<div><label style="font-size:0.7rem;color:var(--muted);display:block;margin-bottom:4px">Tier 3</label><input type="number" class="form-input" id="compTh3" value="125" style="text-align:center;font-size:0.95rem"><span style="font-size:0.7rem;color:var(--muted);display:block;margin-top:2px;text-align:center">% of quota</span></div>
<div><label style="font-size:0.7rem;color:var(--muted);display:block;margin-bottom:4px">Tier 4</label><input type="number" class="form-input" id="compTh4" value="150" style="text-align:center;font-size:0.95rem"><span style="font-size:0.7rem;color:var(--muted);display:block;margin-top:2px;text-align:center">% of quota</span></div>
</div>
</div>
<div style="margin-top:1rem;padding:1rem;background:var(--card2);border-radius:12px;border:1px solid var(--border)">
<label class="form-label" style="margin-bottom:0.25rem">1-Year Deal Rates</label>
<p style="color:var(--muted);font-size:0.8rem;margin:0 0 1rem">Commission % on 1-year contracts at each tier</p>
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem">
<div><input type="number" class="form-input" id="compR1a" value="6" style="text-align:center;font-size:0.95rem"><span style="font-size:0.7rem;color:var(--muted);display:block;margin-top:2px;text-align:center">T1 %</span></div>
<div><input type="number" class="form-input" id="compR1b" value="8" style="text-align:center;font-size:0.95rem"><span style="font-size:0.7rem;color:var(--muted);display:block;margin-top:2px;text-align:center">T2 %</span></div>
<div><input type="number" class="form-input" id="compR1c" value="10" style="text-align:center;font-size:0.95rem"><span style="font-size:0.7rem;color:var(--muted);display:block;margin-top:2px;text-align:center">T3 %</span></div>
<div><input type="number" class="form-input" id="compR1d" value="12" style="text-align:center;font-size:0.95rem"><span style="font-size:0.7rem;color:var(--muted);display:block;margin-top:2px;text-align:center">T4 %</span></div>
</div>
</div>
<div style="margin-top:1rem;padding:1rem;background:var(--card2);border-radius:12px;border:1px solid var(--border)">
<label class="form-label" style="margin-bottom:0.25rem">2-Year Deal Rates</label>
<p style="color:var(--muted);font-size:0.8rem;margin:0 0 1rem">Commission % on 2-year contracts at each tier</p>
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem">
<div><input type="number" class="form-input" id="compR2a" value="8" style="text-align:center;font-size:0.95rem"><span style="font-size:0.7rem;color:var(--muted);display:block;margin-top:2px;text-align:center">T1 %</span></div>
<div><input type="number" class="form-input" id="compR2b" value="10" style="text-align:center;font-size:0.95rem"><span style="font-size:0.7rem;color:var(--muted);display:block;margin-top:2px;text-align:center">T2 %</span></div>
<div><input type="number" class="form-input" id="compR2c" value="12" style="text-align:center;font-size:0.95rem"><span style="font-size:0.7rem;color:var(--muted);display:block;margin-top:2px;text-align:center">T3 %</span></div>
<div><input type="number" class="form-input" id="compR2d" value="14" style="text-align:center;font-size:0.95rem"><span style="font-size:0.7rem;color:var(--muted);display:block;margin-top:2px;text-align:center">T4 %</span></div>
</div>
</div>
</div>
<div id="flatSettingsFields" style="display:none">
<div style="margin-top:1rem;padding:1.25rem;background:var(--card2);border-radius:12px;border:1px solid var(--border)">
<div class="form-group"><label class="form-label">1-Year Deal Rate</label>
<p style="color:var(--muted);font-size:0.8rem;margin:0.25rem 0 0.5rem">Commission % on all 1-year contracts</p>
<div style="display:flex;align-items:center;gap:0.5rem"><input type="number" class="form-input" id="compFlatRate1" value="8" style="text-align:center;font-size:1.5rem;max-width:100px"><span style="color:var(--muted);font-size:1.25rem">%</span></div>
</div>
<div class="form-group" style="margin-top:1.25rem"><label class="form-label">2-Year Deal Rate</label>
<p style="color:var(--muted);font-size:0.8rem;margin:0.25rem 0 0.5rem">Commission % on all 2-year contracts</p>
<div style="display:flex;align-items:center;gap:0.5rem"><input type="number" class="form-input" id="compFlatRate2" value="10" style="text-align:center;font-size:1.5rem;max-width:100px"><span style="color:var(--muted);font-size:1.25rem">%</span></div>
</div>
</div>
</div>
</div>
<div id="sdrSettingsFields" style="display:none">
<div class="form-group" style="margin-top:1.5rem"><label class="form-label">Quota Period</label>
<p style="color:var(--muted);font-size:0.8rem;margin:0.25rem 0 0.75rem">How often your quota resets</p>
<div style="display:flex;gap:0.5rem">
<button type="button" onclick="setCompPeriod('monthly')" id="compMonthly" style="flex:1;padding:0.75rem;border:1px solid var(--accent);background:rgba(0,255,136,0.1);color:var(--accent);border-radius:8px;cursor:pointer;font-family:inherit">Monthly</button>
<button type="button" onclick="setCompPeriod('quarterly')" id="compQuarterly" style="flex:1;padding:0.75rem;border:1px solid var(--border);background:transparent;color:var(--text2);border-radius:8px;cursor:pointer;font-family:inherit">Quarterly</button>
</div></div>
<div class="form-group" style="margin-top:1rem"><label class="form-label">Activity Quota</label>
<p style="color:var(--muted);font-size:0.8rem;margin:0.25rem 0 0.5rem">Target meetings per period</p>
<input type="number" class="form-input" id="compActivityQuota" value="15"></div>
<div style="margin-top:1.25rem;padding:1rem;background:var(--card2);border-radius:12px;border:1px solid var(--border)">
<label class="form-label" style="margin-bottom:0.75rem">Pay Rates</label>
<div class="form-group"><label style="font-size:0.85rem;color:var(--text2)">Per Meeting Booked</label>
<div style="display:flex;align-items:center;gap:0.5rem;margin-top:0.25rem"><span style="color:var(--muted)">$</span><input type="number" class="form-input" id="compMeetingRate" value="75" style="max-width:100px"></div></div>
<div class="form-group" style="margin-top:0.75rem"><label style="font-size:0.85rem;color:var(--text2)">Per SQL Generated</label>
<div style="display:flex;align-items:center;gap:0.5rem;margin-top:0.25rem"><span style="color:var(--muted)">$</span><input type="number" class="form-input" id="compSQLRate" value="150" style="max-width:100px"></div></div>
<div class="form-group" style="margin-top:0.75rem"><label style="font-size:0.85rem;color:var(--text2)">Show Bonus (meeting held)</label>
<div style="display:flex;align-items:center;gap:0.5rem;margin-top:0.25rem"><span style="color:var(--muted)">$</span><input type="number" class="form-input" id="compShowRate" value="25" style="max-width:100px"></div></div>
</div>
</div>
<button class="btn btn-primary" style="width:100%;margin-top:1.5rem" onclick="saveCompSettings()">Save Settings</button>
</div>
</div></div>
<div id="profilePage" class="profile-page hidden">
<nav class="dash-nav"><a href="/" style="text-decoration:none"><div class="logo">Com<span>ish</span></div></a><div class="user-menu"><span class="user-email" id="profileUserEmail"></span><button class="btn btn-ghost" onclick="logout()">Log out</button></div></nav>
<div class="profile-container">
<div class="profile-header">
<h1>Account Settings</h1>
<p>Manage your profile and subscription</p>
</div>
<div class="trial-banner" id="trialBanner">
<div class="trial-banner-text">
<span>‚è∞</span>
<div class="trial-banner-info">
<strong id="trialDaysLeft">14 days left in your free trial</strong>
<p>Subscribe to keep tracking your commission</p>
</div>
</div>
<button class="btn btn-primary" onclick="subscribe()">Subscribe - $5/mo</button>
</div>
<div class="profile-card">
<div class="profile-card-title">Subscription</div>
<div class="profile-row">
<span class="profile-row-label">Status</span>
<span class="subscription-badge trial" id="subStatus">Free Trial</span>
</div>
<div class="profile-row">
<span class="profile-row-label">Plan</span>
<span class="profile-row-value">Pro - $5/month</span>
</div>
<div class="profile-row" id="renewalRow" style="display:none">
<span class="profile-row-label">Next billing date</span>
<span class="profile-row-value" id="renewalDate">-</span>
</div>
<div class="profile-row" id="manageSubRow" style="display:none">
<span class="profile-row-label">Manage</span>
<button class="btn btn-secondary" onclick="manageSubscription()">Manage Subscription</button>
</div>
</div>
<div class="profile-card">
<div class="profile-card-title">Account</div>
<div class="profile-row">
<span class="profile-row-label">Email</span>
<span class="profile-row-value" id="profileEmail">-</span>
</div>
<div class="profile-row">
<span class="profile-row-label">Password</span>
<button class="btn btn-secondary" onclick="showChangePassword()">Change Password</button>
</div>
</div>
<div class="profile-card">
<div class="profile-card-title">Commission Settings</div>
<div class="profile-row">
<span class="profile-row-label">Role</span>
<span class="profile-row-value" id="profileRole">-</span>
</div>
<div class="profile-row" id="profileQuotaRow">
<span class="profile-row-label" id="profileQuotaLabel">Quarterly Quota</span>
<span class="profile-row-value" id="profileQuota">-</span>
</div>
<div class="profile-row" id="profileStructureRow">
<span class="profile-row-label">Structure</span>
<span class="profile-row-value" id="profileStructure">-</span>
</div>
<div class="profile-row" id="profileRatesRow">
<span class="profile-row-label">Rates</span>
<span class="profile-row-value" id="profileRates" style="text-align:right;line-height:1.4">-</span>
</div>
<div class="profile-row" style="margin-top:0.5rem">
<span class="profile-row-label"></span>
<button class="btn btn-secondary" onclick="openCompSettings()">Edit Settings</button>
</div>
</div>
<div class="profile-card danger-zone">
<div class="profile-card-title">Danger Zone</div>
<div class="profile-row">
<span class="profile-row-label">Delete all your data and close your account</span>
<button class="btn btn-danger" onclick="deleteAccount()">Delete Account</button>
</div>
</div>
<button class="btn btn-secondary" onclick="hideProfile()" style="margin-top:1rem">‚Üê Back to Dashboard</button>
</div>
</div>
<div class="modal-overlay deal-modal" id="dealModal"><div class="modal"><div class="modal-header"><h2 id="dealModalTitle">Add Deal</h2><button class="modal-close" onclick="closeDeal()">√ó</button></div><div class="modal-body"><input type="hidden" id="editId">
<div class="form-group"><label class="form-label">Client Name</label><input type="text" class="form-input" id="dealName" placeholder="Acme Corp"></div>
<div class="form-row"><div class="form-group"><label class="form-label">Amount ($)</label><input type="number" class="form-input" id="dealAmt" placeholder="50000"></div><div class="form-group"><label class="form-label">Close Date</label><input type="date" class="form-input" id="dealDate"></div></div>
<div class="form-group"><label class="form-label">Contract Length</label><div class="toggle-group"><div class="toggle-opt y1 active" onclick="setTerm(1)">1 Year</div><div class="toggle-opt y2" onclick="setTerm(2)">2 Year</div></div><input type="hidden" id="dealTerm" value="1"></div>
<div class="form-group"><label class="form-label">Payment Status</label><div class="toggle-group"><div class="toggle-opt active" onclick="setPaid(false)" id="unpaidOpt">Unpaid</div><div class="toggle-opt" onclick="setPaid(true)" id="paidOpt">Paid</div></div><input type="hidden" id="dealPaid" value="false"></div>
</div><div style="padding:1.25rem 2rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:0.75rem"><button class="btn btn-secondary" onclick="closeDeal()">Cancel</button><button class="btn btn-primary" id="saveDealBtn" onclick="saveDeal()">Save Deal</button></div></div></div>
<div class="modal-overlay" id="importModal"><div class="modal" style="max-width:700px"><div class="modal-header"><h2>Import Deals from CSV</h2><button class="modal-close" onclick="closeImport()">√ó</button></div><div class="modal-body">
<div id="importStep1">
<p style="color:var(--text2);margin-bottom:1.5rem">Upload a CSV file with your deals. We'll match columns automatically or let you map them.</p>
<div style="background:var(--bg);border:2px dashed var(--border);border-radius:12px;padding:2rem;text-align:center;margin-bottom:1.5rem">
<div style="font-size:2rem;margin-bottom:0.5rem">üìÑ</div>
<div style="color:var(--text2);margin-bottom:1rem">Drop CSV here or click to browse</div>
<button class="btn btn-secondary" onclick="$('csvFileInput2').click()">Choose File</button>
<input type="file" id="csvFileInput2" accept=".csv" style="display:none" onchange="handleCSVUpload(event)">
</div>
<div style="background:var(--card2);border-radius:8px;padding:1rem;font-size:0.85rem;color:var(--text2)">
<strong style="color:var(--text)">Expected columns:</strong> Client/Name, Amount, Close Date, Term (1 or 2), Paid (Yes/No)<br>
<span style="color:var(--muted)">Dates can be YYYY-MM-DD, MM/DD/YYYY, or similar formats</span>
</div>
</div>
<div id="importStep2" class="hidden">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
<span style="color:var(--accent);font-weight:600" id="importCount">0 deals found</span>
<button class="btn btn-ghost" onclick="resetImport()" style="font-size:0.85rem">‚Üê Choose different file</button>
</div>
<div style="margin-bottom:1.5rem">
<div style="font-size:0.8rem;color:var(--muted);text-transform:uppercase;margin-bottom:0.75rem">Column Mapping</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem" id="columnMapping"></div>
</div>
<div style="max-height:250px;overflow-y:auto;border:1px solid var(--border);border-radius:8px">
<table style="font-size:0.85rem">
<thead><tr id="importPreviewHeader"></tr></thead>
<tbody id="importPreviewBody"></tbody>
</table>
</div>
<div style="margin-top:1rem;padding:1rem;background:var(--bg);border-radius:8px;display:flex;justify-content:space-between;align-items:center">
<div><span style="font-weight:600" id="validDealsCount">0</span> <span style="color:var(--text2)">valid deals ready to import</span></div>
<button class="btn btn-primary" onclick="confirmImport()" id="importBtn">Import Deals</button>
</div>
</div>
</div></div></div>
<div class="modal-overlay" id="hubspotModal"><div class="modal" style="max-width:500px"><div class="modal-header"><h2>Import from HubSpot</h2><button class="modal-close" onclick="closeHubSpot()">√ó</button></div><div class="modal-body">
<div id="hubspotNotConnected">
<p style="color:var(--text2);margin-bottom:1.5rem">Connect your HubSpot account to import closed-won deals automatically.</p>
<div style="background:var(--bg);border-radius:12px;padding:2rem;text-align:center;margin-bottom:1rem">
<div style="font-size:2.5rem;margin-bottom:1rem">üî∂</div>
<button class="btn btn-primary" onclick="connectHubSpot()" style="background:#ff7a59;border-color:#ff7a59">Connect HubSpot</button>
</div>
<p style="font-size:0.85rem;color:var(--muted);text-align:center">We only request read access to your deals.</p>
</div>
<div id="hubspotConnected" class="hidden">
<div style="background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.2);border-radius:12px;padding:1rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
<span style="color:var(--accent);font-size:1.25rem">‚úì</span>
<span style="color:var(--accent)">HubSpot connected</span>
<button class="btn btn-secondary" onclick="disconnectHubSpot()" style="margin-left:auto;font-size:0.8rem;padding:0.375rem 0.75rem">Disconnect</button>
</div>
<div class="form-group"><label class="form-label">Date Range</label>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
<div><label style="font-size:0.8rem;color:var(--muted)">From</label><input type="date" class="form-input" id="hubspotAfter"></div>
<div><label style="font-size:0.8rem;color:var(--muted)">To</label><input type="date" class="form-input" id="hubspotBefore"></div>
</div>
</div>
<div id="hubspotResults" class="hidden" style="margin:1rem 0;padding:1rem;background:var(--bg);border-radius:8px">
<div style="display:flex;justify-content:space-between;align-items:center">
<span><strong id="hubspotDealCount">0</strong> deals found</span>
<button class="btn btn-primary" onclick="importHubSpotDeals()" id="hubspotImportBtn">Import Selected</button>
</div>
<div id="hubspotDealsList" style="margin-top:1rem"></div>
</div>
<button class="btn btn-primary" onclick="fetchHubSpotDeals()" id="hubspotFetchBtn" style="width:100%">Fetch Deals</button>
</div>
</div></div></div>
<div class="modal-overlay" id="salesforceModal"><div class="modal" style="max-width:500px"><div class="modal-header"><h2>Import from Salesforce</h2><button class="modal-close" onclick="closeSalesforce()">√ó</button></div><div class="modal-body">
<div id="salesforceNotConnected">
<p style="color:var(--text2);margin-bottom:1.5rem">Connect your Salesforce account to import Closed Won opportunities automatically.</p>
<div style="display:flex;gap:0.75rem">
<button class="btn btn-primary" onclick="connectSalesforce()" style="background:#00a1e0;border-color:#00a1e0">Connect Salesforce</button>
<button class="btn btn-secondary" onclick="connectSalesforce(true)" style="font-size:0.85rem">Sandbox</button>
</div>
</div>
<div id="salesforceConnected" class="hidden">
<div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1.5rem;padding:1rem;background:var(--bg);border-radius:8px">
<span style="font-size:1.5rem">‚òÅÔ∏è</span>
<span style="color:var(--accent)">Salesforce connected</span>
<button class="btn btn-secondary" onclick="disconnectSalesforce()" style="margin-left:auto;font-size:0.8rem;padding:0.375rem 0.75rem">Disconnect</button>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
<div><label style="font-size:0.8rem;color:var(--muted)">From</label><input type="date" class="form-input" id="salesforceAfter"></div>
<div><label style="font-size:0.8rem;color:var(--muted)">To</label><input type="date" class="form-input" id="salesforceBefore"></div>
</div>
<div id="salesforceResults" class="hidden" style="margin:1rem 0;padding:1rem;background:var(--bg);border-radius:8px">
<div style="display:flex;justify-content:space-between;align-items:center">
<span><strong id="salesforceDealCount">0</strong> opportunities found</span>
<button class="btn btn-primary" onclick="importSalesforceDeals()" id="salesforceImportBtn">Import Selected</button>
</div>
<div id="salesforceDealsList" style="margin-top:1rem"></div>
</div>
<button class="btn btn-primary" onclick="fetchSalesforceDeals()" id="salesforceFetchBtn" style="width:100%">Fetch Opportunities</button>
</div>
</div></div></div>
<div class="modal-overlay" id="settingsModal"><div class="modal"><div class="modal-header"><h2>Settings</h2><button class="modal-close" onclick="closeSettings()">√ó</button></div><div class="modal-body">
<div class="form-group"><label class="form-label">Quarterly Goal ($)</label><input type="number" class="form-input" id="setGoal"></div>
<div class="form-group"><label class="form-label">Tier Thresholds (%)</label><div class="rate-grid"><div><div class="rate-label">T1</div><input type="number" class="form-input" value="0" disabled></div><div><div class="rate-label">T2</div><input type="number" class="form-input" id="setTh2"></div><div><div class="rate-label">T3</div><input type="number" class="form-input" id="setTh3"></div><div><div class="rate-label">T4</div><input type="number" class="form-input" id="setTh4"></div></div></div>
<div class="form-group"><label class="form-label">1 Year Rates (%)</label><div class="rate-grid"><input type="number" class="form-input" id="setR1a"><input type="number" class="form-input" id="setR1b"><input type="number" class="form-input" id="setR1c"><input type="number" class="form-input" id="setR1d"></div></div>
<div class="form-group"><label class="form-label">2 Year Rates (%)</label><div class="rate-grid"><input type="number" class="form-input" id="setR2a"><input type="number" class="form-input" id="setR2b"><input type="number" class="form-input" id="setR2c"><input type="number" class="form-input" id="setR2d"></div></div>
</div><div style="padding:1.25rem 2rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:0.75rem"><button class="btn btn-secondary" onclick="closeSettings()">Cancel</button><button class="btn btn-primary" onclick="saveSettings()">Save</button></div></div></div>
<div class="modal-overlay" id="passwordModal"><div class="modal"><div class="modal-header"><h2>Change Password</h2><button class="modal-close" onclick="hideChangePassword()">√ó</button></div><div class="modal-body">
<form onsubmit="changePassword(event)">
<div class="form-group"><label class="form-label">New Password</label><input type="password" class="form-input" id="newPassword" required minlength="6" placeholder="At least 6 characters"></div>
<div class="form-group"><label class="form-label">Confirm Password</label><input type="password" class="form-input" id="confirmPassword" required minlength="6" placeholder="Confirm new password"></div>
<div class="form-error" id="passwordError"></div>
<button type="submit" class="btn btn-primary btn-lg" style="width:100%;margin-top:0.5rem">Update Password</button>
</form>
</div></div></div>
<div class="toast-wrap" id="toasts"></div>
</div>
<script>
const SUPABASE_URL='https://yeecmrjkkujtsvrtatlg.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InllZWNtcmpra3VqdHN2cnRhdGxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMTA5MzMsImV4cCI6MjA4MDc4NjkzM30.bKr372_-0v2yVGkDFJ87ys5gxQN6qzS5smLLvPmrar0';
let sb,user=null,compPlan=null,deals=[],startingPoints={};
const $=id=>document.getElementById(id);
const fmt=n=>new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0,maximumFractionDigits:0}).format(n||0);

// Global click handlers - defined at top level
function drillToMonth(month){
  console.log('drillToMonth called:',month);
  const q=month<3?'Q1':month<6?'Q2':month<9?'Q3':'Q4';
  $('quarterSelect').value=q;
  setView('quarter');
  setTimeout(function(){
    $('monthFilter').value=String(month);
    if($('termFilter'))$('termFilter').value='all';
    if($('statusFilter'))$('statusFilter').value='all';
    render();
  },100);
}

function drillToQuarter(q){
  console.log('drillToQuarter called:',q);
  $('quarterSelect').value=q;
  setView('quarter');
  setTimeout(function(){
    $('monthFilter').value='all';
    if($('termFilter'))$('termFilter').value='all';
    if($('statusFilter'))$('statusFilter').value='all';
    render();
  },100);
}

function filterByMonth(m){
  console.log('filterByMonth called:',m);
  const mf=$('monthFilter');
  if(mf.value===String(m)){
    mf.value='all';
  }else{
    mf.value=String(m);
  }
  if($('termFilter'))$('termFilter').value='all';
  if($('statusFilter'))$('statusFilter').value='all';
  render();
}

function setupYearViewClicks(){
  // Month cards in grid
  document.querySelectorAll('[data-drill-month]').forEach(function(el){
    el.addEventListener('click',function(e){
      e.stopPropagation();
      var month=parseInt(this.getAttribute('data-drill-month'));
      console.log('Month clicked:',month);
      drillToMonth(month);
    });
  });
  // Quarter cards
  document.querySelectorAll('[data-drill-quarter]').forEach(function(el){
    el.addEventListener('click',function(e){
      e.stopPropagation();
      var q=this.getAttribute('data-drill-quarter');
      console.log('Quarter clicked:',q);
      drillToQuarter(q);
    });
  });
}

function setupSidebarClicks(){
  document.querySelectorAll('[data-filter-month]').forEach(function(el){
    el.addEventListener('click',function(e){
      e.stopPropagation();
      var month=parseInt(this.getAttribute('data-filter-month'));
      console.log('Sidebar month clicked:',month);
      filterByMonth(month);
    });
  });
  document.querySelectorAll('[data-filter-tier]').forEach(function(el){
    el.addEventListener('click',function(e){
      e.stopPropagation();
      var tier=this.getAttribute('data-filter-tier');
      console.log('Tier clicked:',tier);
      filterByTier(tier);
    });
  });
}
function filterByTier(tier){
  const tf=$('tierFilter');
  if(tf.value===tier){tf.value='all'}else{tf.value=tier}
  renderDeals();
  render();
}
function filterByStatus(status){
  const sf=$('statusFilter');
  if(sf.value===status){sf.value='all'}else{sf.value=status}
  renderDeals();
  updateStatusHighlight();
}
function updateStatusHighlight(){
  const sf=$('statusFilter').value;
  $('paidCommRow').style.background=sf==='paid'?'rgba(0,255,136,0.15)':'';
  $('paidCommRow').style.borderLeft=sf==='paid'?'3px solid var(--accent)':'';
  $('unpaidCommRow').style.background=sf==='unpaid'?'rgba(255,255,255,0.1)':'';
  $('unpaidCommRow').style.borderLeft=sf==='unpaid'?'3px solid var(--muted)':'';
}
function toast(m){const t=document.createElement('div');t.className='toast';t.textContent=m;$('toasts').appendChild(t);setTimeout(()=>t.remove(),3000)}
function toggleDropdown(id){const dd=$(id);const isOpen=dd.style.display==='block';closeDropdowns();if(!isOpen)dd.style.display='block'}
function closeDropdowns(){document.querySelectorAll('.dropdown-menu').forEach(d=>d.style.display='none')}
document.addEventListener('click',function(e){if(!e.target.closest('.dropdown'))closeDropdowns()})
function toggleMobileNav(){$('navLinks').classList.toggle('open')}
function closeMobileNav(){$('navLinks').classList.remove('open')}
function toggleFaq(el){el.parentElement.classList.toggle('open')}
let sortColumn='date',sortDir='desc';
function sortDeals(col){
  if(sortColumn===col){sortDir=sortDir==='asc'?'desc':'asc'}
  else{sortColumn=col;sortDir=col==='date'||col==='amount'||col==='commission'?'desc':'asc'}
  renderDeals();
}
let authMode='signup';
function showAuth(m){authMode=m;$('authModal').classList.add('active');$('authTitle').textContent=m==='signup'?'Create Account':'Welcome Back';$('authSubmit').textContent=m==='signup'?'Create Account':'Log In';$('authSwitch').innerHTML=m==='signup'?'Already have an account? <a onclick="toggleAuthMode()">Log in</a>':'Need an account? <a onclick="toggleAuthMode()">Sign up</a>';$('forgotLink').style.display=m==='login'?'block':'none';$('rememberGroup').style.display=m==='login'?'block':'none';$('authError').classList.remove('show')}
function hideAuth(){$('authModal').classList.remove('active')}
function toggleAuthMode(){showAuth(authMode==='signup'?'login':'signup')}
function showForgotPassword(){hideAuth();$('forgotModal').classList.add('active');$('resetEmail').value='';$('resetError').classList.remove('show')}
function hideForgotPassword(){$('forgotModal').classList.remove('active')}
async function sendResetEmail(e){e.preventDefault();const email=$('resetEmail').value;$('resetSubmit').disabled=true;$('resetSubmit').textContent='Sending...';$('resetError').classList.remove('show');try{const{error}=await sb.auth.resetPasswordForEmail(email,{redirectTo:'https://comish.online/'});if(error)throw error;hideForgotPassword();toast('Check your email for the reset link!')}catch(err){$('resetError').textContent=err.message;$('resetError').classList.add('show')}finally{$('resetSubmit').disabled=false;$('resetSubmit').textContent='Send Reset Link'}}
function showWaitlist(){$('waitlistModal').classList.add('active')}
function hideWaitlist(){$('waitlistModal').classList.remove('active')}
async function submitWaitlist(e){e.preventDefault();const email=$('waitlistEmail').value;const size=$('waitlistSize').value;try{await sb.from('waitlist').insert({email,team_size:size});toast('Thanks! We will notify you when Teams launches.');hideWaitlist()}catch(err){toast('Thanks! We will notify you at '+email);hideWaitlist()}}
async function handleAuth(e){e.preventDefault();const email=$('authEmail').value,pw=$('authPassword').value;$('authSubmit').disabled=true;$('authSubmit').textContent='Please wait...';$('authError').classList.remove('show');try{let r;if(authMode==='signup'){r=await sb.auth.signUp({email,password:pw});if(r.data?.user&&!r.data?.session){hideAuth();toast('Check your email to confirm your account!');return}}else{r=await sb.auth.signInWithPassword({email,password:pw})}if(r.error)throw r.error;hideAuth()}catch(e){$('authError').textContent=e.message;$('authError').classList.add('show')}finally{$('authSubmit').disabled=false;$('authSubmit').textContent=authMode==='signup'?'Create Account':'Log In'}}
async function logout(){await sb.auth.signOut();user=null;compPlan=null;deals=[];userProfile=null;window.sdrPlan=null;sdrActivities=[];$('app').style.display='none';$('landing').style.display='block';$('dashboard').classList.add('hidden');$('sdrDashboard').classList.add('hidden');$('profilePage').classList.add('hidden');$('onboarding').classList.add('hidden');$('feedbackBtn').classList.add('hidden');$('trialExpiredModal').classList.add('hidden');history.pushState(null,'','/')}
let onboardStep=1;
let selectedRole='';
let selectedStructure='tiered';
function showOnboarding(){$('onboarding').classList.remove('hidden');$('dashboard').classList.add('hidden');$('sdrDashboard')?.classList.add('hidden');onboardStep=1;selectedRole='';selectedStructure='tiered';$('obRole').value='';$('obStructure').value='tiered';updateOnboardUI()}
function selectRole(role){selectedRole=role;$('obRole').value=role;document.querySelectorAll('.role-card').forEach(c=>c.style.borderColor='var(--border)');$(role==='ae'?'roleAE':'roleSDR').style.borderColor='var(--accent)'}
function selectStructure(s){selectedStructure=s;$('obStructure').value=s;$('structTiered').style.borderColor=s==='tiered'?'var(--accent)':'var(--border)';$('structFlat').style.borderColor=s==='flat'?'var(--accent)':'var(--border)'}
function setPeriod(p){$('obPeriod').value=p;$('periodMonthly').style.borderColor=p==='monthly'?'var(--accent)':'var(--border)';$('periodMonthly').style.background=p==='monthly'?'rgba(0,255,136,0.1)':'transparent';$('periodMonthly').style.color=p==='monthly'?'var(--accent)':'var(--text2)';$('periodQuarterly').style.borderColor=p==='quarterly'?'var(--accent)':'var(--border)';$('periodQuarterly').style.background=p==='quarterly'?'rgba(0,255,136,0.1)':'transparent';$('periodQuarterly').style.color=p==='quarterly'?'var(--accent)':'var(--text2)'}
function updateOnboardUI(){const isSDR=selectedRole==='sdr';const isFlat=selectedStructure==='flat';const maxStep=isSDR?4:5;for(let i=1;i<=5;i++){const stepEl=$(`ob-step-${i}`);const contentEl=$(`ob-content-${i}`);if(stepEl)stepEl.className='step'+(i<onboardStep?' done':i===onboardStep?' active':'')+(i>maxStep?' hidden':'');if(contentEl)contentEl.classList.toggle('hidden',i!==onboardStep)}$('obBack').style.visibility=onboardStep===1?'hidden':'visible';$('obNext').textContent=onboardStep===maxStep?'Finish Setup':'Continue';if(onboardStep===1){$('onboardTitle').textContent="What's your role?";$('onboardDesc').textContent="We'll customize your commission tracking"}else if(onboardStep===2){$('ae-step2').classList.toggle('hidden',isSDR);$('sdr-step2').classList.toggle('hidden',!isSDR);$('onboardTitle').textContent=isSDR?'Set Your Activity Quota':'Commission Structure';$('onboardDesc').textContent=isSDR?'How many activities per period?':'How do you get paid?'}else if(onboardStep===3){$('ae-step3').classList.toggle('hidden',isSDR);$('sdr-step3').classList.toggle('hidden',!isSDR);$('onboardTitle').textContent=isSDR?'Activity Types':'Set Your Quarterly Goal';$('onboardDesc').textContent=isSDR?'What do you get paid for?':'What is your quota for the quarter?'}else if(onboardStep===4){if(isSDR){$('ae-step4-tiered').classList.add('hidden');$('ae-step4-flat').classList.add('hidden');$('sdr-step4').classList.remove('hidden');$('onboardTitle').textContent='Set Your Rates';$('onboardDesc').textContent='How much do you earn per activity?';$('meetingRateGroup').style.display=$('payMeeting').checked?'block':'none';$('sqlRateGroup').style.display=$('paySQL').checked?'block':'none';$('showRateGroup').style.display=$('payShow').checked?'block':'none'}else{$('sdr-step4').classList.add('hidden');$('ae-step4-tiered').classList.toggle('hidden',isFlat);$('ae-step4-flat').classList.toggle('hidden',!isFlat);$('onboardTitle').textContent=isFlat?'Almost Done':'Configure Tier Thresholds';$('onboardDesc').textContent=isFlat?'One more step to set your rate':'At what % of goal do you hit each tier?'}}else if(onboardStep===5){$('ae-step5-tiered').classList.toggle('hidden',isFlat);$('ae-step5-flat').classList.toggle('hidden',!isFlat);$('onboardTitle').textContent='Set Commission Rates';$('onboardDesc').textContent=isFlat?'Your commission percentage on all deals':'What % do you earn at each tier?'}}
function onboardBack(){if(onboardStep>1){onboardStep--;updateOnboardUI()}}
async function onboardNext(){const isSDR=selectedRole==='sdr';const maxStep=isSDR?4:5;if(onboardStep===1&&!selectedRole){toast('Please select your role');return}if(onboardStep<maxStep){onboardStep++;updateOnboardUI()}else{$('obNext').disabled=true;$('obNext').textContent='Saving...';try{if(selectedRole==='ae'){const isFlat=selectedStructure==='flat';let plan;if(isFlat){plan={user_id:user.id,role:'ae',structure:'flat',quarterly_goal:parseFloat($('obGoal').value)||375000,tiers:JSON.stringify([0,100,125,150]),rates_1yr:JSON.stringify([parseFloat($('obFlatRate1').value)||8,parseFloat($('obFlatRate1').value)||8,parseFloat($('obFlatRate1').value)||8,parseFloat($('obFlatRate1').value)||8]),rates_2yr:JSON.stringify([parseFloat($('obFlatRate2').value)||10,parseFloat($('obFlatRate2').value)||10,parseFloat($('obFlatRate2').value)||10,parseFloat($('obFlatRate2').value)||10]),flat_rate_1yr:parseFloat($('obFlatRate1').value)||8,flat_rate_2yr:parseFloat($('obFlatRate2').value)||10}}else{plan={user_id:user.id,role:'ae',structure:'tiered',quarterly_goal:parseFloat($('obGoal').value)||375000,tiers:JSON.stringify([0,parseFloat($('obTh2').value)||100,parseFloat($('obTh3').value)||125,parseFloat($('obTh4').value)||150]),rates_1yr:JSON.stringify([parseFloat($('obR1a').value)||6,parseFloat($('obR1b').value)||8,parseFloat($('obR1c').value)||10,parseFloat($('obR1d').value)||12]),rates_2yr:JSON.stringify([parseFloat($('obR2a').value)||8,parseFloat($('obR2b').value)||10,parseFloat($('obR2c').value)||12,parseFloat($('obR2d').value)||14])}}const{data,error}=await sb.from('comp_plans').insert(plan).select().single();if(error){console.error('Comp plan error:',error);toast('Error saving plan: '+error.message);return}compPlan=data;compPlan.tiers=JSON.parse(compPlan.tiers);compPlan.rates_1yr=JSON.parse(compPlan.rates_1yr);compPlan.rates_2yr=JSON.parse(compPlan.rates_2yr)}else{const sdrPlan={user_id:user.id,role:'sdr',quota_period:$('obPeriod').value,activity_quota:parseFloat($('obActivityQuota').value)||15,pay_meeting:$('payMeeting').checked,pay_sql:$('paySQL').checked,pay_show:$('payShow').checked,meeting_rate:parseFloat($('obMeetingRate').value)||75,sql_rate:parseFloat($('obSQLRate').value)||150,show_rate:parseFloat($('obShowRate').value)||25};const{data,error}=await sb.from('sdr_plans').insert(sdrPlan).select().single();if(error){console.error('SDR plan error:',error);toast('Error saving plan: '+error.message);return}sdrPlan.id=data.id;window.sdrPlan=data}const{error:profileError}=await sb.from('profiles').update({onboarded:true,role:selectedRole}).eq('id',user.id);if(profileError){console.error('Profile update error:',profileError)}if(selectedRole==='ae'){showDashboard()}else{showSDRDashboard()}toast('Setup complete!')}finally{$('obNext').disabled=false;$('obNext').textContent='Finish Setup'}}}
function showDashboard(){$('onboarding').classList.add('hidden');$('dashboard').classList.remove('hidden');$('sdrDashboard').classList.add('hidden');$('profilePage').classList.add('hidden');$('feedbackBtn').classList.remove('hidden');$('userEmail').textContent=user.email;initYear();$('quarterSelect').value=curQ();render();checkTrialStatus();history.pushState(null,'','/dashboard')}
function showSDRDashboard(){$('onboarding').classList.add('hidden');$('dashboard').classList.add('hidden');$('sdrDashboard').classList.remove('hidden');$('profilePage').classList.add('hidden');$('feedbackBtn').classList.remove('hidden');$('sdrUserEmail').textContent=user.email;initSDRMonths();renderSDR();checkTrialStatus();history.pushState(null,'','/dashboard')}
let sdrActivities=[];
function initSDRMonths(){const sel=$('sdrMonthSelect');sel.innerHTML='';const now=new Date();for(let i=0;i<6;i++){const d=new Date(now.getFullYear(),now.getMonth()-i,1);const val=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;const label=d.toLocaleDateString('en-US',{month:'long',year:'numeric'});sel.innerHTML+=`<option value="${val}">${label}</option>`}}
function renderSDR(){const plan=window.sdrPlan;if(!plan)return;const period=$('sdrMonthSelect').value;const[year,month]=period.split('-').map(Number);const activities=sdrActivities.filter(a=>{const d=new Date(a.activity_date);return d.getFullYear()===year&&d.getMonth()+1===month});const meetings=activities.filter(a=>a.type==='meeting');const sqls=activities.filter(a=>a.type==='sql');const shows=activities.filter(a=>a.type==='show');const meetingPay=meetings.length*(plan.meeting_rate||75);const sqlPay=sqls.length*(plan.sql_rate||150);const showPay=shows.length*(plan.show_rate||25);const total=meetingPay+sqlPay+showPay;const quota=plan.activity_quota||15;const completed=meetings.length;const pct=Math.round((completed/quota)*100);$('sdrQuota').textContent=quota;$('sdrPeriodLabel').textContent=plan.quota_period==='quarterly'?'meetings this quarter':'meetings this month';$('sdrCompleted').textContent=completed;$('sdrCompletedPct').textContent=pct+'% of quota';$('sdrToQuota').textContent=Math.max(0,quota-completed);$('sdrEarnings').textContent='$'+total.toLocaleString();$('sdrDoneCount').textContent=completed;$('sdrLeftCount').textContent=Math.max(0,quota-completed);$('sdrProgressBar').style.width=Math.min(175,pct)+'%';$('meetingEarnings').textContent='$'+meetingPay.toLocaleString();$('meetingCount').textContent=meetings.length;if(plan.pay_sql){$('sqlEarningsRow').style.display='flex';$('sqlCountRow').style.display='flex';$('sqlEarnings').textContent='$'+sqlPay.toLocaleString();$('sqlCount').textContent=sqls.length}if(plan.pay_show){$('showEarningsRow').style.display='flex';$('showCountRow').style.display='flex';$('showEarnings').textContent='$'+showPay.toLocaleString();$('showCount').textContent=shows.length}$('sdrTotalEarnings').textContent='$'+total.toLocaleString();renderSDRActivities()}
function renderSDRActivities(){const filter=$('sdrActivityFilter').value;const period=$('sdrMonthSelect').value;const[year,month]=period.split('-').map(Number);let list=sdrActivities.filter(a=>{const d=new Date(a.activity_date);return d.getFullYear()===year&&d.getMonth()+1===month});if(filter!=='all')list=list.filter(a=>a.type===filter);const body=$('sdrActivitiesBody');if(!list.length){body.innerHTML='';$('emptyActivities').style.display='block';return}$('emptyActivities').style.display='none';body.innerHTML=list.sort((a,b)=>new Date(b.activity_date)-new Date(a.activity_date)).map(a=>`<tr><td>${a.type==='meeting'?'üìÖ Meeting':a.type==='sql'?'üéØ SQL':'‚úÖ Show'}</td><td>${a.description||'-'}</td><td>${new Date(a.activity_date).toLocaleDateString()}</td><td class="green">$${a.payout}</td><td><button class="btn btn-ghost" onclick="deleteActivity('${a.id}')">üóëÔ∏è</button></td></tr>`).join('')}
function openActivity(){$('activityModal').classList.add('active');$('activityDesc').value='';$('activityDate').value=new Date().toISOString().split('T')[0];updateActivityForm()}
function closeActivity(){$('activityModal').classList.remove('active')}
function updateActivityForm(){const type=$('activityType').value;const plan=window.sdrPlan||{};let rate=75;if(type==='meeting')rate=plan.meeting_rate||75;else if(type==='sql')rate=plan.sql_rate||150;else if(type==='show')rate=plan.show_rate||25;$('activityPayout').textContent='$'+rate}
async function saveActivity(){const type=$('activityType').value;const desc=$('activityDesc').value;const date=$('activityDate').value;const plan=window.sdrPlan||{};let payout=75;if(type==='meeting')payout=plan.meeting_rate||75;else if(type==='sql')payout=plan.sql_rate||150;else if(type==='show')payout=plan.show_rate||25;const{data,error}=await sb.from('sdr_activities').insert({user_id:user.id,type,description:desc,activity_date:date,payout}).select().single();if(error){toast('Error: '+error.message);return}sdrActivities.push(data);closeActivity();renderSDR();toast('Activity logged!')}
async function deleteActivity(id){if(!confirm('Delete this activity?'))return;await sb.from('sdr_activities').delete().eq('id',id);sdrActivities=sdrActivities.filter(a=>a.id!==id);renderSDR();toast('Activity deleted')}
function openSDRSettings(){const plan=window.sdrPlan||{};$('sdrSetQuota').value=plan.activity_quota||15;$('sdrSetMeetingRate').value=plan.meeting_rate||75;$('sdrSetSQLRate').value=plan.sql_rate||150;$('sdrSetShowRate').value=plan.show_rate||25;setSDRPeriod(plan.quota_period||'monthly');$('sdrSettingsModal').classList.add('active')}
function closeSDRSettings(){$('sdrSettingsModal').classList.remove('active')}
function setSDRPeriod(p){$('sdrSetMonthly').style.borderColor=p==='monthly'?'var(--accent)':'var(--border)';$('sdrSetMonthly').style.background=p==='monthly'?'rgba(0,255,136,0.1)':'transparent';$('sdrSetMonthly').style.color=p==='monthly'?'var(--accent)':'var(--text2)';$('sdrSetQuarterly').style.borderColor=p==='quarterly'?'var(--accent)':'var(--border)';$('sdrSetQuarterly').style.background=p==='quarterly'?'rgba(0,255,136,0.1)':'transparent';$('sdrSetQuarterly').style.color=p==='quarterly'?'var(--accent)':'var(--text2)';window.sdrSettingsPeriod=p}
async function saveSDRSettings(){const updates={quota_period:window.sdrSettingsPeriod||'monthly',activity_quota:parseFloat($('sdrSetQuota').value)||15,meeting_rate:parseFloat($('sdrSetMeetingRate').value)||75,sql_rate:parseFloat($('sdrSetSQLRate').value)||150,show_rate:parseFloat($('sdrSetShowRate').value)||25};const{error}=await sb.from('sdr_plans').update(updates).eq('id',window.sdrPlan.id);if(error){toast('Error: '+error.message);return}Object.assign(window.sdrPlan,updates);closeSDRSettings();renderSDR();toast('Settings saved!')}
async function checkTrialStatus(){const{data:profile}=await sb.from('profiles').select('subscription_status,trial_ends_at').eq('id',user.id).single();if(!profile)return;userProfile=profile;const status=profile.subscription_status||'trial';if(status==='active')return;const trialEnd=profile.trial_ends_at?new Date(profile.trial_ends_at):null;const now=new Date();if(trialEnd&&now>trialEnd){$('trialExpiredModal').classList.remove('hidden')}}
let currentView='quarter';
function setView(v){currentView=v;document.querySelectorAll('.view-toggle button').forEach(b=>b.classList.remove('active'));document.querySelector(`.view-toggle button:${v==='quarter'?'first':'last'}-child`).classList.add('active');$('quarterView').classList.toggle('hidden',v!=='quarter');$('yearView').classList.toggle('hidden',v!=='year');$('quarterSelect').style.display=v==='quarter'?'block':'none';if(v==='year')renderYearView()}
function renderYearView(){const y=+$('yearSelect').value;const yearDeals=deals.filter(d=>d.close_date&&getY(d.close_date)===y);const months=[0,1,2,3,4,5,6,7,8,9,10,11];const monthData=months.map(m=>{const mDeals=yearDeals.filter(d=>getM(d.close_date)===m);const rev=mDeals.reduce((s,d)=>s+d.amount,0);const comm=calcMonthComm(mDeals,m,y);return{month:m,deals:mDeals.length,revenue:rev,commission:comm}});const totalRev=monthData.reduce((s,m)=>s+m.revenue,0);const totalComm=monthData.reduce((s,m)=>s+m.commission,0);const totalDeals=monthData.reduce((s,m)=>s+m.deals,0);const bestMonth=monthData.reduce((best,m)=>m.revenue>best.revenue?m:best,{revenue:0});const avgRev=totalRev/12;$('yearlySummary').innerHTML=`<div class="yearly-card highlight"><div class="yearly-card-label">Total Revenue</div><div class="yearly-card-value">${fmt(totalRev)}</div><div class="yearly-card-sub">${totalDeals} deals closed</div></div><div class="yearly-card highlight"><div class="yearly-card-label">Total Commission</div><div class="yearly-card-value green">${fmt(totalComm)}</div><div class="yearly-card-sub">YTD earnings</div></div><div class="yearly-card"><div class="yearly-card-label">Monthly Average</div><div class="yearly-card-value">${fmt(avgRev)}</div><div class="yearly-card-sub">revenue per month</div></div><div class="yearly-card"><div class="yearly-card-label">Best Month</div><div class="yearly-card-value">${bestMonth.revenue>0?mName(bestMonth.month):'N/A'}</div><div class="yearly-card-sub">${bestMonth.revenue>0?fmt(bestMonth.revenue):''}</div></div>`;const maxRev=Math.max(...monthData.map(m=>m.revenue),1);const maxComm=Math.max(...monthData.map(m=>m.commission),1);$('barChart').innerHTML=monthData.map(m=>`<div class="bar-group" data-drill-month="${m.month}" style="cursor:pointer" title="Click to view ${mName(m.month)} deals"><div class="bar-container"><div class="bar revenue" style="height:${(m.revenue/maxRev)*100}%"><div class="bar-tooltip">${fmt(m.revenue)}</div></div><div class="bar commission" style="height:${(m.commission/maxComm)*100}%"><div class="bar-tooltip">${fmt(m.commission)}</div></div></div><div class="bar-label">${mName(m.month).slice(0,3)}</div></div>`).join('');const quarters=['Q1','Q2','Q3','Q4'];const qData=quarters.map((q,i)=>{const qMonths=[i*3,i*3+1,i*3+2];const qDeals=yearDeals.filter(d=>qMonths.includes(getM(d.close_date)));const rev=qDeals.reduce((s,d)=>s+d.amount,0);const sp=startingPoints[y+'-'+q]||0;const comm=calcComm(qDeals,sp).total;return{q,revenue:rev,commission:comm,deals:qDeals.length}});const curQuarter=curQ();$('quarterCompare').innerHTML=qData.map(qd=>`<div class="quarter-card ${qd.q===curQuarter?'active':''}" data-drill-quarter="${qd.q}" style="cursor:pointer" title="Click to view ${qd.q} details"><div class="quarter-name">${qd.q} ${y}</div><div class="quarter-revenue">${fmt(qd.revenue)}</div><div class="quarter-commission">${fmt(qd.commission)}</div><div class="quarter-deals">${qd.deals} deals</div></div>`).join('');const curMonth=curM();$('monthlyGrid').innerHTML=monthData.map(m=>`<div class="month-card ${m.month===curMonth&&y===curY()?'current':''}" data-drill-month="${m.month}" style="cursor:pointer" title="Click to view deals"><div class="month-card-header"><span class="month-name">${mName(m.month)}</span>${m.month===curMonth&&y===curY()?'<span class="month-badge">Current</span>':''}</div><div class="month-stat"><span class="month-stat-label">Revenue</span><span class="month-stat-value">${fmt(m.revenue)}</span></div><div class="month-stat"><span class="month-stat-label">Commission</span><span class="month-stat-value green">${fmt(m.commission)}</span></div><div class="month-stat"><span class="month-stat-label">Deals</span><span class="month-stat-value">${m.deals}</span></div></div>`).join('');setupYearViewClicks()}
function calcMonthComm(mDeals,month,year){
  // Calculate commission for this month's deals based on their position in the quarter
  const q=month<3?'Q1':month<6?'Q2':month<9?'Q3':'Q4';
  const y=year;
  const sp=startingPoints[y+'-'+q]||0;
  
  // Get all paid deals in this quarter up to and including this month
  const allQDeals=deals.filter(d=>d.close_date&&d.paid&&getY(d.close_date)===y&&getQ(d.close_date)===q);
  const dealsBeforeMonth=allQDeals.filter(d=>getM(d.close_date)<month);
  const dealsInMonth=mDeals.filter(d=>d.paid);
  
  // Commission = (commission with this month) - (commission without this month)
  const commBefore=calcComm(dealsBeforeMonth,sp).total;
  const commAfter=calcComm([...dealsBeforeMonth,...dealsInMonth],sp).total;
  return commAfter-commBefore;
}
function calcCommAtRev(rev){if(!compPlan)return 0;if(compPlan.structure==='flat'){const avgR=((compPlan.flat_rate_1yr||compPlan.rates_1yr?.[0]||8)+(compPlan.flat_rate_2yr||compPlan.rates_2yr?.[0]||10))/2;return rev*avgR/100}const goal=compPlan.quarterly_goal,tiers=compPlan.tiers,r1=compPlan.rates_1yr,r2=compPlan.rates_2yr;let comm=0;for(let i=0;i<tiers.length;i++){const tS=tiers[i]/100*goal,tE=i<tiers.length-1?tiers[i+1]/100*goal:Infinity;const revIn=Math.max(0,Math.min(rev,tE)-tS);if(revIn<=0)continue;const avgR=(r1[i]+r2[i])/2;comm+=revIn*avgR/100}return comm}
let userProfile=null;
function showProfile(){$('dashboard').classList.add('hidden');$('sdrDashboard').classList.add('hidden');$('profilePage').classList.remove('hidden');$('profileEmail').textContent=user.email;$('profileUserEmail').textContent=user.email;const role=userProfile?.role||'ae';$('profileRole').textContent=role==='sdr'?'SDR / BDR':'AE / Closer';if(role==='sdr'){const plan=window.sdrPlan||{};$('profileQuotaLabel').textContent=plan.quota_period==='quarterly'?'Quarterly Quota':'Monthly Quota';$('profileQuota').textContent=(plan.activity_quota||15)+' activities';$('profileStructureRow').style.display='none';$('profileRatesRow').style.display='flex';$('profileRates').innerHTML=`$${plan.meeting_rate||75}/meeting`+(plan.pay_sql?`<br>$${plan.sql_rate||150}/SQL`:'')+(plan.pay_show?`<br>$${plan.show_rate||25}/show`:'')}else{$('profileQuotaLabel').textContent='Quarterly Quota';$('profileQuota').textContent='$'+(compPlan?.quarterly_goal||375000).toLocaleString();const struct=compPlan?.structure||'tiered';$('profileStructureRow').style.display='flex';$('profileRatesRow').style.display='flex';$('profileStructure').textContent=struct==='flat'?'Flat Rate':'Tiered (Accelerators)';if(struct==='flat'){const r1=compPlan?.flat_rate_1yr||compPlan?.rates_1yr?.[0]||8;const r2=compPlan?.flat_rate_2yr||compPlan?.rates_2yr?.[0]||10;$('profileRates').innerHTML=`${r1}% on 1yr deals<br>${r2}% on 2yr deals`}else{const r1=compPlan?.rates_1yr||[6,8,10,12];const r2=compPlan?.rates_2yr||[8,10,12,14];$('profileRates').innerHTML=`1yr: ${r1[0]}% ‚Üí ${r1[1]}% ‚Üí ${r1[2]}% ‚Üí ${r1[3]}%<br>2yr: ${r2[0]}% ‚Üí ${r2[1]}% ‚Üí ${r2[2]}% ‚Üí ${r2[3]}%`}}updateSubscriptionUI()}
function hideProfile(){$('profilePage').classList.add('hidden');if(userProfile?.role==='sdr'){showSDRDashboard()}else{showDashboard()}}
let compSettingsRole='ae';let compSettingsPeriod='monthly';let compSettingsStructure='tiered';
function openCompSettings(){const role=userProfile?.role||'ae';compSettingsRole=role;setCompRole(role);if(role==='ae'&&compPlan){compSettingsStructure=compPlan.structure||'tiered';setCompStructure(compSettingsStructure);$('compQuota').value=compPlan.quarterly_goal||375000;$('compTh2').value=compPlan.tiers?.[1]||100;$('compTh3').value=compPlan.tiers?.[2]||125;$('compTh4').value=compPlan.tiers?.[3]||150;$('compR1a').value=compPlan.rates_1yr?.[0]||6;$('compR1b').value=compPlan.rates_1yr?.[1]||8;$('compR1c').value=compPlan.rates_1yr?.[2]||10;$('compR1d').value=compPlan.rates_1yr?.[3]||12;$('compR2a').value=compPlan.rates_2yr?.[0]||8;$('compR2b').value=compPlan.rates_2yr?.[1]||10;$('compR2c').value=compPlan.rates_2yr?.[2]||12;$('compR2d').value=compPlan.rates_2yr?.[3]||14;$('compFlatRate1').value=compPlan.flat_rate_1yr||compPlan.rates_1yr?.[0]||8;$('compFlatRate2').value=compPlan.flat_rate_2yr||compPlan.rates_2yr?.[0]||10}else if(role==='ae'){compSettingsStructure='tiered';setCompStructure('tiered')}if(role==='sdr'&&window.sdrPlan){const plan=window.sdrPlan;compSettingsPeriod=plan.quota_period||'monthly';setCompPeriod(compSettingsPeriod);$('compActivityQuota').value=plan.activity_quota||15;$('compMeetingRate').value=plan.meeting_rate||75;$('compSQLRate').value=plan.sql_rate||150;$('compShowRate').value=plan.show_rate||25}updatePlanSummary();$('compSettingsModal').classList.add('active')}
function closeCompSettings(){$('compSettingsModal').classList.remove('active')}
function updatePlanSummary(){let summary='';if(compSettingsRole==='ae'&&compPlan){const struct=compPlan.structure||'tiered';const quota=compPlan.quarterly_goal||375000;if(struct==='flat'){const r1=compPlan.flat_rate_1yr||compPlan.rates_1yr?.[0]||8;const r2=compPlan.flat_rate_2yr||compPlan.rates_2yr?.[0]||10;summary=`<strong>Flat Rate</strong> ‚Äî ${r1}% on 1yr, ${r2}% on 2yr deals<br><span style="color:var(--muted)">Quota: $${quota.toLocaleString()}/quarter</span>`}else{const r=compPlan.rates_1yr||[6,8,10,12];summary=`<strong>Tiered</strong> ‚Äî ${r[0]}% ‚Üí ${r[1]}% ‚Üí ${r[2]}% ‚Üí ${r[3]}%<br><span style="color:var(--muted)">Quota: $${quota.toLocaleString()}/quarter</span>`}}else if(compSettingsRole==='sdr'&&window.sdrPlan){const plan=window.sdrPlan;summary=`<strong>$${plan.meeting_rate||75}/meeting</strong><br><span style="color:var(--muted)">${plan.activity_quota||15} activities ${plan.quota_period==='quarterly'?'per quarter':'per month'}</span>`}else{summary='<span style="color:var(--muted)">No plan configured yet</span>'}$('planSummaryText').innerHTML=summary}
function setCompRole(r){compSettingsRole=r;$('compRoleAE').style.border=r==='ae'?'1px solid var(--accent)':'1px solid var(--border)';$('compRoleAE').style.background=r==='ae'?'rgba(0,255,136,0.1)':'transparent';$('compRoleAE').style.color=r==='ae'?'var(--accent)':'var(--text2)';$('compRoleSDR').style.border=r==='sdr'?'1px solid var(--accent)':'1px solid var(--border)';$('compRoleSDR').style.background=r==='sdr'?'rgba(0,255,136,0.1)':'transparent';$('compRoleSDR').style.color=r==='sdr'?'var(--accent)':'var(--text2)';$('aeSettingsFields').style.display=r==='ae'?'block':'none';$('sdrSettingsFields').style.display=r==='sdr'?'block':'none'}
function setCompStructure(s){compSettingsStructure=s;$('compStructTiered').style.border=s==='tiered'?'1px solid var(--accent)':'1px solid var(--border)';$('compStructTiered').style.background=s==='tiered'?'rgba(0,255,136,0.1)':'transparent';$('compStructTiered').style.color=s==='tiered'?'var(--accent)':'var(--text2)';$('compStructFlat').style.border=s==='flat'?'1px solid var(--accent)':'1px solid var(--border)';$('compStructFlat').style.background=s==='flat'?'rgba(0,255,136,0.1)':'transparent';$('compStructFlat').style.color=s==='flat'?'var(--accent)':'var(--text2)';$('tieredSettingsFields').style.display=s==='tiered'?'block':'none';$('flatSettingsFields').style.display=s==='flat'?'block':'none';$('structureExplainer').innerHTML=s==='tiered'?'<strong>Tiered:</strong> Your rate increases as you hit quota milestones. Example: 6% until 100% quota, then 8% from 100-125%, then 10% above 125%.':'<strong>Flat Rate:</strong> Same commission % on every deal regardless of quota attainment. Simpler to track, common in SMB and high-velocity sales.'}
function setCompPeriod(p){compSettingsPeriod=p;$('compMonthly').style.border=p==='monthly'?'1px solid var(--accent)':'1px solid var(--border)';$('compMonthly').style.background=p==='monthly'?'rgba(0,255,136,0.1)':'transparent';$('compMonthly').style.color=p==='monthly'?'var(--accent)':'var(--text2)';$('compQuarterly').style.border=p==='quarterly'?'1px solid var(--accent)':'1px solid var(--border)';$('compQuarterly').style.background=p==='quarterly'?'rgba(0,255,136,0.1)':'transparent';$('compQuarterly').style.color=p==='quarterly'?'var(--accent)':'var(--text2)'}
async function saveCompSettings(){const oldRole=userProfile?.role||'ae';const newRole=compSettingsRole;if(newRole==='ae'){const isFlat=compSettingsStructure==='flat';let updates;if(isFlat){const flatR1=parseFloat($('compFlatRate1').value)||8;const flatR2=parseFloat($('compFlatRate2').value)||10;updates={structure:'flat',quarterly_goal:parseFloat($('compQuota').value)||375000,tiers:JSON.stringify([0,100,125,150]),rates_1yr:JSON.stringify([flatR1,flatR1,flatR1,flatR1]),rates_2yr:JSON.stringify([flatR2,flatR2,flatR2,flatR2]),flat_rate_1yr:flatR1,flat_rate_2yr:flatR2}}else{updates={structure:'tiered',quarterly_goal:parseFloat($('compQuota').value)||375000,tiers:JSON.stringify([0,parseFloat($('compTh2').value)||100,parseFloat($('compTh3').value)||125,parseFloat($('compTh4').value)||150]),rates_1yr:JSON.stringify([parseFloat($('compR1a').value)||6,parseFloat($('compR1b').value)||8,parseFloat($('compR1c').value)||10,parseFloat($('compR1d').value)||12]),rates_2yr:JSON.stringify([parseFloat($('compR2a').value)||8,parseFloat($('compR2b').value)||10,parseFloat($('compR2c').value)||12,parseFloat($('compR2d').value)||14])}}if(oldRole==='ae'&&compPlan){await sb.from('comp_plans').update(updates).eq('id',compPlan.id);Object.assign(compPlan,{...updates,tiers:JSON.parse(updates.tiers),rates_1yr:JSON.parse(updates.rates_1yr),rates_2yr:JSON.parse(updates.rates_2yr)})}else{updates.user_id=user.id;updates.role='ae';const{data}=await sb.from('comp_plans').insert(updates).select().single();compPlan=data;compPlan.tiers=JSON.parse(compPlan.tiers);compPlan.rates_1yr=JSON.parse(compPlan.rates_1yr);compPlan.rates_2yr=JSON.parse(compPlan.rates_2yr)}}else{const updates={quota_period:compSettingsPeriod,activity_quota:parseFloat($('compActivityQuota').value)||15,meeting_rate:parseFloat($('compMeetingRate').value)||75,sql_rate:parseFloat($('compSQLRate').value)||150,show_rate:parseFloat($('compShowRate').value)||25};if(oldRole==='sdr'&&window.sdrPlan){await sb.from('sdr_plans').update(updates).eq('id',window.sdrPlan.id);Object.assign(window.sdrPlan,updates)}else{updates.user_id=user.id;updates.role='sdr';const{data}=await sb.from('sdr_plans').insert(updates).select().single();window.sdrPlan=data}}if(oldRole!==newRole){await sb.from('profiles').update({role:newRole}).eq('id',user.id);userProfile.role=newRole}closeCompSettings();showProfile();toast('Settings saved!')}
async function updateSubscriptionUI(){if(!userProfile){const{data}=await sb.from('profiles').select('*').eq('id',user.id).single();userProfile=data}const status=userProfile?.subscription_status||'trial';const trialEnd=userProfile?.trial_ends_at?new Date(userProfile.trial_ends_at):new Date(Date.now()+14*24*60*60*1000);const now=new Date();const daysLeft=Math.max(0,Math.ceil((trialEnd-now)/(1000*60*60*24)));const statusEl=$('subStatus');const trialBanner=$('trialBanner');const renewalRow=$('renewalRow');const manageRow=$('manageSubRow');if(status==='active'){statusEl.textContent='Active';statusEl.className='subscription-badge active';trialBanner.style.display='none';renewalRow.style.display='flex';manageRow.style.display='flex';$('renewalDate').textContent=userProfile.current_period_end?new Date(userProfile.current_period_end).toLocaleDateString():'‚Äî'}else if(status==='canceled'){statusEl.textContent='Canceled';statusEl.className='subscription-badge expired';trialBanner.style.display='none';renewalRow.style.display='none';manageRow.style.display='none'}else if(daysLeft<=0){statusEl.textContent='Trial Expired';statusEl.className='subscription-badge expired';$('trialDaysLeft').textContent='Your free trial has ended';trialBanner.style.display='flex';renewalRow.style.display='none';manageRow.style.display='none'}else{statusEl.textContent='Free Trial';statusEl.className='subscription-badge trial';$('trialDaysLeft').textContent=`${daysLeft} day${daysLeft!==1?'s':''} left in your free trial`;trialBanner.style.display='flex';renewalRow.style.display='none';manageRow.style.display='none'}}
function subscribe(){window.location.href='https://buy.stripe.com/6oU3cofdqgwk0gm7D79oc00'}
function manageSubscription(){window.open('https://billing.stripe.com/p/login/YOUR_PORTAL_LINK','_blank')}
function showChangePassword(){$('passwordModal').classList.add('active');$('newPassword').value='';$('confirmPassword').value='';$('passwordError').classList.remove('show')}
function hideChangePassword(){$('passwordModal').classList.remove('active')}
async function changePassword(e){e.preventDefault();const newPw=$('newPassword').value;const confirmPw=$('confirmPassword').value;if(newPw!==confirmPw){$('passwordError').textContent='Passwords do not match';$('passwordError').classList.add('show');return}const{error}=await sb.auth.updateUser({password:newPw});if(error){$('passwordError').textContent=error.message;$('passwordError').classList.add('show');return}hideChangePassword();toast('Password updated')}
async function deleteAccount(){if(!confirm('Are you sure? This will permanently delete all your data.'))return;if(!confirm('This cannot be undone. Type DELETE to confirm.')&&prompt('Type DELETE to confirm')!=='DELETE')return;await sb.from('deals').delete().eq('user_id',user.id);await sb.from('comp_plans').delete().eq('user_id',user.id);await sb.from('starting_points').delete().eq('user_id',user.id);await sb.from('profiles').delete().eq('id',user.id);await sb.auth.signOut();toast('Account deleted');user=null;compPlan=null;deals=[];$('app').style.display='none';$('landing').style.display='block';history.pushState(null,'','/')}
function showFeedback(){$('feedbackModal').classList.add('active');$('feedbackText').value='';$('feedbackEmail').value=user?.email||''}
function hideFeedback(){$('feedbackModal').classList.remove('active')}
function setFeedbackType(btn,type){document.querySelectorAll('.feedback-type button').forEach(b=>b.classList.remove('active'));btn.classList.add('active');$('feedbackType').value=type}
async function submitFeedback(){const type=$('feedbackType').value;const text=$('feedbackText').value.trim();const email=$('feedbackEmail').value.trim()||user?.email||'';if(!text){toast('Please enter your feedback');return}const{error}=await sb.from('feedback').insert({type,message:text,email,user_id:user?.id||null});if(error){window.location.href=`mailto:info@comish.online?subject=${encodeURIComponent(type.toUpperCase()+': Feedback')}&body=${encodeURIComponent(text+'\\n\\nFrom: '+email)}`;hideFeedback();toast('Thanks for your feedback!');return}hideFeedback();toast('Thanks! Your feedback has been sent.')}
function setLandingFeedbackType(btn,type){btn.parentElement.querySelectorAll('button').forEach(b=>{b.style.borderColor='var(--border)';b.style.background='transparent';b.style.color='var(--text2)';b.style.fontWeight='500'});btn.style.borderColor='var(--accent)';btn.style.background='rgba(0,255,136,0.1)';btn.style.color='var(--accent)';btn.style.fontWeight='600';$('landingFeedbackType').value=type}
async function submitLandingFeedback(){const type=$('landingFeedbackType').value;const text=$('landingFeedbackText').value.trim();const email=$('landingFeedbackEmail').value.trim();if(!text){toast('Please enter your feedback');return}try{const{error}=await sb.from('feedback').insert({type,message:text,email:email||null,user_id:null});if(error)throw error;$('landingFeedbackText').value='';$('landingFeedbackEmail').value='';toast('Thanks! Your feedback has been sent.')}catch(e){window.location.href=`mailto:info@comish.online?subject=${encodeURIComponent(type.toUpperCase()+': Feedback')}&body=${encodeURIComponent(text+'\\n\\nFrom: '+email)}`;toast('Thanks for your feedback!')}}
function curQ(){const m=new Date().getMonth();return m<3?'Q1':m<6?'Q2':m<9?'Q3':'Q4'}
function curY(){return new Date().getFullYear()}
function curM(){return new Date().getMonth()}
function getQ(d){const m=new Date(d+'T00:00:00').getMonth();return m<3?'Q1':m<6?'Q2':m<9?'Q3':'Q4'}
function getM(d){return new Date(d+'T00:00:00').getMonth()}
function getY(d){return new Date(d+'T00:00:00').getFullYear()}
function fmtD(d){return new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})}
function qKey(){return $('yearSelect').value+'-'+$('quarterSelect').value}
function qMonths(q){return q==='Q1'?[0,1,2]:q==='Q2'?[3,4,5]:q==='Q3'?[6,7,8]:[9,10,11]}
function mName(m){return['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][m]}
function initYear(){const s=$('yearSelect'),y=new Set([curY()]);deals.forEach(d=>{if(d.close_date)y.add(getY(d.close_date))});s.innerHTML=[...y].sort((a,b)=>b-a).map(yr=>`<option>${yr}</option>`).join('')}
async function saveStarting(){const k=qKey(),a=parseFloat($('startingPoint').value)||0;startingPoints[k]=a;await sb.from('starting_points').upsert({user_id:user.id,comp_plan_id:compPlan.id,quarter:k,amount:a},{onConflict:'user_id,comp_plan_id,quarter'});render()}
function filtered(){const y=+$('yearSelect').value,q=$('quarterSelect').value;return deals.filter(d=>d.close_date&&getY(d.close_date)===y&&getQ(d.close_date)===q)}
function calcComm(deals,start){if(compPlan.structure==='flat'){const r1=compPlan.flat_rate_1yr||compPlan.rates_1yr?.[0]||8;const r2=compPlan.flat_rate_2yr||compPlan.rates_2yr?.[0]||10;const y1=deals.filter(d=>d.term===1),y2=deals.filter(d=>d.term===2);const y1Tot=y1.reduce((s,d)=>s+d.amount,0),y2Tot=y2.reduce((s,d)=>s+d.amount,0);const y1C=y1Tot*r1/100,y2C=y2Tot*r2/100;const avgR=(r1+r2)/2;const startC=start*avgR/100;const total=y1C+y2C+startC;return{y1C,y2C,total,tierData:[{tier:1,rev:start+y1Tot+y2Tot,y1:y1Tot,y2:y2Tot,comm:total,start:0,end:Infinity}],y1Tot,y2Tot}}const goal=compPlan.quarterly_goal,tiers=compPlan.tiers,r1=compPlan.rates_1yr,r2=compPlan.rates_2yr,total=start+deals.reduce((s,d)=>s+d.amount,0),y1=deals.filter(d=>d.term===1),y2=deals.filter(d=>d.term===2),y1Tot=y1.reduce((s,d)=>s+d.amount,0),y2Tot=y2.reduce((s,d)=>s+d.amount,0),dTot=y1Tot+y2Tot,tierData=[];let y1C=0,y2C=0;for(let i=0;i<tiers.length;i++){const tS=tiers[i]/100*goal,tE=i<tiers.length-1?tiers[i+1]/100*goal:Infinity,revIn=Math.max(0,Math.min(total,tE)-tS);if(revIn<=0){tierData.push({tier:i+1,rev:0,comm:0,start:tS,end:tE});continue}const startIn=Math.max(0,Math.min(start,tE)-tS),dealsIn=revIn-startIn;let y1In=0,y2In=0;if(dTot>0&&dealsIn>0){y1In=dealsIn*(y1Tot/dTot);y2In=dealsIn*(y2Tot/dTot)}const y1Cm=y1In*r1[i]/100,y2Cm=y2In*r2[i]/100,avgR=(r1[i]+r2[i])/2,startCm=startIn*avgR/100;y1C+=y1Cm;y2C+=y2Cm;tierData.push({tier:i+1,rev:revIn,y1:y1In,y2:y2In,comm:y1Cm+y2Cm+startCm,start:tS,end:tE})}return{y1C,y2C,total:tierData.reduce((s,t)=>s+t.comm,0),tierData,y1Tot,y2Tot}}
// Calculate tier and commission for each deal based on chronological position
function calcDealTierAndComm(allDeals,start){
  if(!compPlan)return new Map();
  const dealInfo=new Map();
  const goal=compPlan.quarterly_goal;
  const tiers=compPlan.tiers;
  const r1=compPlan.rates_1yr;
  const r2=compPlan.rates_2yr;
  const isFlat=compPlan.structure==='flat';
  
  // Sort by close date
  const sorted=[...allDeals].sort((a,b)=>new Date(a.close_date)-new Date(b.close_date));
  
  // Calculate running total from PAID deals only (in date order)
  const paidDeals=sorted.filter(d=>d.paid);
  let paidRunningTotal=start;
  const paidPositions=new Map();
  
  for(const deal of paidDeals){
    paidPositions.set(deal.id,{before:paidRunningTotal,after:paidRunningTotal+deal.amount});
    paidRunningTotal+=deal.amount;
  }
  
  // Calculate commission for each deal
  for(const deal of sorted){
    let beforeRev,afterRev;
    
    if(deal.paid){
      const pos=paidPositions.get(deal.id);
      beforeRev=pos.before;
      afterRev=pos.after;
    }else{
      // Unpaid deal: calculate as if paid after all current paid deals
      beforeRev=paidRunningTotal;
      afterRev=paidRunningTotal+deal.amount;
    }
    
    if(isFlat){
      const rate=deal.term===2?(compPlan.flat_rate_2yr||r2[0]||10):(compPlan.flat_rate_1yr||r1[0]||8);
      const comm=deal.amount*rate/100;
      dealInfo.set(deal.id,{tier:1,comm,rate,isPaid:deal.paid});
    }else{
      // Determine which tier the deal ENDS in
      const pctAfter=afterRev/goal*100;
      let tierIdx=0;
      for(let i=tiers.length-1;i>=0;i--){
        if(pctAfter>=tiers[i]){tierIdx=i;break}
      }
      
      if(deal.paid){
        // PAID deals: calculate marginal (spans tiers)
        let dealComm=0;
        for(let i=0;i<tiers.length;i++){
          const tierStart=tiers[i]/100*goal;
          const tierEnd=i<tiers.length-1?tiers[i+1]/100*goal:Infinity;
          const overlapStart=Math.max(beforeRev,tierStart);
          const overlapEnd=Math.min(afterRev,tierEnd);
          const amtInTier=Math.max(0,overlapEnd-overlapStart);
          if(amtInTier>0){
            const rate=deal.term===2?r2[i]:r1[i];
            dealComm+=amtInTier*rate/100;
          }
        }
        dealInfo.set(deal.id,{tier:tierIdx+1,comm:dealComm,isPaid:true});
      }else{
        // UNPAID deals: calculate at ending tier rate (cliff)
        const rate=deal.term===2?r2[tierIdx]:r1[tierIdx];
        const comm=deal.amount*rate/100;
        dealInfo.set(deal.id,{tier:tierIdx+1,comm,rate,isPaid:false});
      }
    }
  }
  return dealInfo;
}
function render(){const goal=compPlan.quarterly_goal,tiers=compPlan.tiers,r1=compPlan.rates_1yr,r2=compPlan.rates_2yr,start=startingPoints[qKey()]||0;$('startingPoint').value=start||'';const d=filtered(),paidDeals=d.filter(x=>x.paid),dTot=d.reduce((s,x)=>s+x.amount,0),paidTot=paidDeals.reduce((s,x)=>s+x.amount,0),qtd=start+paidTot,pct=qtd/goal*100;const isFlat=compPlan.structure==='flat';let tier=0;for(let i=tiers.length-1;i>=0;i--)if(pct>=tiers[i]){tier=i;break}const c=calcComm(paidDeals,start);$('qtdTotal').textContent=fmt(qtd);$('qGoal').textContent=fmt(goal);$('attainmentPct').textContent=pct.toFixed(1)+'%';if(isFlat){const flatR1=compPlan.flat_rate_1yr||r1[0]||8;const flatR2=compPlan.flat_rate_2yr||r2[0]||10;$('currentTier').textContent='Flat Rate';$('tierRates').textContent=`1yr: ${flatR1}% ¬∑ 2yr: ${flatR2}%`;$('toNext').textContent='‚Äî';$('nextTierName').textContent=''}else{$('currentTier').textContent='Tier '+(tier+1);$('tierRates').textContent=`1yr: ${r1[tier]}% ¬∑ 2yr: ${r2[tier]}%`;const nx=tier+1;if(nx<tiers.length){$('toNext').textContent=fmt(Math.max(0,tiers[nx]/100*goal-qtd));$('nextTierName').textContent='to Tier '+(nx+1)}else{$('toNext').textContent='Max!';$('nextTierName').textContent=''}}const mD=paidDeals.filter(x=>getM(x.close_date)===curM()&&getY(x.close_date)===curY());$('monthTotal').textContent=fmt(mD.reduce((s,x)=>s+x.amount,0));$('monthDeals').textContent=mD.length+' deal'+(mD.length!==1?'s':'');$('progressBar').style.width=Math.min(100,pct/175*100)+'%';$('closedAmt').textContent=fmt(qtd);$('remainingAmt').textContent=fmt(Math.max(0,goal-qtd));let bH='';if(isFlat){const flatR1=compPlan.flat_rate_1yr||r1[0]||8;const flatR2=compPlan.flat_rate_2yr||r2[0]||10;bH=`<div class="tier-row active" style="cursor:pointer" data-filter-tier="all" title="Click to show all deals"><span class="tier-color" style="background:var(--accent)"></span><div class="tier-info"><div class="tier-name">Flat Rate (${flatR1}%/${flatR2}%)</div><div class="tier-range">Paid revenue</div></div><div class="tier-amounts"><div class="tier-rev">${fmt(qtd)}</div><div class="tier-comm">${fmt(c.total)}</div></div></div>`}else{for(const t of c.tierData){const a=t.rev>0,eD=t.end===Infinity?'‚àû':fmt(t.end);const selected=$('tierFilter').value===String(t.tier);bH+=`<div class="tier-row ${a?'active':''}" style="cursor:pointer;${selected?'border:2px solid var(--accent);':''}" data-filter-tier="${t.tier}" title="Click to filter Tier ${t.tier} deals"><span class="tier-color" style="background:var(--${['blue','purple','pink','orange'][t.tier-1]})"></span><div class="tier-info"><div class="tier-name">Tier ${t.tier} (${r1[t.tier-1]}%/${r2[t.tier-1]}%)</div><div class="tier-range">${fmt(t.start)} to ${eD}</div></div><div class="tier-amounts"><div class="tier-rev">${fmt(t.rev)}</div><div class="tier-comm">${fmt(t.comm)}</div></div></div>`}}$('tierBreakdown').innerHTML=bH;const qM=qMonths($('quarterSelect').value);const selY=+$('yearSelect').value;let mbH='';qM.forEach(m=>{const mDeals=paidDeals.filter(x=>getM(x.close_date)===m);const mRev=mDeals.reduce((s,x)=>s+x.amount,0);const mComm=calcMonthComm(mDeals,m,selY);const isCur=m===curM()&&selY===curY();const isSelected=$('monthFilter').value===String(m);mbH+=`<div class="comm-row month-row" data-filter-month="${m}" style="cursor:pointer;${isCur?'background:rgba(0,255,136,0.05);':''}${isSelected?'background:rgba(0,255,136,0.15);border-left:3px solid var(--accent);':''}margin:0 -0.75rem;padding:0.5rem 0.75rem;border-radius:6px;transition:background 0.2s"><span class="comm-label">${mName(m)}${isCur?' <span style="color:var(--accent);font-size:0.7rem">NOW</span>':''}</span><span class="comm-value" style="font-size:0.85rem">${fmt(mComm)}<span style="color:var(--muted);font-size:0.7rem;margin-left:4px">(${fmt(mRev)})</span></span></div>`});$('monthlyBreakdown').innerHTML=mbH||'<div style="color:var(--muted);font-size:0.85rem">No paid deals this quarter</div>';setupSidebarClicks();
// Calculate paid and unpaid commission
const unpaidDeals=d.filter(x=>!x.paid);
const allDealsComm=calcComm(d,start);
const unpaidCommSum=allDealsComm.total-c.total;
// Show paid commission breakdown (matches Earned)
$('y1Comm').textContent=fmt(c.y1C);$('y2Comm').textContent=fmt(c.y2C);
$('paidCommTotal').textContent=fmt(c.total);
$('unpaidCommTotal').textContent=fmt(unpaidCommSum);
$('totalComm').textContent=fmt(allDealsComm.total);
$('totalCommStat').textContent=fmt(c.total);
$('paidCommRow').querySelector('.comm-label').innerHTML='üí∞ Earned <span style="color:var(--muted);font-size:0.75rem;margin-left:4px">('+paidDeals.length+')</span>';
$('unpaidCommRow').querySelector('.comm-label').innerHTML='‚è≥ Upcoming <span style="color:var(--muted);font-size:0.75rem;margin-left:4px">('+unpaidDeals.length+')</span>';
updateStatusHighlight();
// Revenue section - paid deals only
const y1PaidDeals=paidDeals.filter(x=>x.term===1),y2PaidDeals=paidDeals.filter(x=>x.term===2);
$('y1Rev').textContent=fmt(y1PaidDeals.reduce((s,x)=>s+x.amount,0));
$('y2Rev').textContent=fmt(y2PaidDeals.reduce((s,x)=>s+x.amount,0));
$('totalRev').textContent=fmt(paidTot);const mf=$('monthFilter'),cv=mf.value;mf.innerHTML='<option value="all">All Months</option>'+qM.map(m=>`<option value="${m}">${mName(m)}</option>`).join('');mf.value=cv;renderDeals()}
function renderDeals(){
// Update sort arrows
document.querySelectorAll('.sort-arrow').forEach(a=>{a.className='sort-arrow'});
const arrowId='sort'+sortColumn.charAt(0).toUpperCase()+sortColumn.slice(1);
const arrow=$(arrowId);if(arrow)arrow.className='sort-arrow '+sortDir;
let d=filtered();const mf=$('monthFilter').value,tf=$('termFilter').value,sf=$('statusFilter').value,trf=$('tierFilter').value;if(mf!=='all')d=d.filter(x=>getM(x.close_date)===+mf);if(tf!=='all')d=d.filter(x=>x.term===+tf);if(sf!=='all')d=d.filter(x=>sf==='paid'?x.paid:!x.paid);
// Calculate tier info for all deals in quarter
const allQ=filtered();const start=startingPoints[qKey()]||0;const dealInfo=calcDealTierAndComm(allQ,start);
// Filter by tier if selected
if(trf!=='all')d=d.filter(x=>{const info=dealInfo.get(x.id);return info&&info.tier===+trf});
// Sort deals based on selected column
d.sort((a,b)=>{
  let va,vb;
  const infoA=dealInfo.get(a.id)||{tier:1,comm:0};
  const infoB=dealInfo.get(b.id)||{tier:1,comm:0};
  switch(sortColumn){
    case 'name':va=a.name.toLowerCase();vb=b.name.toLowerCase();break;
    case 'amount':va=a.amount;vb=b.amount;break;
    case 'tier':va=infoA.tier;vb=infoB.tier;break;
    case 'commission':va=infoA.comm;vb=infoB.comm;break;
    case 'term':va=a.term;vb=b.term;break;
    case 'date':va=new Date(a.close_date);vb=new Date(b.close_date);break;
    case 'status':va=a.paid?1:0;vb=b.paid?1:0;break;
    default:va=new Date(a.close_date);vb=new Date(b.close_date);
  }
  if(va<vb)return sortDir==='asc'?-1:1;
  if(va>vb)return sortDir==='asc'?1:-1;
  return 0;
});
const allFiltered=filtered();$('dealCount').textContent=d.length===allFiltered.length?`${d.length} deals`:`${d.length} of ${allFiltered.length} deals`;const tb=$('dealsBody'),em=$('emptyDeals');if(!d.length){tb.innerHTML='';em.style.display='block';em.innerHTML=allFiltered.length?'No deals match filters.<br><button class="btn btn-secondary" onclick="clearDealFilters()" style="margin-top:1rem">Clear Filters</button>':'No deals yet.<br><button class="btn btn-primary" onclick="openDeal()" style="margin-top:1rem">Add your first deal</button>';updateFilteredCommission(d,mf);return}em.style.display='none';
const tierColors=['blue','purple','pink','orange'];
tb.innerHTML=d.map(x=>{
  const info=dealInfo.get(x.id)||{tier:1,comm:0};
  const tierColor=tierColors[info.tier-1]||'blue';
  const tierBadge=compPlan.structure==='flat'?'<span class="badge" style="background:rgba(0,255,136,0.1);color:var(--accent)">Flat</span>':`<span class="badge" style="background:var(--${tierColor});color:#fff">T${info.tier}</span>`;
  const commStyle=x.paid?'font-weight:600;color:var(--accent)':'font-weight:500;color:var(--muted);font-style:italic';
  const commDisplay=x.paid?fmt(info.comm):'~'+fmt(info.comm);
  return `<tr style="${x.paid?'':'opacity:0.7'}"><td style="font-weight:500">${x.name}</td><td style="font-weight:600">${fmt(x.amount)}</td><td>${tierBadge}</td><td style="${commStyle}" title="${x.paid?'Earned commission':'Potential commission if paid'}">${commDisplay}</td><td><span class="badge ${x.term===2?'y2':'y1'}">${x.term}yr</span></td><td style="color:var(--text2)">${fmtD(x.close_date)}</td><td><span class="badge ${x.paid?'paid':'unpaid'}">${x.paid?'Paid':'Unpaid'}</span></td><td class="deal-actions">${!x.paid?`<button onclick="markPaid('${x.id}')">üí∞</button>`:''}<button onclick="editDeal('${x.id}')">‚úé</button><button onclick="delDeal('${x.id}')">√ó</button></td></tr>`;
}).join('');updateFilteredCommission(d,mf)}
function updateFilteredCommission(filteredDeals,monthFilter){
  const commTitle=$('commissionTitle');
  const selY=+$('yearSelect').value;
  const monthLabel=$('monthLabel');
  const isFlat=compPlan.structure==='flat';
  const r1=compPlan.rates_1yr;
  const r2=compPlan.rates_2yr;
  const goal=compPlan.quarterly_goal;
  const tiers=compPlan.tiers;
  
  // Always separate paid and unpaid from filtered deals
  const paidDeals=filteredDeals.filter(x=>x.paid);
  const unpaidDeals=filteredDeals.filter(x=>!x.paid);
  
  if(monthFilter!=='all'){
    const m=+monthFilter;
    const monthName=mName(m);
    
    // Get quarter context
    const q=m<3?'Q1':m<6?'Q2':m<9?'Q3':'Q4';
    const qStart=startingPoints[selY+'-'+q]||0;
    
    // Get all paid deals in this quarter
    const allQPaidDeals=deals.filter(d=>d.close_date&&d.paid&&getY(d.close_date)===selY&&getQ(d.close_date)===q);
    const dealsBeforeMonth=allQPaidDeals.filter(d=>getM(d.close_date)<m);
    const dealsInMonth=allQPaidDeals.filter(d=>getM(d.close_date)===m);
    
    // Calculate commission BEFORE this month
    const commBefore=calcComm(dealsBeforeMonth,qStart).total;
    // Calculate commission AFTER this month (including this month)
    const commAfter=calcComm([...dealsBeforeMonth,...dealsInMonth],qStart).total;
    // This month's earned commission = difference
    const monthPaidComm=commAfter-commBefore;
    
    // For display, calculate where this month's deals fall in tiers
    const revBefore=qStart+dealsBeforeMonth.reduce((s,d)=>s+d.amount,0);
    const monthPaidRev=dealsInMonth.reduce((s,d)=>s+d.amount,0);
    
    // Calculate unpaid commission - each deal at its ending tier rate
    let monthUnpaidComm=0;
    const allPaidRev=qStart+allQPaidDeals.reduce((s,d)=>s+d.amount,0);
    unpaidDeals.forEach(deal=>{
      const afterRev=allPaidRev+deal.amount;
      const pct=afterRev/goal*100;
      let tierIdx=0;
      for(let i=tiers.length-1;i>=0;i--){if(pct>=tiers[i]){tierIdx=i;break}}
      const rate=deal.term===2?r2[tierIdx]:r1[tierIdx];
      monthUnpaidComm+=deal.amount*rate/100;
    });
    
    // Build tier breakdown display for this month's PAID deals only
    let bH='';
    if(isFlat){
      const flatR1=compPlan.flat_rate_1yr||r1[0]||8;
      const flatR2=compPlan.flat_rate_2yr||r2[0]||10;
      bH=`<div class="tier-row active"><span class="tier-color" style="background:var(--accent)"></span><div class="tier-info"><div class="tier-name">Flat Rate (${flatR1}%/${flatR2}%)</div><div class="tier-range">${monthName} revenue</div></div><div class="tier-amounts"><div class="tier-rev">${fmt(monthPaidRev)}</div><div class="tier-comm">${fmt(monthPaidComm)}</div></div></div>`;
    }else{
      // Show tier breakdown for this month
      for(let i=0;i<tiers.length;i++){
        const tStart=tiers[i]/100*goal;
        const tEnd=i<tiers.length-1?tiers[i+1]/100*goal:Infinity;
        const eD=tEnd===Infinity?'‚àû':fmt(tEnd);
        // How much of this month's revenue falls in this tier
        const tierRevStart=Math.max(revBefore,tStart);
        const tierRevEnd=Math.min(revBefore+monthPaidRev,tEnd);
        const revInTier=Math.max(0,tierRevEnd-tierRevStart);
        // Calculate commission for this tier portion
        let commInTier=0;
        if(revInTier>0){
          // Approximate using 2yr rate (most deals are 2yr)
          commInTier=revInTier*r2[i]/100;
        }
        const a=revInTier>0;
        bH+=`<div class="tier-row ${a?'active':''}"><span class="tier-color" style="background:var(--${['blue','purple','pink','orange'][i]})"></span><div class="tier-info"><div class="tier-name">Tier ${i+1} (${r1[i]}%/${r2[i]}%)</div><div class="tier-range">${fmt(tStart)} to ${eD}</div></div><div class="tier-amounts"><div class="tier-rev">${fmt(revInTier)}</div><div class="tier-comm">${fmt(commInTier)}</div></div></div>`;
      }
    }
    
    $('tierBreakdown').innerHTML=bH;
    if(commTitle)commTitle.innerHTML='Commission <span style="color:var(--accent);font-size:0.85rem;margin-left:0.5rem">'+monthName+' only</span>';
    
    // Update sidebar - show this month only
    const y1Paid=dealsInMonth.filter(x=>x.term===1);
    const y2Paid=dealsInMonth.filter(x=>x.term===2);
    const y1Comm=y1Paid.reduce((s,d)=>s+d.amount,0)*r1[0]/100;
    const y2Comm=y2Paid.reduce((s,d)=>s+d.amount,0)*r2[0]/100;
    $('y1Comm').textContent=fmt(y1Comm);
    $('y2Comm').textContent=fmt(y2Comm);
    $('totalComm').textContent=fmt(monthPaidComm+monthUnpaidComm);
    $('paidCommTotal').textContent=fmt(monthPaidComm);
    $('unpaidCommTotal').textContent=fmt(monthUnpaidComm);
    $('paidCommRow').querySelector('.comm-label').innerHTML='üí∞ Earned <span style="color:var(--muted);font-size:0.75rem;margin-left:4px">('+dealsInMonth.length+')</span>';
    $('unpaidCommRow').querySelector('.comm-label').innerHTML='‚è≥ Upcoming <span style="color:var(--muted);font-size:0.75rem;margin-left:4px">('+unpaidDeals.length+')</span>';
    
    // Revenue section - this month's paid only
    $('y1Rev').textContent=fmt(y1Paid.reduce((s,x)=>s+x.amount,0));
    $('y2Rev').textContent=fmt(y2Paid.reduce((s,x)=>s+x.amount,0));
    $('totalRev').textContent=fmt(monthPaidRev);
    
    // Main stat
    $('totalCommStat').textContent=fmt(monthPaidComm);
    $('monthTotal').textContent=fmt(monthPaidRev);
    $('monthDeals').textContent=dealsInMonth.length+' deal'+(dealsInMonth.length!==1?'s':'');
    if(monthLabel)monthLabel.textContent=monthName;
    
  }else{
    // Full quarter view
    if(commTitle)commTitle.innerHTML='Commission by Tier';
    const start=startingPoints[qKey()]||0;
    
    // Get all paid deals in quarter
    const allQPaidDeals=paidDeals;
    const paidC=calcComm(allQPaidDeals,start);
    const paidRev=allQPaidDeals.reduce((s,x)=>s+x.amount,0);
    const allPaidRev=start+paidRev;
    
    // Calculate unpaid commission - each deal at its ending tier rate
    let unpaidComm=0;
    unpaidDeals.forEach(deal=>{
      const afterRev=allPaidRev+deal.amount;
      const pct=afterRev/goal*100;
      let tierIdx=0;
      for(let i=tiers.length-1;i>=0;i--){if(pct>=tiers[i]){tierIdx=i;break}}
      const rate=deal.term===2?r2[tierIdx]:r1[tierIdx];
      unpaidComm+=deal.amount*rate/100;
    });
    
    let bH='';
    if(isFlat){
      const flatR1=compPlan.flat_rate_1yr||r1[0]||8;
      const flatR2=compPlan.flat_rate_2yr||r2[0]||10;
      bH=`<div class="tier-row active"><span class="tier-color" style="background:var(--accent)"></span><div class="tier-info"><div class="tier-name">Flat Rate (${flatR1}%/${flatR2}%)</div><div class="tier-range">All revenue</div></div><div class="tier-amounts"><div class="tier-rev">${fmt(allPaidRev)}</div><div class="tier-comm">${fmt(paidC.total)}</div></div></div>`;
    }else{
      for(const t of paidC.tierData){
        const a=t.rev>0,eD=t.end===Infinity?'‚àû':fmt(t.end);
        bH+=`<div class="tier-row ${a?'active':''}"><span class="tier-color" style="background:var(--${['blue','purple','pink','orange'][t.tier-1]})"></span><div class="tier-info"><div class="tier-name">Tier ${t.tier} (${r1[t.tier-1]}%/${r2[t.tier-1]}%)</div><div class="tier-range">${fmt(t.start)} to ${eD}</div></div><div class="tier-amounts"><div class="tier-rev">${fmt(t.rev)}</div><div class="tier-comm">${fmt(t.comm)}</div></div></div>`;
      }
    }
    $('tierBreakdown').innerHTML=bH;
    
    // Update sidebar
    $('y1Comm').textContent=fmt(paidC.y1C);
    $('y2Comm').textContent=fmt(paidC.y2C);
    $('totalComm').textContent=fmt(paidC.total+unpaidComm);
    $('paidCommTotal').textContent=fmt(paidC.total);
    $('unpaidCommTotal').textContent=fmt(unpaidComm);
    $('paidCommRow').querySelector('.comm-label').innerHTML='üí∞ Earned <span style="color:var(--muted);font-size:0.75rem;margin-left:4px">('+allQPaidDeals.length+')</span>';
    $('unpaidCommRow').querySelector('.comm-label').innerHTML='‚è≥ Upcoming <span style="color:var(--muted);font-size:0.75rem;margin-left:4px">('+unpaidDeals.length+')</span>';
    
    // Revenue section - paid only
    const y1PaidDeals=allQPaidDeals.filter(x=>x.term===1),y2PaidDeals=allQPaidDeals.filter(x=>x.term===2);
    $('y1Rev').textContent=fmt(y1PaidDeals.reduce((s,x)=>s+x.amount,0));
    $('y2Rev').textContent=fmt(y2PaidDeals.reduce((s,x)=>s+x.amount,0));
    $('totalRev').textContent=fmt(paidRev);
    
    // Main stats
    $('totalCommStat').textContent=fmt(paidC.total);
    
    // Current month stats
    const mD=allQPaidDeals.filter(x=>getM(x.close_date)===curM()&&getY(x.close_date)===curY());
    $('monthTotal').textContent=fmt(mD.reduce((s,x)=>s+x.amount,0));
    $('monthDeals').textContent=mD.length+' deal'+(mD.length!==1?'s':'');
    if(monthLabel)monthLabel.textContent='This Month';
  }
}
function clearDealFilters(){$('monthFilter').value='all';$('termFilter').value='all';$('statusFilter').value='all';$('tierFilter').value='all';render()}
function setTerm(t){$('dealTerm').value=t;document.querySelectorAll('.toggle-opt.y1,.toggle-opt.y2').forEach(e=>e.classList.remove('active'));document.querySelector(`.toggle-opt.y${t}`).classList.add('active')}
function setPaid(p){$('dealPaid').value=p;$('paidOpt').classList.toggle('active',p);$('unpaidOpt').classList.toggle('active',!p)}
function openDeal(id){$('dealModal').classList.add('active');$('dealModalTitle').textContent=id?'Edit Deal':'Add Deal';$('editId').value=id||'';if(id){const d=deals.find(x=>x.id===id);if(d){$('dealName').value=d.name;$('dealAmt').value=d.amount;$('dealDate').value=d.close_date;setTerm(d.term||1);setPaid(d.paid||false)}}else{$('dealName').value='';$('dealAmt').value='';$('dealDate').value=new Date().toISOString().split('T')[0];setTerm(1);setPaid(false)}}
function closeDeal(){$('dealModal').classList.remove('active')}
async function saveDeal(){const saveBtn=$('saveDealBtn');if(!saveBtn||saveBtn.disabled)return;const n=$('dealName').value.trim(),a=parseFloat($('dealAmt').value),dt=$('dealDate').value,tm=+$('dealTerm').value,pd=$('dealPaid').value==='true',eid=$('editId').value;if(!n||isNaN(a)||!dt){toast('Fill all fields');return}saveBtn.disabled=true;saveBtn.textContent='Saving...';let switchTo=null;let success=false;try{if(eid){const{error}=await sb.from('deals').update({name:n,amount:a,close_date:dt,term:tm,paid:pd}).eq('id',eid);if(error){toast('Error: '+error.message)}else{const d=deals.find(x=>x.id===eid);if(d){d.name=n;d.amount=a;d.close_date=dt;d.term=tm;d.paid=pd}toast('Updated');success=true}}else{const{data,error}=await sb.from('deals').insert({user_id:user.id,comp_plan_id:compPlan.id,name:n,amount:a,close_date:dt,term:tm,paid:pd}).select().single();if(error){toast('Error: '+error.message)}else{deals.push(data);switchTo={year:getY(dt),quarter:getQ(dt)};toast('Deal added');success=true}}}catch(e){console.error('saveDeal error:',e);toast('Error saving deal')}finally{saveBtn.disabled=false;saveBtn.textContent='Save Deal';if(success){closeDeal();initYear();if(switchTo){$('yearSelect').value=switchTo.year;$('quarterSelect').value=switchTo.quarter;$('monthFilter').value='all';$('termFilter').value='all';$('statusFilter').value='all'}render()}}}
function editDeal(id){openDeal(id)}
async function delDeal(id){if(!confirm('Delete this deal?'))return;const{error}=await sb.from('deals').delete().eq('id',id);if(error){toast('Error: '+error.message);return}deals=deals.filter(d=>d.id!==id);render();toast('Deleted')}
async function markPaid(id){const{error}=await sb.from('deals').update({paid:true}).eq('id',id);if(error){toast('Error: '+error.message);return}const d=deals.find(x=>x.id===id);if(d)d.paid=true;render();toast('Marked paid')}
function openSettings(){$('settingsModal').classList.add('active');$('setGoal').value=compPlan.quarterly_goal;$('setTh2').value=compPlan.tiers[1];$('setTh3').value=compPlan.tiers[2];$('setTh4').value=compPlan.tiers[3];$('setR1a').value=compPlan.rates_1yr[0];$('setR1b').value=compPlan.rates_1yr[1];$('setR1c').value=compPlan.rates_1yr[2];$('setR1d').value=compPlan.rates_1yr[3];$('setR2a').value=compPlan.rates_2yr[0];$('setR2b').value=compPlan.rates_2yr[1];$('setR2c').value=compPlan.rates_2yr[2];$('setR2d').value=compPlan.rates_2yr[3]}
function closeSettings(){$('settingsModal').classList.remove('active')}
async function saveSettings(){const u={quarterly_goal:+$('setGoal').value||375000,tiers:JSON.stringify([0,+$('setTh2').value||100,+$('setTh3').value||125,+$('setTh4').value||150]),rates_1yr:JSON.stringify([+$('setR1a').value||6,+$('setR1b').value||8,+$('setR1c').value||10,+$('setR1d').value||12]),rates_2yr:JSON.stringify([+$('setR2a').value||8,+$('setR2b').value||10,+$('setR2c').value||12,+$('setR2d').value||14])};const{error}=await sb.from('comp_plans').update(u).eq('id',compPlan.id);if(error){toast('Error: '+error.message);return}compPlan.quarterly_goal=u.quarterly_goal;compPlan.tiers=JSON.parse(u.tiers);compPlan.rates_1yr=JSON.parse(u.rates_1yr);compPlan.rates_2yr=JSON.parse(u.rates_2yr);closeSettings();render();toast('Settings saved')}
function exportCSV(){if(!deals.length){toast('No deals to export');return}const qN=$('quarterSelect').value;const yr=+$('yearSelect').value;const qIdx=['Q1','Q2','Q3','Q4'].indexOf(qN);const qDeals=deals.filter(d=>{const dt=new Date(d.close_date);return dt.getFullYear()===yr&&Math.floor(dt.getMonth()/3)===qIdx});if(!qDeals.length){toast('No deals in '+qN+' '+yr);return}const sp=startingPoints[yr+'-'+qN]||0;const dealInfo=calcDealTierAndComm(qDeals,sp);let c='Client,Amount,Tier,Commission,Close Date,Term,Paid,Quarter\n';qDeals.forEach(d=>{const info=dealInfo.get(d.id)||{tier:1,comm:0};c+=`"${d.name}",${d.amount},Tier ${info.tier},${info.comm.toFixed(2)},${d.close_date},${d.term}yr,${d.paid?'Yes':'No'},${qN} ${yr}\n`});const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([c],{type:'text/csv'}));a.download=`comish-${qN}-${yr}.csv`;a.click();toast('CSV exported')}

// PDF Export
function exportPDF(){if(!deals.length){toast('No deals to export');return}const qN=$('quarterSelect').value;const yr=+$('yearSelect').value;const qIdx=['Q1','Q2','Q3','Q4'].indexOf(qN);const qDeals=deals.filter(d=>{const dt=new Date(d.close_date);return dt.getFullYear()===yr&&Math.floor(dt.getMonth()/3)===qIdx});if(!qDeals.length){toast('No deals in '+qN+' '+yr);return}const totalRev=qDeals.reduce((s,d)=>s+d.amount,0);const sp=startingPoints[yr+'-'+qN]||0;const dealInfo=calcDealTierAndComm(qDeals,sp);const paidDeals=qDeals.filter(d=>d.paid);const c=calcComm(paidDeals,sp);const totalComm=c.total;const allComm=calcComm(qDeals,sp);const projComm=allComm.total;const gl=compPlan.quarterly_goal||0;const paidRev=paidDeals.reduce((s,d)=>s+d.amount,0);const attainment=gl>0?Math.round(((sp+paidRev)/gl)*100):0;const win=window.open('','_blank');const css="@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',system-ui,sans-serif;background:#000;color:#fff;min-height:100vh}.container{max-width:900px;margin:0 auto;padding:40px}.header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:40px;padding-bottom:24px;border-bottom:1px solid #262626}.logo{font-size:1.75rem;font-weight:900;letter-spacing:-0.03em}.logo span{color:#00ff88}.period{text-align:right}.period h2{font-size:1.5rem;font-weight:700;margin-bottom:4px}.period p{color:#666;font-size:0.9rem}.summary{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:40px}.stat{background:#0d0d0d;border:1px solid #262626;border-radius:16px;padding:24px;text-align:center}.stat.highlight{border-color:#00ff88;box-shadow:0 0 30px rgba(0,255,136,0.1)}.stat-label{color:#666;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px}.stat-value{font-size:1.75rem;font-weight:800}.stat-value.green{color:#00ff88}.stat-value.blue{color:#3b82f6}.stat-value.muted{color:#666}.section-title{font-size:1rem;font-weight:600;color:#a3a3a3;margin-bottom:16px;text-transform:uppercase;letter-spacing:0.05em}table{width:100%;border-collapse:collapse;background:#0d0d0d;border-radius:12px;overflow:hidden}th{background:#161616;padding:14px 16px;text-align:left;font-size:0.8rem;font-weight:600;color:#666;text-transform:uppercase;letter-spacing:0.05em}td{padding:14px 16px;border-top:1px solid #262626;font-size:0.95rem}tr:hover td{background:#111}.amount{font-weight:600;color:#00ff88}.commission{font-weight:600;color:#00ff88}.tier{display:inline-block;padding:4px 10px;border-radius:100px;font-size:0.75rem;font-weight:600}.tier.t1{background:rgba(59,130,246,0.2);color:#3b82f6}.tier.t2{background:rgba(168,85,247,0.2);color:#a855f7}.tier.t3{background:rgba(236,72,153,0.2);color:#ec4899}.tier.t4{background:rgba(249,115,22,0.2);color:#f97316}.term{display:inline-block;padding:4px 10px;border-radius:100px;font-size:0.75rem;font-weight:600}.term.y1{background:rgba(59,130,246,0.1);color:#3b82f6}.term.y2{background:rgba(168,85,247,0.1);color:#a855f7}.paid-yes{color:#00ff88}.paid-no{color:#666}.footer{margin-top:40px;padding-top:24px;border-top:1px solid #262626;display:flex;justify-content:space-between;align-items:center;color:#666;font-size:0.85rem}.footer a{color:#00ff88;text-decoration:none}@media print{body{background:#fff;color:#000;-webkit-print-color-adjust:exact;print-color-adjust:exact}.stat{background:#f5f5f5!important;border-color:#ddd!important}th{background:#eee!important}td{border-color:#ddd!important}tr:hover td{background:transparent!important}.stat-value.green,.amount,.commission,.paid-yes,.footer a{color:#00aa55!important}}";let html='<!DOCTYPE html><html><head><title>Comish Report - '+qN+' '+yr+'</title><style>'+css+'</style></head><body><div class="container"><div class="header"><div class="logo">Com<span>ish</span></div><div class="period"><h2>'+qN+' '+yr+'</h2><p>Generated '+new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})+'</p></div></div><div class="summary"><div class="stat"><div class="stat-label">Total Revenue</div><div class="stat-value">$'+totalRev.toLocaleString()+'</div></div><div class="stat highlight"><div class="stat-label">Paid Commission</div><div class="stat-value green">$'+Math.round(totalComm).toLocaleString()+'</div></div><div class="stat"><div class="stat-label">If All Pay</div><div class="stat-value muted">$'+Math.round(projComm).toLocaleString()+'</div></div><div class="stat"><div class="stat-label">Attainment</div><div class="stat-value blue">'+attainment+'%</div></div></div><div class="section-title">Deals ('+qDeals.length+')</div><table><tr><th>Client</th><th>Amount</th><th>Tier</th><th>Commission</th><th>Term</th><th>Paid</th></tr>';qDeals.forEach(d=>{const info=dealInfo.get(d.id)||{tier:1,comm:0};html+='<tr><td>'+d.name+'</td><td class="amount">$'+d.amount.toLocaleString()+'</td><td><span class="tier t'+info.tier+'">T'+info.tier+'</span></td><td class="commission'+(d.paid?'':'" style="color:#666;font-style:italic')+'">$'+Math.round(info.comm).toLocaleString()+'</td><td><span class="term y'+d.term+'">'+d.term+'yr</span></td><td class="'+(d.paid?'paid-yes':'paid-no')+'">'+(d.paid?'‚úì Paid':'‚Äî')+'</td></tr>'});html+='</table><div class="footer"><span>Commission tracking by <a href="https://comish.online">comish.online</a></span><span>'+qDeals.length+' deals ¬∑ $'+totalRev.toLocaleString()+' revenue</span></div></div></body></html>';win.document.write(html);win.document.close();setTimeout(()=>win.print(),300);toast('PDF ready')}

// CSV Import
let csvData=[];let csvHeaders=[];let columnMap={name:-1,amount:-1,close_date:-1,term:-1,paid:-1};
function handleCSVUpload(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=function(ev){parseCSV(ev.target.result)};reader.readAsText(file);e.target.value=''}
function parseCSV(text){const lines=text.trim().split(/\r?\n/);if(lines.length<2){toast('CSV must have header row and at least one data row');return}csvHeaders=parseCSVLine(lines[0]);csvData=[];for(let i=1;i<lines.length;i++){const row=parseCSVLine(lines[i]);if(row.length>=csvHeaders.length)csvData.push(row)}if(!csvData.length){toast('No valid data rows found');return}autoMapColumns();showImportPreview()}
function parseCSVLine(line){const result=[];let current='';let inQuotes=false;for(let i=0;i<line.length;i++){const c=line[i];if(c==='"'){inQuotes=!inQuotes}else if(c===','&&!inQuotes){result.push(current.trim());current=''}else{current+=c}}result.push(current.trim());return result}
function autoMapColumns(){columnMap={name:-1,amount:-1,close_date:-1,term:-1,paid:-1};const nameKeys=['client','name','company','account','customer','deal'];const amountKeys=['amount','value','revenue','deal size','acv','arr','price','total'];const dateKeys=['close date','date','closed','close_date','closedate','closed date','closing date'];const termKeys=['term','contract','length','years','duration','contract length'];const paidKeys=['paid','status','payment','received','collected'];csvHeaders.forEach((h,i)=>{const hl=h.toLowerCase().replace(/[^a-z0-9]/g,' ').trim();if(columnMap.name<0&&nameKeys.some(k=>hl.includes(k)))columnMap.name=i;if(columnMap.amount<0&&amountKeys.some(k=>hl.includes(k)))columnMap.amount=i;if(columnMap.close_date<0&&dateKeys.some(k=>hl.includes(k)))columnMap.close_date=i;if(columnMap.term<0&&termKeys.some(k=>hl.includes(k)))columnMap.term=i;if(columnMap.paid<0&&paidKeys.some(k=>hl.includes(k)))columnMap.paid=i})}
function showImportPreview(){$('importModal').classList.add('active');$('importStep1').classList.add('hidden');$('importStep2').classList.remove('hidden');$('importCount').textContent=csvData.length+' deals found';renderColumnMapping();renderPreviewTable();updateValidCount()}
function renderColumnMapping(){const fields=[{key:'name',label:'Client/Name',req:true},{key:'amount',label:'Amount',req:true},{key:'close_date',label:'Close Date',req:true},{key:'term',label:'Term (1yr/2yr)',req:false},{key:'paid',label:'Paid Status',req:false}];let html='';fields.forEach(f=>{html+=`<div style="display:flex;align-items:center;gap:0.5rem"><label style="width:100px;font-size:0.85rem;color:var(--text2)">${f.label}${f.req?'<span style="color:var(--accent)">*</span>':''}</label><select onchange="updateColumnMap('${f.key}',this.value)" style="flex:1;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:0.5rem;color:var(--text);font-size:0.85rem"><option value="-1">‚Äî Select ‚Äî</option>${csvHeaders.map((h,i)=>`<option value="${i}"${columnMap[f.key]===i?' selected':''}>${h}</option>`).join('')}</select></div>`});$('columnMapping').innerHTML=html}
function updateColumnMap(field,idx){columnMap[field]=parseInt(idx);renderPreviewTable();updateValidCount()}
function renderPreviewTable(){const preview=csvData.slice(0,5);let headerHtml='<th style="font-size:0.7rem">#</th>';['name','amount','close_date','term','paid'].forEach(f=>{const idx=columnMap[f];headerHtml+=`<th style="font-size:0.7rem">${f.replace('_',' ').toUpperCase()}</th>`});$('importPreviewHeader').innerHTML=headerHtml;let bodyHtml='';preview.forEach((row,i)=>{bodyHtml+=`<tr><td style="color:var(--muted)">${i+1}</td>`;['name','amount','close_date','term','paid'].forEach(f=>{const idx=columnMap[f];const val=idx>=0?row[idx]:'‚Äî';const isValid=validateField(f,val);bodyHtml+=`<td style="${isValid?'':'color:var(--yellow)'}">${val||'‚Äî'}</td>`});bodyHtml+='</tr>'});if(csvData.length>5)bodyHtml+=`<tr><td colspan="6" style="text-align:center;color:var(--muted)">... and ${csvData.length-5} more rows</td></tr>`;$('importPreviewBody').innerHTML=bodyHtml}
function validateField(field,val){if(!val||val==='‚Äî')return field==='term'||field==='paid';if(field==='amount'){const n=parseFloat(val.replace(/[$,]/g,''));return!isNaN(n)&&n>0}if(field==='close_date'){return parseDate(val)!==null}return true}
function parseDate(str){if(!str)return null;str=str.trim();let d=new Date(str);if(!isNaN(d.getTime()))return d.toISOString().split('T')[0];const formats=[/(\d{1,2})\/(\d{1,2})\/(\d{4})/,/(\d{1,2})-(\d{1,2})-(\d{4})/,/(\d{4})\/(\d{1,2})\/(\d{1,2})/];for(const fmt of formats){const m=str.match(fmt);if(m){if(m[3].length===4)d=new Date(m[3],m[1]-1,m[2]);else d=new Date(m[1],m[2]-1,m[3]);if(!isNaN(d.getTime()))return d.toISOString().split('T')[0]}}return null}
function parseTerm(val){if(!val)return 1;const str=String(val).toLowerCase().trim();if(str==='2'||str==='2yr'||str==='2 yr'||str==='2 year'||str==='2year'||str==='2-year'||str==='two'||str.includes('2 y')||str.includes('2y'))return 2;return 1}
function parsePaid(val){if(!val)return false;const v=val.toLowerCase();return v==='yes'||v==='true'||v==='paid'||v==='1'||v==='y'}
function getValidDeals(){if(columnMap.name<0||columnMap.amount<0||columnMap.close_date<0)return[];return csvData.filter(row=>{const name=row[columnMap.name];const amount=parseFloat((row[columnMap.amount]||'').replace(/[$,]/g,''));const date=parseDate(row[columnMap.close_date]);return name&&!isNaN(amount)&&amount>0&&date}).map(row=>({name:row[columnMap.name],amount:parseFloat(row[columnMap.amount].replace(/[$,]/g,'')),close_date:parseDate(row[columnMap.close_date]),term:columnMap.term>=0?parseTerm(row[columnMap.term]):1,paid:columnMap.paid>=0?parsePaid(row[columnMap.paid]):false}))}
function updateValidCount(){const valid=getValidDeals();$('validDealsCount').textContent=valid.length;$('importBtn').disabled=valid.length===0}
async function confirmImport(){const toImport=getValidDeals();if(!toImport.length){toast('No valid deals to import');return}$('importBtn').disabled=true;$('importBtn').textContent='Importing...';let imported=0;let firstDealDate=null;for(const d of toImport){const{data,error}=await sb.from('deals').insert({user_id:user.id,comp_plan_id:compPlan.id,name:d.name,amount:d.amount,close_date:d.close_date,term:d.term,paid:d.paid}).select().single();if(!error&&data){deals.push(data);if(!firstDealDate)firstDealDate=d.close_date;imported++}}closeImport();initYear();if(firstDealDate){$('yearSelect').value=getY(firstDealDate);$('quarterSelect').value=getQ(firstDealDate);$('monthFilter').value='all'}render();toast(`Imported ${imported} deal${imported!==1?'s':''}`)}
function closeImport(){$('importModal').classList.remove('active');resetImport()}
function resetImport(){$('importStep1').classList.remove('hidden');$('importStep2').classList.add('hidden');csvData=[];csvHeaders=[];columnMap={name:-1,amount:-1,close_date:-1,term:-1,paid:-1};$('importBtn').disabled=false;$('importBtn').textContent='Import Deals'}

// HubSpot Integration
let hubspotDeals=[];
async function openHubSpotImport(){$('hubspotModal').classList.add('active');await checkHubSpotStatus()}
function closeHubSpot(){$('hubspotModal').classList.remove('active');hubspotDeals=[]}
async function checkHubSpotStatus(){try{const token=(await sb.auth.getSession()).data.session?.access_token;const res=await fetch('/api/hubspot/status',{headers:{Authorization:'Bearer '+token}});const data=await res.json();if(data.connected){$('hubspotNotConnected').classList.add('hidden');$('hubspotConnected').classList.remove('hidden');const today=new Date();const qStart=new Date(today.getFullYear(),Math.floor(today.getMonth()/3)*3,1);$('hubspotAfter').value=qStart.toISOString().split('T')[0];$('hubspotBefore').value=today.toISOString().split('T')[0]}else{$('hubspotNotConnected').classList.remove('hidden');$('hubspotConnected').classList.add('hidden')}}catch(e){console.error('HubSpot status error:',e);$('hubspotNotConnected').classList.remove('hidden');$('hubspotConnected').classList.add('hidden')}}
function connectHubSpot(){const url='/api/hubspot/auth?user_id='+user.id;window.location.href=url}
async function disconnectHubSpot(){if(!confirm('Disconnect HubSpot?'))return;try{const token=(await sb.auth.getSession()).data.session?.access_token;await fetch('/api/hubspot/disconnect',{method:'POST',headers:{Authorization:'Bearer '+token}});toast('HubSpot disconnected');checkHubSpotStatus()}catch(e){toast('Error disconnecting')}}
async function fetchHubSpotDeals(){const btn=$('hubspotFetchBtn');btn.disabled=true;btn.textContent='Fetching...';try{const token=(await sb.auth.getSession()).data.session?.access_token;const after=$('hubspotAfter').value;const before=$('hubspotBefore').value;let url='/api/hubspot/deals?';if(after)url+='after='+after+'&';if(before)url+='before='+before;const res=await fetch(url,{headers:{Authorization:'Bearer '+token}});const data=await res.json();if(data.needsAuth){toast('Please reconnect HubSpot');checkHubSpotStatus();return}if(data.error){toast('Error: '+data.error);return}hubspotDeals=data.deals||[];$('hubspotDealCount').textContent=hubspotDeals.length;renderHubSpotDeals();$('hubspotResults').classList.remove('hidden')}catch(e){console.error('Fetch error:',e);toast('Error fetching deals')}finally{btn.disabled=false;btn.textContent='Fetch Deals'}}
function renderHubSpotDeals(){const list=$('hubspotDealsList');if(!hubspotDeals.length){list.innerHTML='<div style="color:var(--muted);text-align:center;padding:1rem">No closed-won deals found in date range</div>';return}let html='<div style="display:flex;flex-direction:column;gap:0.5rem">';hubspotDeals.forEach((d,i)=>{html+=`<label style="display:flex;align-items:center;gap:0.75rem;padding:0.5rem;background:var(--card);border-radius:8px;cursor:pointer"><input type="checkbox" checked data-idx="${i}" class="hs-deal-cb"><div style="flex:1"><div style="font-weight:500">${d.name}</div><div style="font-size:0.8rem;color:var(--muted)">$${d.amount.toLocaleString()} ¬∑ ${d.term}yr ¬∑ ${d.close_date}</div></div></label>`});html+='</div>';list.innerHTML=html}
async function importHubSpotDeals(){const checkboxes=document.querySelectorAll('.hs-deal-cb:checked');if(!checkboxes.length){toast('Select deals to import');return}const btn=$('hubspotImportBtn');btn.disabled=true;btn.textContent='Importing...';let imported=0;let firstDealDate=null;for(const cb of checkboxes){const d=hubspotDeals[cb.dataset.idx];const{data,error}=await sb.from('deals').insert({user_id:user.id,comp_plan_id:compPlan.id,name:d.name,amount:d.amount,close_date:d.close_date,term:d.term,paid:false}).select().single();if(!error&&data){deals.push(data);if(!firstDealDate)firstDealDate=d.close_date;imported++}}closeHubSpot();initYear();if(firstDealDate){$('yearSelect').value=getY(firstDealDate);$('quarterSelect').value=getQ(firstDealDate);$('monthFilter').value='all'}render();toast(`Imported ${imported} deal${imported!==1?'s':''} from HubSpot`)}
// Check for HubSpot callback on page load
if(window.location.search.includes('hubspot=')){const params=new URLSearchParams(window.location.search);const status=params.get('hubspot');if(status==='connected')setTimeout(()=>toast('HubSpot connected!'),500);else if(status==='error')setTimeout(()=>toast('HubSpot connection failed: '+(params.get('msg')||'unknown error')),500);window.history.replaceState({},'',window.location.pathname)}

// Salesforce Integration
let salesforceDeals=[];
async function openSalesforceImport(){$('salesforceModal').classList.add('active');await checkSalesforceStatus()}
function closeSalesforce(){$('salesforceModal').classList.remove('active');salesforceDeals=[]}
async function checkSalesforceStatus(){try{const token=(await sb.auth.getSession()).data.session?.access_token;const res=await fetch('/api/salesforce/status',{headers:{Authorization:'Bearer '+token}});const data=await res.json();if(data.connected){$('salesforceNotConnected').classList.add('hidden');$('salesforceConnected').classList.remove('hidden');const today=new Date();const qStart=new Date(today.getFullYear(),Math.floor(today.getMonth()/3)*3,1);$('salesforceAfter').value=qStart.toISOString().split('T')[0];$('salesforceBefore').value=today.toISOString().split('T')[0]}else{$('salesforceNotConnected').classList.remove('hidden');$('salesforceConnected').classList.add('hidden')}}catch(e){console.error('Salesforce status error:',e);$('salesforceNotConnected').classList.remove('hidden');$('salesforceConnected').classList.add('hidden')}}
function connectSalesforce(sandbox){const url='/api/salesforce/auth?user_id='+user.id+(sandbox?'&sandbox=true':'');window.location.href=url}
async function disconnectSalesforce(){if(!confirm('Disconnect Salesforce?'))return;try{const token=(await sb.auth.getSession()).data.session?.access_token;await fetch('/api/salesforce/disconnect',{method:'POST',headers:{Authorization:'Bearer '+token}});toast('Salesforce disconnected');checkSalesforceStatus()}catch(e){toast('Error disconnecting')}}
async function fetchSalesforceDeals(){const btn=$('salesforceFetchBtn');btn.disabled=true;btn.textContent='Fetching...';try{const token=(await sb.auth.getSession()).data.session?.access_token;const after=$('salesforceAfter').value;const before=$('salesforceBefore').value;let url='/api/salesforce/deals?';if(after)url+='after='+after+'&';if(before)url+='before='+before;const res=await fetch(url,{headers:{Authorization:'Bearer '+token}});const data=await res.json();if(data.needsAuth){toast('Please reconnect Salesforce');checkSalesforceStatus();return}if(data.error){toast('Error: '+data.error);return}salesforceDeals=data.deals||[];$('salesforceDealCount').textContent=salesforceDeals.length;renderSalesforceDeals();$('salesforceResults').classList.remove('hidden')}catch(e){console.error('Fetch error:',e);toast('Error fetching opportunities')}finally{btn.disabled=false;btn.textContent='Fetch Opportunities'}}
function renderSalesforceDeals(){const list=$('salesforceDealsList');if(!salesforceDeals.length){list.innerHTML='<div style="color:var(--muted);text-align:center;padding:1rem">No Closed Won opportunities found in date range</div>';return}let html='<div style="display:flex;flex-direction:column;gap:0.5rem">';salesforceDeals.forEach((d,i)=>{html+=`<label style="display:flex;align-items:center;gap:0.75rem;padding:0.5rem;background:var(--card);border-radius:8px;cursor:pointer"><input type="checkbox" checked data-idx="${i}" class="sf-deal-cb"><div style="flex:1"><div style="font-weight:500">${d.name}</div><div style="font-size:0.8rem;color:var(--muted)">$${d.amount.toLocaleString()} ¬∑ ${d.term}yr ¬∑ ${d.close_date}</div></div></label>`});html+='</div>';list.innerHTML=html}
async function importSalesforceDeals(){const checkboxes=document.querySelectorAll('.sf-deal-cb:checked');if(!checkboxes.length){toast('Select opportunities to import');return}const btn=$('salesforceImportBtn');btn.disabled=true;btn.textContent='Importing...';let imported=0;let firstDealDate=null;for(const cb of checkboxes){const d=salesforceDeals[cb.dataset.idx];const{data,error}=await sb.from('deals').insert({user_id:user.id,comp_plan_id:compPlan.id,name:d.name,amount:d.amount,close_date:d.close_date,term:d.term,paid:false}).select().single();if(!error&&data){deals.push(data);if(!firstDealDate)firstDealDate=d.close_date;imported++}}closeSalesforce();initYear();if(firstDealDate){$('yearSelect').value=getY(firstDealDate);$('quarterSelect').value=getQ(firstDealDate);$('monthFilter').value='all'}render();toast(`Imported ${imported} opportunit${imported!==1?'ies':'y'} from Salesforce`)}
// Check for Salesforce callback on page load
if(window.location.search.includes('salesforce=')){const params=new URLSearchParams(window.location.search);const status=params.get('salesforce');if(status==='connected')setTimeout(()=>toast('Salesforce connected!'),500);else if(status==='error')setTimeout(()=>toast('Salesforce connection failed: '+(params.get('msg')||'unknown error')),500);window.history.replaceState({},'',window.location.pathname)}

async function init(){sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);const{data:{session}}=await sb.auth.getSession();if(session)await loadUser(session.user);sb.auth.onAuthStateChange(async(e,s)=>{if(e==='SIGNED_IN'&&s)await loadUser(s.user)})}
async function loadUser(u){user=u;$('landing').style.display='none';$('app').style.display='block';const{data:profile}=await sb.from('profiles').select('*').eq('id',user.id).single();if(!profile||!profile.onboarded){showOnboarding();return}userProfile=profile;if(profile.role==='sdr'){const{data:plan}=await sb.from('sdr_plans').select('*').eq('user_id',user.id).single();window.sdrPlan=plan;const{data:acts}=await sb.from('sdr_activities').select('*').eq('user_id',user.id);sdrActivities=acts||[];showSDRDashboard()}else{const{data:plans}=await sb.from('comp_plans').select('*').eq('user_id',user.id);if(plans&&plans.length){compPlan=plans[0];compPlan.tiers=JSON.parse(compPlan.tiers);compPlan.rates_1yr=JSON.parse(compPlan.rates_1yr);compPlan.rates_2yr=JSON.parse(compPlan.rates_2yr)}const{data:d}=await sb.from('deals').select('*').eq('user_id',user.id);deals=d||[];const{data:sp}=await sb.from('starting_points').select('*').eq('user_id',user.id);if(sp)sp.forEach(s=>{startingPoints[s.quarter]=s.amount});showDashboard()}}
init();

// Register service worker for PWA
if('serviceWorker' in navigator){navigator.serviceWorker.register('/sw.js').catch(()=>{})}
</script>
</body>
</html>
